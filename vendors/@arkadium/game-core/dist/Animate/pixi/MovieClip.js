"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},__decorate=this&&this.__decorate||function(t,e,r,i){var o,a=arguments.length,n=a<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,r,i);else for(var s=t.length-1;0<=s;s--)(o=t[s])&&(n=(a<3?o(n):3<a?o(e,r,n):o(e,r))||n);return 3<a&&n&&Object.defineProperty(e,r,n),n},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;var i=Array(t),o=0;for(e=0;e<r;e++)for(var a=arguments[e],n=0,s=a.length;n<s;n++,o++)i[o]=a[n];return i};Object.defineProperty(exports,"__esModule",{value:!0});var MovieClipContainer_1=require("../factories/MovieClipContainer"),Linq_1=require("../../Linq/Linq"),GamePerformance_1=require("../../GamePerformance"),MovieClip=function(p){function g(t,e,r,i,o,a){var n=p.call(this,t)||this;if(e="number"==typeof(e=void 0===e?{}:e)?{mode:e||g.INDEPENDENT,duration:r||0,loop:void 0===i||i,labels:a||{},framerate:o||0,startPosition:0}:__assign({mode:g.INDEPENDENT,startPosition:0,loop:!0,labels:{},duration:0,framerate:0},e),n.mode=e.mode,n.startPosition=e.startPosition,n.loop=!!e.loop,n.currentFrame=0,n._labels=[],n._labelDict=e.labels,e.labels){for(var s in e.labels){var l={label:s,position:e.labels[s]};n._labels.push(l)}n._labels.sort(function(t,e){return t.position-e.position})}return n.selfAdvance=!0,n.paused=!1,n.actionsEnabled=!0,n.autoReset=!0,n._synchOffset=0,n._prevPos=-1,n._t=0,n._framerate=e.framerate,n._duration=0,n._totalFrames=e.duration,n._timelines=[],n._timedChildTimelines=[],n._depthSorted=[],n._actions=[],n._beforeUpdate=null,e.framerate&&(n.framerate=e.framerate),n.framerate=24,n.___updateTimeline=0,n.___setTimelinePosition=0,n.___goto=0,n.___advance=0,n}return __extends(g,p),g.prototype.update=function(t){if(this.visible){if(this.paused||!this.selfAdvance)return this._prevPos<0&&this._goto(this.currentFrame),void p.prototype.update.call(this,t);var e=t;p.prototype.update.call(this,t),this.advance(e)}},Object.defineProperty(g.prototype,"labels",{get:function(){return this._labels},enumerable:!0,configurable:!0}),Object.defineProperty(g.prototype,"labelsMap",{get:function(){return this._labelDict},enumerable:!0,configurable:!0}),Object.defineProperty(g.prototype,"timelines",{set:function(t){this._timelines=t},enumerable:!0,configurable:!0}),Object.defineProperty(g.prototype,"timedChildTimelines",{set:function(t){this._timedChildTimelines=t},enumerable:!0,configurable:!0}),Object.defineProperty(g.prototype,"currentLabel",{get:function(){for(var t=this._labels,e=null,r=0,i=t.length;r<i&&t[r].position<=this.currentFrame;++r)e=t[r].label;return e},enumerable:!0,configurable:!0}),Object.defineProperty(g.prototype,"elapsedTime",{get:function(){return this._t},set:function(t){this._t=t},enumerable:!0,configurable:!0}),Object.defineProperty(g.prototype,"framerate",{get:function(){return this._framerate},set:function(t){0<t?(this._framerate=t,this._duration=t?this._totalFrames/t:0,this._t=this.currentFrame/t):this._t=this._framerate=this._duration=0},enumerable:!0,configurable:!0}),Object.defineProperty(g.prototype,"totalFrames",{get:function(){return this._totalFrames},enumerable:!0,configurable:!0}),g.prototype.addAction=function(t,e){if("string"==typeof e){var r=this._labelDict[e];if(void 0===r)throw"The label '"+e+"' does not exist on this timeline";e=r}var i=this._actions;return i.length<=e&&(i.length=e+1),this._totalFrames<e&&(this._totalFrames=e),i[e]?i[e].push(t):i[e]=[t],this},g.prototype.removeAction=function(t,e){var r=this._actions;if(r[e])for(var i=0;i<r[e].length;i++)r[e][i]==t&&r[e].splice(i,1)},g.prototype.playSound=function(t,e){return void 0===e&&(e=!1),this},g.prototype.play=function(){this.paused=!1},g.prototype.stop=function(t){void 0===t&&(t=!0),this.paused=!0,t&&this._stopAll(this)},g.prototype._stopAll=function(t){if(t.___children&&t.___children.length)for(var e=t.___children,r=0;r<e.length;r++){var i=e[r];i.stop&&(i.stop(),this._stopAll(i))}},g.prototype.dispatchEvent=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];this.triggerEvent.apply(this,__spreadArrays(["dispatchEvent",t],e))},g.prototype.onDispatchEvent=function(t){this.triggerEvent("dispatchEvent",t)},g.prototype.gotoAndPlayAll=function(t,e){var r=this._labelDict[t]||t;e||this.gotoAndPlay(t),this._gotoAndPlayAllChildren(r,this,e)},g.prototype.gotoAndStopAll=function(t){var e=this._labelDict[t]||t;this.gotoAndStop(t),this._gotoAndStopAllChildren(e,this)},g.prototype.parseMovieClipScripts=function(){for(var i=this,o=this.___scripts||[],t=function(e){var t=null;try{var r=new Function("",o[e].script);t=function(){try{r.apply(i,[])}catch(t){console.error("error run script on frame "+o[e].frame,o[e].script),console.error(t)}}}catch(t){console.error("error eval script on frame "+o[e].frame,o[e].script),console.error(t)}t&&a.addAction(t,o[e].frame)},a=this,e=0;e<o.length;e++)t(e)},g.prototype.gotoAndPlay=function(t){this.paused=!1,this._goto(t)},g.prototype.gotoAndStop=function(t){this.paused=!0,this._goto(t)},Object.defineProperty(g.prototype,"parentFramerate",{get:function(){for(var t=this,e=t._framerate;(t=t.parent)&&!e;)t.mode===g.INDEPENDENT&&(e=t._framerate);return e||g.DEFAULT_FRAMERATE},enumerable:!0,configurable:!0}),g.prototype.advance=function(t){var e;this._framerate||(this.framerate=this.parentFramerate),t&&(this._t+=t),this._t>this._duration&&(this._t=this.loop?this._t-this._duration:this._duration),this.currentFrame=Math.floor(this._t*this._framerate+1e-8),this.currentFrame>=this._totalFrames&&(this.currentFrame=this._totalFrames-1),this._beforeUpdate&&(e=this._beforeUpdate(this)),this._updateTimeline(),e&&e()},g.prototype._goto=function(t){var e="string"==typeof t?this._labelDict[t]:t;void 0!==e&&(this._prevPos=NaN,this.currentFrame=e,this._framerate||(this.framerate=this.parentFramerate),0<this._framerate?this._t=e/this._framerate:this._t=0,this._updateTimeline())},g.prototype._reset=function(){this._prevPos=-1,this._t=0,this.currentFrame=0},g.prototype._updateTimeline=function(){var t=this.mode!==g.INDEPENDENT;t&&(this.currentFrame=this.startPosition+(this.mode===g.SINGLE_FRAME?0:this._synchOffset),this.currentFrame>=this._totalFrames&&(this.currentFrame%=this._totalFrames)),this._prevPos!==this.currentFrame&&(this._setTimelinePosition(this._prevPos,this.currentFrame,!t&&this.actionsEnabled),this._prevPos=this.currentFrame)},g.prototype._setTimelinePosition=function(t,e,r){var i,o,a,n=this._timelines;for(i=n.length-1;0<=i;--i){var s=n[i];for(o=0,a=s.length;o<a;++o){var l=s[o];if(e>=l.startFrame&&e<=l.endFrame){var p=this.___children[s.targetIndex];l.setPosition(p,e);break}}}for(var _=0;_<this.___children.length;_++){this.___children[_].mask=null}var h=this._timedChildTimelines,c=this._depthSorted;for(i=0,a=h.length;i<a;++i){p=this.___children[h[i].targetIndex];var d=h[i][e];d?p.parent!==this&&c.push(p):d||p.parent!==this||(this.removeChild(p),p.mask=null,this._removeChildrenMask(p))}this.renderOrderedItems(c),c.length=0;var m,u=this.children;for(i=0,a=u.length;i<a;++i)(m=u[i]).mode===g.SYNCHED&&(m._synchOffset=e-m.parentStartPosition,m._updateTimeline());if(r){var f=this._actions,y=!1;for(e<t?(a=f.length,y=!0):a=Math.min(e+1,f.length),i=0<=t?t+1:e;i<a;++i){if(f[i]){var v=f[i];for(o=0;o<v.length;++o)v[o].call(this)}y&&i===a-1&&(i=0,a=e+1,y=!1)}}},g.prototype.destroy=function(t){if(!this.__destroyed){this.__destroyed=!0;for(var e=0;e<this.___children.length;e++)this.___children[e].destroy({children:!0});this._actions=null,this._timelines=null,this._depthSorted=null,this._timedChildTimelines=null,this._beforeUpdate=null,this._labels=null,this._labelDict=null,p.prototype.destroy.call(this,{children:!0})}},g.INDEPENDENT=0,g.SINGLE_FRAME=1,g.SYNCHED=2,g.DEFAULT_FRAMERATE=24,g.extend=function(t){return t.prototype=Object.create(g.prototype),t.prototype.__parent=g.prototype,t.prototype.constructor=t},__decorate([GamePerformance_1.GamePerformanceMethod("MovieClip","_stopAll"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],g.prototype,"_stopAll",null),__decorate([GamePerformance_1.GamePerformanceMethod("MovieClip","dispatchEvent"),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Object]),__metadata("design:returntype",void 0)],g.prototype,"dispatchEvent",null),__decorate([GamePerformance_1.GamePerformanceMethod("MovieClip","onDispatchEvent"),__metadata("design:type",Function),__metadata("design:paramtypes",[String]),__metadata("design:returntype",void 0)],g.prototype,"onDispatchEvent",null),__decorate([GamePerformance_1.GamePerformanceMethod("MovieClip","gotoAndPlayAll"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Linq_1.List]),__metadata("design:returntype",void 0)],g.prototype,"gotoAndPlayAll",null),__decorate([GamePerformance_1.GamePerformanceMethod("MovieClip","gotoAndStopAll"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],g.prototype,"gotoAndStopAll",null),__decorate([GamePerformance_1.GamePerformanceMethod("MovieClip","parseMovieClipScripts"),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],g.prototype,"parseMovieClipScripts",null),__decorate([GamePerformance_1.GamePerformanceMethod("MovieClip","gotoAndPlay"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],g.prototype,"gotoAndPlay",null),__decorate([GamePerformance_1.GamePerformanceMethod("MovieClip","gotoAndStop"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],g.prototype,"gotoAndStop",null),__decorate([GamePerformance_1.GamePerformanceMethod("MovieClip","_setTimelinePosition"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object,Object,Object]),__metadata("design:returntype",void 0)],g.prototype,"_setTimelinePosition",null),g}(MovieClipContainer_1.MovieClipContainer);exports.MovieClip=MovieClip;