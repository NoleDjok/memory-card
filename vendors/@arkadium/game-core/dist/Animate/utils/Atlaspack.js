"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Atlas=function(){function c(t,e,i,h){this.Padding=2,1===arguments.length&&(this.canvas=t,t=e=0,i=this.canvas.width,h=this.canvas.height),2===arguments.length&&(i=t,h=e,t=e=0),this.left=this.right=null,this.rect=new Rect(t,e,i,h),this.filled=!1,this.tilepad=!1,this._cache=[],this._uvcache=Object.create(null)}return c.prototype.pack=function(t){return this._cache=[],this._uvcache=Object.create(null),t=this._toRect(t),this.img&&this.tilepad&&(t=this._tilepad(t)),null!==this.left?this._ontoCanvas(this.left.pack(t)||this.right.pack(t)):!(this.filled||!t.fitsIn(this.rect))&&(t.sameSizeAs(this.rect)?(this.filled=!0,this._ontoCanvas(this)):(this.rect.w-t.w>this.rect.h-t.h?(this.left=new c(this.rect.x,this.rect.y,t.w,this.rect.h),this.right=new c(this.rect.x+t.w+this.Padding,this.rect.y,this.rect.w-t.w-this.Padding,this.rect.h)):(this.left=new c(this.rect.x,this.rect.y,this.rect.w,t.h),this.right=new c(this.rect.x,this.rect.y+t.h+this.Padding,this.rect.w,this.rect.h-t.h-this.Padding)),this._ontoCanvas(this.left.pack(t))))},c.prototype.expand=function(t){var e,i=this;if(t=this._toRect(t),this.img&&this.tilepad&&(t=this._tilepad(t)),this.rect.w<this.rect.h?(e=new c(0,0,this.rect.w+t.w,this.rect.h)).right=new c(this.rect.w,0,t.w,this.rect.h):(e=new c(0,0,this.rect.w,this.rect.h+t.h)).right=new c(0,this.rect.h,this.rect.w,t.h),e.left=this,["canvas","context","img"].forEach(function(t){i[t]&&(e[t]=i[t],i[t]=null)}),e.canvas){e.context||(e.context=e.canvas.getContext("2d"));var h=e.context.getImageData(0,0,e.canvas.width,e.canvas.height);e.canvas.width=e.rect.w,e.canvas.height=e.rect.h,e.context.putImageData(h,0,0)}return!1===e.pack(t)?e.expand(t):e},c.prototype.index=function(){var i=this;return 0<i._cache.length||function t(e){null!==e.left?(t(e.left),t(e.right)):e.rect.name&&i._cache.push(e.rect)}(i),i._cache},c.prototype.uv=function(h,c){var r=this;h=h||r.rect.w,c=c||r.rect.h;var n=this.tilepad;return function t(e){if(null!==e.left)t(e.left),t(e.right);else if(void 0!==e.rect.name){var i=n?e.rect.w/4:0;r._uvcache[e.rect.name]=[[e.rect.x+i,e.rect.y+i],[e.rect.x+i+(e.rect.w-2*i),e.rect.y+i],[e.rect.x+i+(e.rect.w-2*i),e.rect.y+i+(e.rect.h-2*i)],[e.rect.x+i,e.rect.y+i+(e.rect.h-2*i)]].map(function(t){return 0!==t[0]&&(t[0]=t[0]/h),0!==t[1]&&(t[1]=t[1]/c),t})}}(r),r._uvcache},c.prototype.json=function(t){return t?("string"==typeof t&&(t=JSON.parse(t)),function t(e){if(e&&e.rect){var i=new c(e.rect.x,e.rect.y,e.rect.w,e.rect.h);return e.left&&(i.left=t(e.left)),e.right&&(i.right=t(e.right)),i}}(t)):JSON.stringify(function t(e){var i={left:null,right:null,rect:e.rect,filled:e.filled};return null!==e.left&&(i.left=t(e.left),i.right=t(e.right)),i}(this),null,2)},c.prototype._tilepad=function(t){var e=this.img;if(!e)return t;var i=e.width/2,h=document.createElement("canvas");h.name=e.name||e.src,h.id=e.id||"",h.width=e.width+e.width,h.height=e.height+e.height;var c=h.getContext("2d"),r=c.createPattern(e,"repeat");return c.fillStyle=r,c.translate(i,i),c.fillRect(-i,-i,h.width+i,h.height+i),c.translate(-i,-i),this.img=h,new Rect(t.x,t.y,this.img.width,this.img.height)},c.prototype._ontoCanvas=function(t){return t&&this.img&&this.canvas&&(this.context||(this.context=this.canvas.getContext("2d")),this.context.clearRect(t.rect.x,t.rect.y,t.rect.w,t.rect.h),this.context.drawImage(this.img,t.rect.x,t.rect.y,t.rect.w,t.rect.h),t.rect.name=this.img.id||this.img.name||this.img.src||null),t},c.prototype._toRect=function(t){return!t.nodeName||"IMG"!==t.nodeName&&"CANVAS"!==t.nodeName||(this.img=t,t=new Rect(t.x,t.y,t.width,t.height)),t instanceof Rect||(t=new Rect(t.x||0,t.y||0,t.w||t.width,t.h||t.height)),t},c}();exports.Atlas=Atlas;var Rect=function(){function t(t,e,i,h){this.x=t,this.y=e,this.w=i,this.h=h}return t.prototype.fitsIn=function(t){return t.w>=this.w&&t.h>=this.h},t.prototype.sameSizeAs=function(t){return this.w===t.w&&this.h===t.h},t}();