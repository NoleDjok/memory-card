"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var CommandFactory_1=require("../commands/CommandFactory"),Frame_1=require("./Frame"),DataUtils_1=require("../utils/DataUtils"),MovieClipFactory_1=require("../factories/MovieClipFactory"),EventEmitter=function(){function t(){this.events={}}return t.prototype.on=function(t,e){var r=this;return"object"!=typeof this.events[t]&&(this.events[t]=[]),this.events[t].push(e),function(){return r.removeListener(t,e)}},t.prototype.removeListener=function(t,e){if("object"==typeof this.events[t]){var r=this.events[t].indexOf(e);-1<r&&this.events[t].splice(r,1)}},t.prototype.emit=function(t){for(var e=this,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];"object"==typeof this.events[t]&&this.events[t].forEach(function(t){return t.apply(e,r)})},t.prototype.once=function(t,r){var n=this,i=this.on(t,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];i(),r.apply(n,t)})},t}(),Instance=function(n){function t(t,e){var r=n.call(this)||this;return r.id=e,r.localName="instance"+e,r.instanceName=null,r.startFrame=0,r.endFrame=-1,r.libraryItem=t,r.initFrame=null,r.placeAfter=0,r.frames={},r.loop=!1,r.renderable=!0,r.isAnimated=!1,r}return __extends(t,n),t.prototype.addToFrame=function(t,e){"Place"==(e=CommandFactory_1.CommandFactory.create(e)).type?(this.loop=!!e.loop,this.startFrame=t,!this.instanceName&&e.instanceName&&(this.instanceName=e.instanceName),this.placeAfter=e.placeAfter):"Remove"==e.type?this.endFrame=t:"Mask"==e.type&&(this.maskTill=e.maskTill);var r=this.frames[t];r||(r=this.frames[t]=new Frame_1.Frame),r.addCommand(e),Object.keys(r).length?this.initFrame||(this.initFrame=r):delete this.frames[t],1<Object.keys(this.frames).length&&(this.isAnimated=!0)},t.prototype.getDuration=function(t){return 0<this.endFrame?this.endFrame-this.startFrame:t-this.startFrame},t.prototype.getFrames=function(){var o,c=this;if(!this.isAnimated)return null;var l=Frame_1.Frame.DEFAULT_VALUES,u=Object.keys(l),h=[],t=function(t){var e=f.frames[t],r=Object.assign({},l,e.toJSON());if(!o)return(o=e).validKeys.forEach(function(t){c.equals(l[t],e[t])||h.push(t)}),l=r,"continue";for(var n=0,i=u.length;n<i;n++){var a=u[n];f.equals(l[a],e[a])&&(e[a]=null)}var s=e.validKeys;if(s.length)for(n=0;n<s.length;n++){a=s[n];-1==h.indexOf(a)&&h.push(a)}else delete f.frames[t];l=r},f=this;for(var e in this.frames)t(e);return o.clean(h),o.hasValues?(DataUtils_1.DataUtils.optimizeColorTransforms(this.frames),this.frames):null},t.prototype.equals=function(t,e){if(t===e)return!0;if(null===t||null===e)return!1;if(!Array.isArray(t))return t===e;for(var r=0;r<t.length;r++)if(!this.equals(t[r],e[r]))return!1;return!0},t.prototype.buildContent=function(t,e,r){throw void 0===e&&(e=!1),"Must override"},t.prototype.render=function(t){var e=new MovieClipFactory_1.MovieClipChildFactory(this,t);t._children[this.localName]=e,!this.isAnimated&&this.initFrame&&this.initFrame.render(e)},t}(EventEmitter);exports.Instance=Instance;