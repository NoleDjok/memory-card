"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}(),__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},__decorate=this&&this.__decorate||function(e,t,i,n){var r,a=arguments.length,s=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;0<=o;o--)(r=e[o])&&(s=(a<3?r(s):3<a?r(t,i,s):r(t,i))||s);return 3<a&&s&&Object.defineProperty(t,i,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var AnimateFactoryTypeEnum,MovieClip_1=require("../pixi/MovieClip"),MovieClipContainer_1=require("./MovieClipContainer"),GamePerformance_1=require("../../GamePerformance"),Timeline_1=require("../pixi/Timeline"),utils_1=require("../pixi/utils");!function(e){e[e.Container=0]="Container",e[e.MovieClip=1]="MovieClip",e[e.BaseFactory=2]="BaseFactory"}(AnimateFactoryTypeEnum=exports.AnimateFactoryTypeEnum||(exports.AnimateFactoryTypeEnum={}));var MovieClipBaseFactory=function(){function e(){this.type=AnimateFactoryTypeEnum.BaseFactory,this._children={},this._frames=[],this._scripts=[]}return e.prototype.getInstance=function(e){return null},e.prototype.reset=function(){for(var e in this._children){this._children[e].reset()}},e}();exports.MovieClipBaseFactory=MovieClipBaseFactory;var MovieClipChildFactory=function(){function e(e,t){this._instance=e,this._factory=t}return e.prototype.getInstance=function(e){if(!this.instance){var t=!1;this._instance.maskTill&&(t=!0),this.instance=this._instance.buildContent(this._factory,t,e),this.instance._instanceId=this._instance.id,this.instance._maskTill=this._instance.maskTill,this.instance._placeAfter=this._instance.placeAfter,this._instance.maskTill&&(this.instance.renderable=!1),this._instance.instanceName&&(this.instance.name=this._instance.instanceName),this.setTransform&&this.setTransform(),this.setRenderable&&this.setRenderable(),this.setMask&&this.setMask(),this.setAlpha&&this.setAlpha(),this.setTint&&this.setTint(),this.setColorTransform&&this.setColorTransform()}return this.instance},e.prototype.reset=function(){this.instance=null},__decorate([GamePerformance_1.GamePerformanceMethod("MovieClipChildFactory","getInstance"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],e.prototype,"getInstance",null),e}();exports.MovieClipChildFactory=MovieClipChildFactory;var MovieClipFactory=function(r){function e(e,t,i){var n=r.call(this)||this;return n._options=e,n.animate=t,n.name=i,n._totalFrames=0,n._timelines=[],n._timedChildTimelines=[],n._timelineReady=!1,n.type=AnimateFactoryTypeEnum.MovieClip,n}return __extends(e,r),e.prototype._getChildTimeline=function(e){for(var t=this._timelines.length-1;0<=t;--t)if(this._timelines[t].targetIndex===e)return this._timelines[t];var i=new Timeline_1.Timeline(e);return this._timelines.push(i),i},e.prototype._autoExtend=function(e){this._totalFrames<e&&(this._totalFrames=e)},e.prototype._parseProperties=function(e){"string"==typeof e.t?e.t=utils_1.default.hexToUint(e.t):"number"==typeof e.v&&(e.v=!!e.v)},e.prototype.addTimedChild=function(e,t,i,n){var r,a;for(void 0===t&&(t=0),(void 0===i||i<1)&&(i=this._totalFrames||1),a=this._timedChildTimelines.length-1;0<=a;--a)if(this._timedChildTimelines[a].targetIndex===e){r=this._timedChildTimelines[a];break}if(r||(r=new Timeline_1.ChildTimeline(e),this._timedChildTimelines.push(r)),utils_1.default.fillFrames(r,t,i),this._totalFrames<t+i&&(this._totalFrames=t+i),n){var s={};for(var o in n){s=__assign(__assign({},s),n[o]);var c=parseInt(o,10),l=this._getChildTimeline(e);this._parseProperties(s);l.addKeyframe(s,c);this._autoExtend(c)}this._getChildTimeline(e).extendLastFrame(t+i)}return this},e.prototype.getInstance=function(e){var t=__assign(__assign({},this._options),e||{}),i=new MovieClip_1.MovieClip(this.name,t);for(var n in i.name=this.name,i.___children=[],this._children){(_=this._children[n]).reset&&_.reset()}for(var r=function(e){for(var t=0;t<i.___children.length;t++)if(i.___children[t]==e)return t},a=0;a<this._frames.length;a++){var s=this._frames[a];switch(s.func){case"addTimedChild":for(var o=this._children[s.instance].getInstance(),c=!1,l=0;l<i.___children.length;l++){var _;if((_=i.___children[l])==o){c=!0;break}}if(c||i.___children.push(o),this._totalFrames=i.totalFrames,!this._timelineReady){var h=r(o),p={};for(var n in s.frames){for(var m=s.frames[n],d={},f=m.validKeys,u=0;u<f.length;u++){var y=f[u];d[y]=m[y]}p[n]=d}this.addTimedChild(h,s.startFrame,s.duration,p)}}}this._timelineReady=!0,i.timelines=this._timelines,i.timedChildTimelines=this._timedChildTimelines,i.___scripts=[];for(a=0;a<this._scripts.length;a++)i.___scripts.push({script:this._scripts[a].script,frame:this._scripts[a].frame});if(0==this._frames.length)for(var n in this._children){o=this._children[n].getInstance();i.addChild(o),i.___children.push(o)}return i.parseMovieClipScripts(),i._setTimelinePosition(0,i.currentFrame,!0),i},__decorate([GamePerformance_1.GamePerformanceMethod("MovieClipFactory","getInstance"),__metadata("design:type",Function),__metadata("design:paramtypes",[Object]),__metadata("design:returntype",void 0)],e.prototype,"getInstance",null),e}(MovieClipBaseFactory);exports.MovieClipFactory=MovieClipFactory;var MovieClipContainerFactory=function(r){function e(e,t,i){var n=r.call(this)||this;return n._options=e,n.animate=t,n.name=i,n.type=AnimateFactoryTypeEnum.Container,n}return __extends(e,r),e.prototype.getInstance=function(e){var t=new MovieClipContainer_1.MovieClipContainer(this.name);t.name=this.name,t.___children=[];var i=[];for(var n in this._children){var r=this._children[n];r.reset();var a=r.getInstance(e);t.___children.push(a),i.push(a)}return t.renderOrderedItems(i),t},e}(MovieClipBaseFactory);exports.MovieClipContainerFactory=MovieClipContainerFactory;