"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __decorate=this&&this.__decorate||function(e,r,t,a){var o,s=arguments.length,n=s<3?r:null===a?a=Object.getOwnPropertyDescriptor(r,t):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,r,t,a);else for(var i=e.length-1;0<=i;i--)(o=e[i])&&(n=(s<3?o(n):3<s?o(r,t,n):o(r,t))||n);return 3<s&&n&&Object.defineProperty(r,t,n),n},__metadata=this&&this.__metadata||function(e,r){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,r)};Object.defineProperty(exports,"__esModule",{value:!0});var Queue_1=require("../Queue/Queue"),IArenaApi_1=require("../Arena/IArenaApi"),typescript_ioc_1=require("../../IoC/typescript-ioc"),ResourceItem_1=require("./ResourceItem"),Linq_1=require("../../Linq/Linq"),PixiFactory_1=require("../../dragonBones/pixi4/PixiFactory"),FontLoader_1=require("./FontLoader"),PixiAnimateLoader_1=require("../../Animate/PixiAnimateLoader"),GameResources_1=require("../../GameResources"),ViewBaseEmptyLogger_1=require("../ViewBaseEmptyLogger"),GamePerformance_1=require("../../GamePerformance"),ResourcesLoader=function(){function e(){this._queue=new Queue_1.Queue,this._clock=0,this._loadingCount=0,this._progress=0,this._loadingCall=0,this._currentProgress=0}var R;return(R=e).prototype.setGameBase=function(e){this._gameBase=e},e.prototype._getUrl=function(e){if(e.startsWith("//")||e.startsWith("http://")||e.startsWith("https://"))return e;var r=this._arenaApi.absoluteURL("")+this._gameResources.root;return r.endsWith("/")&&e.startsWith("/")?r=r.substring(0,r.length-1):r.endsWith("/")||e.startsWith("/")||(r+="/"),r+e.replace("%RESOURCES_SCALE%","2")},e.prototype.update=function(e){if(this._queue.update(e),0<this._queue.length&&.1<this._queue.clock-this._clock){this._clock=this._queue.clock,this._progress=(this._loadingCount-(this._queue.length-this._loadingCall))/this._loadingCount;var r=(R.loader.progress<100?.9*(1-this._progress)*R.loader.progress:0)/100,t=1-(1-this._progress);t=(t=.9<t?.9:t)<.3?.3:t;var a=1-(this._progress+r),o=a*t-a*t/(2*this._clock),s=Math.round(100*(this._progress+r+o))/100;this._currentProgress!=s&&(this._currentProgress=s,this._gameBase.setLoading(this._currentProgress<0?0:this._currentProgress))}},e.prototype.load=function(y,r,t){var L=this,x=!1,v=new Linq_1.List(r);if(R.loading)return this._loadingCall++,void this._queue.push({condition:function(e){return!0},action:function(e){L._loadingCall--,L.load(y,r,t)}});v.ForEach(function(m,e){if(!m.loaded&&!m.requested){var t=!1;if(m.type==ResourceItem_1.ResourceItemType.dragonBonesProject){var _=new Linq_1.List(m.resources);_.ForEach(function(e,r){R.loader.resources[m.name+e.name]||(t=!0,R.loader.add(m.name+e.name,L._getUrl(e.resources)))}),m.complete=function(e,r){if(L._logger.log(y,"LoadCompleted",m.name,_.Select(function(e){return e.resources}).ToArray()),r[m.name+"ske"].data){var t=r[m.name+"ske"].data;if(L._gameResources.options.armaturesPrivateScope&&!t.ready){var a=r[m.name+"tex"].data;a.name=m.name+"."+a.name,t.name=m.name+"."+t.name,t.ready=!0;for(var o=0;o<t.armature.length;o++){var s=t.armature[o];if(s.name=m.name+"."+s.name,s.skin)for(var n=0;n<s.skin.length;n++){var i=s.skin[n];if(i.slot)for(var u=0;u<i.slot.length;u++)for(var d=i.slot[u],c=0;c<d.display.length;c++){var l=d.display[c];"armature"==l.type&&(l.name=m.name+"."+l.name)}}}}m.dragonBonesData=PixiFactory_1.PixiFactory.factory.parseDragonBonesData(r[m.name+"ske"].data)}r[m.name+"tex"].data&&r[m.name+"png"].texture&&(m.dragonBonesTexturesData=PixiFactory_1.PixiFactory.factory.parseTextureAtlasData(r[m.name+"tex"].data,r[m.name+"png"].texture))}}else if(m.type==ResourceItem_1.ResourceItemType.threeJsTexture){t=!0;var r=new THREE.TextureLoader;r.crossOrigin="",r.load(L._getUrl(m.resources),function(e){L._logger.log(y,"LoadCompleted",m.name,m.resources),m.threeTexture=e,m.loaded=!0})}else if(m.type==ResourceItem_1.ResourceItemType.font)t=!0,FontLoader_1.FontLoader(m.resources,function(){L._logger.log(y,"LoadCompleted",m.name,m.resources),m.loaded=!0},{timeoutAfter:5e3,onTimeout:function(){L._logger.log(y,"LoadCompleted",m.name,m.resources),m.loaded=!0}});else if(m.type==ResourceItem_1.ResourceItemType.threeJsCubeTexture){t=!0;var a=new THREE.CubeTextureLoader;a.crossOrigin="";for(var o=[],s=0;s<m.resources.length;s++)o.push(L._getUrl(m.resources[s]));a.load(o,function(e){L._logger.log(y,"LoadCompleted",m.name,o),m.threeCubeTexture=e,m.loaded=!0})}else if(m.type==ResourceItem_1.ResourceItemType.pixiTexture)if(R.loader.resources[m.name]){var n=v.FirstOrDefault(function(e){return e.name==m.name});n&&n!=m?m.complete=function(){R.loader.resources[m.name]&&(m.pixiTexture=R.loader.resources[m.name].texture),m.loaded=!0,L._logger.log(y,"LoadCompleted",m.name,m.resources)}:(R.loader.resources[m.name]&&(m.pixiTexture=R.loader.resources[m.name].texture),m.loaded=!0,L._logger.log(y,"LoadCompleted",m.name,m.resources))}else x=!0,R.loader.add(m.name,L._getUrl(m.resources)),m.complete=function(){R.loader.resources[m.name]&&(m.pixiTexture=R.loader.resources[m.name].texture),m.loaded=!0,L._logger.log(y,"LoadCompleted",m.name,m.resources)};else if(m.type==ResourceItem_1.ResourceItemType.pixiAnimate){if(!m.resources.factory){var i=new PixiAnimateLoader_1.PixiAnimateLoader(m.resources);(m.resources.factory=i).build();for(var u=!1,d=i.animate.__spritesheets,c=0;c<d.length;c++){var l=d[c];R.loader.resources[l.data.meta.image]||(u=t=x=!0,R.loader.add(l.data.meta.image,L._getUrl(l.data.meta.image)))}if(!u){var g=i.animate.__assets||{};if(g&&Object.keys(g).length)for(var p in g)if(!R.loader.resources[p]){u=t=x=!0;R.loader.add(p,L._getUrl(g[p]),null)}}var h=i.animate.__shapesheets;for(c=0;c<h.length;c++){var f=h[c];R.loader.resources[f.data.meta.image]||(u=t=x=!0,R.loader.add(f.data.meta.image,L._getUrl(f.data.meta.image)))}u&&(m.complete=function(e,r){m.loaded=!0;for(var t=0;t<d.length;t++){var a=d[t];if(r[a.data.meta.image]){var o=r[a.data.meta.image].texture.baseTexture;a.spritesheet=new PIXI.Spritesheet(o,a.data),a.spritesheet.parse(function(){})}}for(t=0;t<h.length;t++){var s=h[t];if(r[s.data.meta.image]){o=r[s.data.meta.image].texture.baseTexture;s.spritesheet=new PIXI.Spritesheet(o,s.data),s.spritesheet.parse(function(){})}}L._logger.log(y,"LoadCompleted",m.name,m.name)})}}else"string"==typeof m.resources&&(t=!0,m.temporary=!0,R.loader.resources[m.name]?m.loaded=!0:(x=!0,R.loader.add(m.name,L._getUrl(m.resources)),m.complete=function(){m.loaded=!0,L._logger.log(y,"LoadCompleted",m.name,m.resources)}));x=t||x,t&&(m.requested=!0,L._queue.push({condition:function(e){return m.loaded||0<R.errors.indexOf(m.name)},action:function(e){}}))}}),x?(R.loading=!0,this._gameBase.showLoading(!0),this._currentProgress=0,this._gameBase.setLoading(0),this._queue.push({condition:function(e){return!0},action:function(e){L._gameBase.setLoading(1)}}),this._queue.push({condition:function(e){return.05<e&&!R.loader.loading},action:function(e){R.loading=!1,L._gameBase.showLoading(!1),t()}}),this._clock=0,this._loadingCount=this._queue.length-this._loadingCall,R.loader.once("complete",function(t,a){v.ForEach(function(e,r){e.complete&&!e.loaded&&(e.complete(t,a),e.loaded=!0)})},this),R.loader.once("error",function(e,r,t){L._logger.log("ResourcesLoader","LoadError",e.name,e.message),R.errors.indexOf(t.name)<0&&R.errors.push(t.name)},this),R.loader.load()):t()},e.loading=!1,e.errors=[],e.loader=new PIXI.loaders.Loader,__decorate([typescript_ioc_1.Inject,__metadata("design:type",GameResources_1.GameResources)],e.prototype,"_gameResources",void 0),__decorate([typescript_ioc_1.Inject,__metadata("design:type",IArenaApi_1.IArenaApi)],e.prototype,"_arenaApi",void 0),__decorate([typescript_ioc_1.Inject,__metadata("design:type",ViewBaseEmptyLogger_1.ViewBaseEmptyLogger)],e.prototype,"_logger",void 0),__decorate([GamePerformance_1.GamePerformanceMethod("ResourcesLoader","Load resources"),__metadata("design:type",Function),__metadata("design:paramtypes",[String,Array,Function]),__metadata("design:returntype",void 0)],e.prototype,"load",null),e=R=__decorate([typescript_ioc_1.Singleton,__metadata("design:paramtypes",[])],e)}();exports.ResourcesLoader=ResourcesLoader;