"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __decorate=this&&this.__decorate||function(t,e,o,n){var a,r=arguments.length,i=r<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(t,e,o,n);else for(var d=t.length-1;0<=d;d--)(a=t[d])&&(i=(r<3?a(i):3<r?a(e,o,i):a(e,o))||i);return 3<r&&i&&Object.defineProperty(e,o,i),i},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};Object.defineProperty(exports,"__esModule",{value:!0});var SoundController_1=require("./SoundController"),typescript_ioc_1=require("../../IoC/typescript-ioc"),ISoundManager_1=require("./ISoundManager"),SoundData_1=require("./SoundData"),StorageManager_1=require("../Storage/StorageManager"),ViewBaseEmptyLogger_1=require("../ViewBaseEmptyLogger"),SoundManager=function(){function t(){this._soundStorageKey="sound-settings",this._sounds=[],this._soundController=new SoundController_1.SoundController,this._storageManager=typescript_ioc_1.Container.get(StorageManager_1.StorageManager),this.subscribe()}return Object.defineProperty(t.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"musicOn",{get:function(){return this._data.musicOn},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"soundOn",{get:function(){return this._data.soundOn},enumerable:!0,configurable:!0}),t.prototype.setMasterVolume=function(t){this._soundController.setMasterVolume(t)},t.prototype.getMasterVolume=function(){return this._soundController.getMasterVolume()},t.prototype.reload=function(t,e){if(this.isAdded(t)){var o=this.getSoundById(t);o.item.unload(),o.item=this._soundController.load(e),o.item.load()}else this._sounds.push({id:t,item:this._soundController.load(e),type:0,delay:1e3});this._soundController.updateMasterVolume()},t.prototype.play=function(t,e,o){var n=this.getSoundById(t);n&&(n.type==ISoundManager_1.SoundType.Music&&this._data.musicOn?(n.item.loop(e),n.item.play()):n.type==ISoundManager_1.SoundType.SFX&&this._data.soundOn&&(n.item.loop(e),n.item.play()))},t.prototype.playSound=function(t,e,o){void 0===e&&(e=0);var n=this.getSoundById(t);n&&n.type==ISoundManager_1.SoundType.SFX&&this._data.soundOn&&n.delay>=e&&(n.delay=0,n.item.loop(!1),n.item.play())},t.prototype.stop=function(t){var e=this.getSoundById(t);e&&e.item.stop()},t.prototype.changeVolume=function(t,e){var o=this.getSoundById(t);o&&o.item.volume(e)},t.prototype.stopAll=function(){for(var t=0,e=this._sounds;t<e.length;t++){var o=e[t];o.item.loop(!1),o.item.stop()}},t.prototype.muteSoundsByType=function(t,e){switch(e){case ISoundManager_1.SoundType.ALL:this._data.soundOn=!t,this._data.musicOn=!t;break;case ISoundManager_1.SoundType.SFX:this._data.soundOn=!t;break;case ISoundManager_1.SoundType.Music:this._data.musicOn=!t}this.saveData(),this.muteSoundsByTypeInternal(t,e)},t.prototype.muteSoundsByTypeInternal=function(t,e){for(var o=0,n=e==ISoundManager_1.SoundType.ALL?this._sounds:this.getSoundsByType(e);o<n.length;o++){n[o].item.mute(t)}},t.prototype.loadSound=function(t,e,o){this.isAdded(t)||(this._sounds.push({id:t,item:this._soundController.load(this.getUrlById(t)),type:e,delay:1e3}),this._logger.log(o,"LoadSound",t),this._soundController.updateMasterVolume())},t.prototype.isSoundPlaying=function(t){var e=this.getSoundById(t);return e&&e.item.playing()},t.prototype.loadData=function(t,e,o){void 0===o&&(o="sound-settings"),this._config=t,this._cdnUrl=e,this._soundStorageKey=o;var n=this._storageManager.loadData(this._soundStorageKey);this._data=n?JSON.parse(n):new SoundData_1.SoundData},t.prototype.saveData=function(){this._storageManager.saveData(this._soundStorageKey,JSON.stringify(this._data))},t.prototype.isAdded=function(e){return null!=this._sounds.filter(function(t){return t.id==e})[0]},t.prototype.isLoaded=function(t){if(this.isAdded(t)&&"loaded"==this.getSoundById(t).item.state())return!0;return!1},t.prototype.getSoundById=function(e){return this._sounds.filter(function(t){return t.id==e})[0]},t.prototype.getSoundsByType=function(e){return this._sounds.filter(function(t){return t.type==e})},t.prototype.getUrlById=function(e){var t=this._config.filter(function(t){return t.id==e})[0].path;return""+this._cdnUrl+t},t.prototype.subscribe=function(){var t=this;document.addEventListener("visibilitychange",function(){t.windowFocusChanged(document.hidden)}),window.addEventListener("focus",function(){t.windowFocusChanged(!1)},!1),window.addEventListener("blur",function(){t.windowFocusChanged(!0)},!1),window.onpageshow=function(){t.windowFocusChanged(!1)},window.onpagehide=function(){t.windowFocusChanged(!0)},window.onfocus=function(){t.windowFocusChanged(!1)},window.onblur=function(){t.windowFocusChanged(!0)}},t.prototype.windowFocusChanged=function(t){this._data&&this._data.soundOn&&this.muteSoundsByTypeInternal(t,ISoundManager_1.SoundType.SFX),this._data&&this._data.musicOn&&this.muteSoundsByTypeInternal(t,ISoundManager_1.SoundType.Music)},t.prototype.update=function(t){for(var e=0;e<this._sounds.length;e++){this._sounds[e].delay+=t}},__decorate([typescript_ioc_1.Inject,__metadata("design:type",StorageManager_1.StorageManager)],t.prototype,"_storageManager",void 0),__decorate([typescript_ioc_1.Inject,__metadata("design:type",ViewBaseEmptyLogger_1.ViewBaseEmptyLogger)],t.prototype,"_logger",void 0),t=__decorate([typescript_ioc_1.Singleton,__metadata("design:paramtypes",[])],t)}();exports.SoundManager=SoundManager;