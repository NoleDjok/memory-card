"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __decorate=this&&this.__decorate||function(t,e,r,a){var n,i=arguments.length,c=i<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,r,a);else for(var o=t.length-1;0<=o;o--)(n=t[o])&&(c=(i<3?n(c):3<i?n(e,r,c):n(e,r))||c);return 3<i&&c&&Object.defineProperty(e,r,c),c},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)};Object.defineProperty(exports,"__esModule",{value:!0});var typescript_ioc_1=require("../../IoC/typescript-ioc"),WatchObject=function(){function t(){this.methodNames=[]}var p;return(p=t).prototype.watch=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[1];p.isFunction(r)?this.watchAll.apply(this,t):this.watchOne.apply(this,t)},t.prototype.unwatch=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[1];p.isFunction(r)||void 0===r?this.unwatchAll.apply(this,t):p.isArray(r)?p.unwatchMany.apply(this,t):p.unwatchOne.apply(this,t)},t.isArray=function(t){return"[object Array]"==={}.toString.call(t)},t.isObject=function(t){return"[object Object]"==={}.toString.call(t)},t.isFunction=function(t){return"[object Function]"==={}.toString.call(t)},t.defineProp=function(t,e,r){Object.defineProperty(t,e,{enumerable:!1,configurable:!0,writable:!1,value:r})},t.prototype.defineGetAndSet=function(t,e,r,a){Object.defineProperty(t,e,{get:r,set:function(t){a.call(this,t)},enumerable:!0,configurable:!0})},t.callWatchers=function(t,e,r,a,n){var i,c=t.__watchers__[e];(i=t.__watchers__.__watchall__)&&(c=c?c.concat(i):i);for(var o=c?c.length:0,_=0;_<o;_++)c[_].call(t,r,a,e,n)},t.prototype.defineArrayMethodWatcher=function(s,h,l,f){p.defineProp(s,l,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r,a,n=0;if("splice"===l){var i=t[0],c=i+t[1];r=s.slice(i,c),a=[];for(var o=2;o<t.length;o++)a[o-2]=t[o];n=i}else a="push"===l||"unshift"===l?0<t.length?t:void 0:0<t.length?t[0]:void 0;var _=h.apply(s,t);return"pop"===l?(r=_,n=s.length):"push"===l?n=s.length-1:"shift"===l?r=_:"unshift"!==l&&void 0===a&&(a=_),f.call(s,n,l,a,r),_})},t.prototype.watchFunctions=function(t,e){if(p.isFunction(e)&&t&&!(t instanceof String)&&p.isArray(t))for(var r=this.methodNames.length;0<r;r--){var a=this.methodNames[r-1];this.defineArrayMethodWatcher(t,t[a],a,e)}},t.prototype.defineWatcher=function(s,h,t,l){var f=this,e=!1,r=p.isArray(s);void 0===s.__watchers__&&(p.defineProp(s,"__watchers__",{}),r&&this.watchFunctions(s,function(t,e,r,a){if(p.callWatchers(s,t,r,a,e),0!==l&&r&&(p.isObject(r)||p.isArray(r))){var n,i=s.__watchers__[h];(n=s.__watchers__.__watchall__)&&(i=i?i.concat(n):n);for(var c=i?i.length:0,o=0;o<c;o++)if("splice"!==e)f.watchAll(r,i[o],void 0===l?l:l-1);else for(var _=0;_<r.length;_++)f.watchAll(r[_],i[o],void 0===l?l:l-1)}})),void 0===s.__proxy__&&p.defineProp(s,"__proxy__",{}),void 0===s.__watchers__[h]&&(s.__watchers__[h]=[],r||(e=!0));for(var a=0;a<s.__watchers__[h].length;a++)if(s.__watchers__[h][a]===t)return;if(s.__watchers__[h].push(t),e){var n=Object.getOwnPropertyDescriptor(s,h);if(void 0!==n){var i={enumerable:n.enumerable,configurable:n.configurable};["get","set"].forEach(function(r){void 0!==n[r]&&(i[r]=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n[r].apply(s,t)})});["writable","value"].forEach(function(t){void 0!==n[t]&&(i[t]=n[t])}),Object.defineProperty(s.__proxy__,h,i)}else s.__proxy__[h]=s[h];var c=this;this.defineGetAndSet(s,h,function(){return s.__proxy__[h]},function(t){var e=s.__proxy__[h];if(0!==l&&s[h]&&(p.isObject(s[h])||p.isArray(s[h]))&&!s[h].__watchers__)for(var r=0;r<s.__watchers__[h].length;r++)c.watchAll(s[h],s.__watchers__[h][r],void 0===l?l:l-1);e!==t&&(s.__proxy__[h]=t,p.callWatchers(s,h,t,e,"set"))})}},t.prototype.watchAll=function(t,e,r){if(!p.disabled&&"string"!=typeof t&&(t instanceof Object||p.isArray(t)))if(p.isArray(t)){if(this.defineWatcher(t,"__watchall__",e,r),void 0===r||0<r)for(var a=0;a<t.length;a++)this.watchAll(t[a],e,r)}else{var n=[];for(var a in t)({}).hasOwnProperty.call(t,a)&&n.push(a);this.watchMany(t,n,e,r)}},t.prototype.watchOne=function(t,e,r,a){e.startsWith("_$")||e.startsWith("__$")||p.disabled||"string"!=typeof t&&(t instanceof Object||p.isArray(t))&&(p.isFunction(t[e])||(null!==t[e]&&(void 0===a||0<a)&&this.watchAll(t[e],r,void 0!==a?a-1:a),this.defineWatcher(t,e,r,a)))},t.prototype.watchMany=function(t,e,r,a){if("string"!=typeof t&&(t instanceof Object||p.isArray(t)))for(var n=0;n<e.length;n++){var i=e[n];this.watchOne(t,i,r,a)}},t.unwatchOne=function(t,e,r){if(!e.startsWith("_$")&&!e.startsWith("__$")&&void 0!==t.__watchers__&&void 0!==t.__watchers__[e])if(void 0===r)delete t.__watchers__[e];else for(var a=0;a<t.__watchers__[e].length;a++)t.__watchers__[e][a]===r&&t.__watchers__[e].splice(a,1)},t.unwatchMany=function(t,e,r){for(var a in e)e.hasOwnProperty(a)&&p.unwatchOne(t,e[a],r)},t.prototype.unwatchPropsInObject=function(t,e){var r=[];for(var a in t)a.startsWith("_$")||a.startsWith("__$")||t.hasOwnProperty(a)&&(t[a]instanceof Object&&this.unwatchPropsInObject(t[a],e),r.push(a));p.unwatchMany(t,r,e)},t.prototype.unwatchAll=function(t,e){if(!(t instanceof String||!p.isObject(t)&&!p.isArray(t)))if(p.isArray(t)){for(var r=["__watchall__"],a=0;a<t.length;a++)r.push(a.toString());p.unwatchMany(t,r,e)}else this.unwatchPropsInObject(t,e)},t.disabled=!1,t=p=__decorate([typescript_ioc_1.Singleton,__metadata("design:paramtypes",[])],t)}();exports.WatchObject=WatchObject;