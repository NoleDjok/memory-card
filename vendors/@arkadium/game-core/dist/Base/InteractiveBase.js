"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __decorate=this&&this.__decorate||function(e,t,i,n){var r,s=arguments.length,o=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;0<=a;a--)(r=e[a])&&(o=(s<3?r(o):3<s?r(t,i,o):r(t,i))||o);return 3<s&&o&&Object.defineProperty(t,i,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__awaiter=this&&this.__awaiter||function(e,o,a,h){return new(a||(a=Promise))(function(i,t){function n(e){try{s(h.next(e))}catch(e){t(e)}}function r(e){try{s(h.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof a?t:new a(function(e){e(t)})).then(n,r)}s((h=h.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(i,n){var r,s,o,e,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,s&&(o=2&t[0]?s.return:t[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,t[1])).done)return o;switch(s=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,s=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(o=0<(o=a.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){a.label=t[1];break}if(6===t[0]&&a.label<o[1]){a.label=o[1],o=t;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(t);break}o[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(i,a)}catch(e){t=[6,e],s=0}finally{r=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var KeyboardManager_1=require("./Keyboard/KeyboardManager"),Tween_1=require("./Tween/Tween"),Easing_1=require("./Tween/Easing"),ChildViews_1=require("./ChildViews"),Linq_1=require("../Linq/Linq"),typescript_ioc_1=require("../IoC/typescript-ioc"),underscore_1=require("../Utils/underscore"),ScreenOrientationEnum_1=require("./Orientation/ScreenOrientationEnum"),OrientationFactory_1=require("./Orientation/OrientationFactory"),DevicePixelRatio_1=require("../DevicePixelRatio"),GameResources_1=require("../GameResources"),PIXIRenderer_1=require("../PIXIRenderer"),RootHtml_1=require("../RootHtml"),QueueList_1=require("./Queue/QueueList"),AnimateResourcesLoader_1=require("./Resources/AnimateResourcesLoader"),GameSize=function(){function e(e,t,i){this._x=e,this._y=t,this._s=i}return Object.defineProperty(e.prototype,"x",{get:function(){return this._x},set:function(e){this._x=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._y},set:function(e){this._y=e},enumerable:!0,configurable:!0}),e}(),InteractiveBase=function(){function e(e){var i=this;this._preloadLoaded=!1,this._manualResize=!1,this._contentLoaded=!1,this.sizeLandscape=new PIXI.Point(450,325),this.sizePortrait=new PIXI.Point(450,325),this._initialized=!1,this._scaleFactor=1,this._layers=[],this._orientation=ScreenOrientationEnum_1.ScreenOrientationEnum.PortraitAndLandscape,this._resizeDelay={d:2},this._tweenResizeDelay=new Tween_1.Tween(this._resizeDelay).to({d:0},200).easing(Easing_1.Easing.Linear.None).onComplete(function(){i.rendererResize(),i._resizeDelay.d=2;for(var e=i._layers.length,t=0;t<e;t++)i._layers[t].visible=!0}),this.graphHigh=!0,this._isLandscape=!0,this._preloaderchildViews=new ChildViews_1.ChildViews,this.$childViews=new ChildViews_1.ChildViews,this.stop=!1,this.frameCount=0,this.currentFps=0;var t=this.defineAssetScale();this._scaleFactor=t,this._resourcesLoader=typescript_ioc_1.Container.get(AnimateResourcesLoader_1.AnimateResourcesLoader),this._devicePixelRatio=typescript_ioc_1.Container.get(DevicePixelRatio_1.DevicePixelRatio),this._resourcesRoot=typescript_ioc_1.Container.get(GameResources_1.GameResources),this._renderer=typescript_ioc_1.Container.get(PIXIRenderer_1.PIXIRenderer),this._htmlElement=typescript_ioc_1.Container.get(RootHtml_1.RootHtml),this._keyboardManager=typescript_ioc_1.Container.get(KeyboardManager_1.KeyboardManager),this._size=new GameSize(this.sizeLandscape.x,this.sizeLandscape.y,1)}return Object.defineProperty(e.prototype,"orientation",{set:function(e){this._orientation=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width*this.scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height*this.scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isLandscape",{get:function(){return this._size.x>=this._size.y},enumerable:!0,configurable:!0}),e.prototype.onUpdate=function(e){},e.prototype.preloaderConfigure=function(){var i=this;if(this.config=this.getPreloadersConfiguration(),this.config){underscore_1._u.each(this.config.childViews,function(e,t){e.view&&i._addChild(e,t,i._preloaderchildViews)},this);var n=new Linq_1.List;return this._preloaderchildViews.items.ForEach(function(e){n.AddRange(e.view.getResources())}),new Promise(function(e,t){i._resourcesLoader.load("Game",n.ToArray(),function(){underscore_1._u.each(i.config.childViews,function(e,t){e.view&&i._innitializeChild(e,i._preloaderchildViews[t],i._layers[2])},i),i._contentLoaded=!0,i._preloadLoaded=!0,e()})})}return new Promise(function(e,t){i._contentLoaded=!0,i._preloadLoaded=!0,e()})},e.prototype.configure=function(){var i=this;this._contentLoaded=!1,this.config=this.getConfiguration(),underscore_1._u.each(this.config.childViews,function(e,t){e.view&&i._addChild(e,t,i.$childViews)},this);var t=new Linq_1.List;this.$childViews.items.ForEach(function(e){t.AddRange(e.view.getResources())}),this._resourcesLoader.load("Game",t.ToArray(),function(){i._contentLoaded=!0,i.initialize()})},e.prototype.initialize=function(){var i=this;this._initialized||(underscore_1._u.each(this.config.childViews,function(e,t){e.view&&i._innitializeChild(e,i.$childViews[t],i._layers[1])},this),this.onInitialize(),this._initialized=!0,this.contentLoaded(),this.rendererResize(!0))},e.prototype.showLoading=function(e){this._contentLoaded},e.prototype.setLoading=function(e){this._preloadLoaded},e.prototype.create=function(){return __awaiter(this,void 0,void 0,function(){var i=this;return __generator(this,function(e){return this._resourcesLoader.setGameBase(this),[2,new Promise(function(e,t){return i.createStage(),i.onCreate(),Promise.all([i.preloaderConfigure()]).then(function(){return i.rendererResize(!0),Promise.all([]).then(function(){setTimeout(function(){i.configure(),e(i)},300)},function(e){})},function(e){})})]})})},e.prototype.createStage=function(){this._container=new PIXI.Container;for(var e=0;e<5;e++){var t=new PIXI.Container;this._layers[e]=t,this._container.addChild(t)}this._renderer.stage.addChild(this._container),this.fpsInterval=1e3/this._renderer.fps,this.then=Date.now(),this.startTime=this.then,this.stop=!1,this._animate()},e.prototype.dispose=function(){this.stop=!0,this.$childViews.items.ForEach(function(e){e.view.dispose()}),this._renderer.destroy()},e.prototype.focus=function(t){t?this._keyboardManager.enable():this._keyboardManager.disable(),this.onFocus(t),this.$childViews.items.ForEach(function(e){e.view.focus(t)})},e.prototype.onFocus=function(e){},e.prototype.update=function(t){for(var e in Tween_1.Tween.update(),this._resourcesLoader.update(t),this.onUpdate(t),this.$childViews.items.ForEach(function(e){e.view.update(t)}),this._preloaderchildViews.items.ForEach(function(e){e.view.update(t)}),this._keyboardManager.update(),QueueList_1.QueueItem.queue){QueueList_1.QueueItem.queue[e].update(t)}},e.prototype.play=function(){this.then=Date.now(),this.startTime=this.then;var e=new Date;this.last_time=e.getTime(),this.stop=!1},e.prototype.pause=function(){this.stop=!0},e.prototype.getBackgroundColor=function(e){var t=window.getComputedStyle(e,null).getPropertyValue("background-color");return"rgba(0, 0, 0, 0)"==t&&e!=document.body||"transparent"==t?this.getBackgroundColor(e.parentNode):t},e.prototype.checkVisible=function(){var e=this._htmlElement.htmlDivElement.getBoundingClientRect(),t=Math.max(document.documentElement.clientHeight,window.innerHeight);return!(e.bottom<0||0<=e.top-t)},e.prototype._animate=function(){var e=this;if(this._clientWidth==this._htmlElement.htmlDivElement.clientWidth&&this._clientHeight==this._htmlElement.htmlDivElement.clientHeight||this._manualResize||this.resize(),requestAnimationFrame(function(){e._animate()}),!this.stop){this.now=Date.now(),this.elapsed=this.now-this.then;var t=new Date,i=t.getTime(),n=(i-this.last_time)/1e3;if(this.last_time=this.last_time?i:t.getTime(),this.checkVisible()&&this.update(n),this.elapsed>this.fpsInterval){this.then=this.now-this.elapsed%this.fpsInterval,this.checkVisible()&&this._renderer.render();var r=this.now-this.startTime;this.currentFps=Math.round(1e3/(r/++this.frameCount)*100)/100,600==this.frameCount&&(this.startTime=this.now,this.frameCount=0)}}},e.prototype._rendererResize=function(e,t){var i=this;this._clientWidth=e,this._clientHeight=t;var n=this._clientWidth*(this.graphHigh?this._devicePixelRatio.value:1),r=this._clientHeight*(this.graphHigh?this._devicePixelRatio.value:1);this._renderer.renderer.resize(n,r);var s=this._renderer.renderer.view;(s.style.width=this._clientWidth+"px",s.style.height=this._clientHeight+"px",this._contentLoaded)&&(OrientationFactory_1.OrientationFactory.getOrientation(ScreenOrientationEnum_1.ScreenOrientationEnum.PortraitAndLandscape).run(n,r)==ScreenOrientationEnum_1.ScreenOrientationEnum.Portrait?this._orientation==ScreenOrientationEnum_1.ScreenOrientationEnum.Landscape?(this.setLandscape(n,r),this._isLandscape=!0,this.$childViews.items.ForEach(function(e){e.view.resize(n,r,i._scale)})):(this.setPortrait(n,r),this._isLandscape=!1,this.$childViews.items.ForEach(function(e){e.view.resize(n,r,i._scale)})):this._orientation==ScreenOrientationEnum_1.ScreenOrientationEnum.Portrait?(this.setRotatedPortrait(n,r),this._isLandscape=!1,this.$childViews.items.ForEach(function(e){e.view.resize(r,n,i._scale)})):(this.setLandscape(n,r),this._isLandscape=!0,this.$childViews.items.ForEach(function(e){e.view.resize(n,r,i._scale)})))},e.prototype.rendererResize=function(e){void 0===e&&(e=!1),this._manualResize||this._clientWidth==this._htmlElement.htmlDivElement.clientWidth&&this._clientHeight==this._htmlElement.htmlDivElement.clientHeight&&0==e||this._rendererResize(this._htmlElement.htmlDivElement.clientWidth,this._htmlElement.htmlDivElement.clientHeight)},e.prototype.setRotatedPortrait=function(e,t){this._size.x=this.sizeLandscape.y,this._size.y=this.sizeLandscape.x,this._scale=Math.min(e/(this._size.y*this.scaleFactor),t/(this._size.x*this.scaleFactor));for(var i=this._layers.length,n=0;n<i;n++)0!=n&&(this._layers[n].scale.x=this._layers[n].scale.y=this._scale,this._layers[n].rotation=-Math.PI/2);this._container.x=.5*this._renderer.renderer.view.width,this._container.y=.5*this._renderer.renderer.view.height,this.onSetPortrait(),this.$childViews.items.ForEach(function(e){e.view.setPortrait()})},e.prototype.setPortrait=function(e,t){this._size.x=this.sizePortrait.x,this._size.y=this.sizePortrait.y,this._scale=Math.min(t/(this._size.y*this.scaleFactor),e/(this._size.x*this.scaleFactor));for(var i=this._layers.length,n=0;n<i;n++)0!=n&&(this._layers[n].scale.x=this._layers[n].scale.y=this._scale,this._layers[n].rotation=0);this._container.x=.5*this._renderer.renderer.view.width,this._container.y=.5*this._renderer.renderer.view.height,this.onSetPortrait(),this.$childViews.items.ForEach(function(e){e.view.setPortrait()})},e.prototype.setLandscape=function(e,t){this._size.x=this.sizeLandscape.x,this._size.y=this.sizeLandscape.y,this._scale=Math.min(t/(this._size.y*this.scaleFactor),e/(this._size.x*this.scaleFactor));for(var i=this._layers.length,n=1;n<i;n++)this._layers[n].scale.x=this._layers[n].scale.y=this._scale,this._layers[n].rotation=0;this._container.x=.5*this._renderer.renderer.view.width,this._container.y=.5*this._renderer.renderer.view.height,this.onSetLandscape(),this.$childViews.items.ForEach(function(e){e.view.setLandscape()})},e.prototype.clear=function(){this.$childViews.items.ForEach(function(e){e.view.dispose()}),this.$childViews=new ChildViews_1.ChildViews},e.prototype.resize=function(){if(!(this._resizeDelay.d<2)){if(1.1*(this._htmlElement.htmlDivElement.clientWidth*(this.graphHigh?this._devicePixelRatio.value:1))<this._htmlElement.htmlDivElement.clientHeight*(this.graphHigh?this._devicePixelRatio.value:1)){if(this._isLandscape)for(var e=this._layers.length,t=0;t<e;t++)this._layers[t].visible=!1}else if(!this._isLandscape)for(e=this._layers.length,t=0;t<e;t++)this._layers[t].visible=!1;this._tweenResizeDelay.start()}},e.prototype.getLayer=function(e){return!this._layers||e>=this._layers.length?null:this._layers[e]},e.prototype.contentLoaded=function(){this._initialized&&this._contentLoaded&&this.onContentLoaded()},e.prototype.onContentLoaded=function(){},e.prototype.defineAssetScale=function(){window.innerWidth,devicePixelRatio,window.innerHeight,devicePixelRatio;return this._assetScale=1,2},e.prototype._addChild=function(e,t,i){void 0===t&&(t=null);var n=typescript_ioc_1.Container.get(e.view,e.options),r=t||n.name;if(n){n.name=r,n.isLandscape=this.isLandscape,e.model&&(n.$model=e.model),n.configure(),underscore_1._u.extend(n.config,e.config||{});var s=new ChildViews_1.ChildItem(n);s.name=t,s.viewName=r,i.items.Add(s),null!=t&&(i[t]=s)}return n},e.prototype._innitializeChild=function(e,t,i){t.view.initialize(null,i),null!=e.x&&null!=e.x&&(t.view.x=e.x),null!=e.y&&null!=e.y&&(t.view.y=e.y)},e.prototype.removeChildByName=function(t){var e=this.$childViews.items.FirstOrDefault(function(e){return e.name==t});this._removeChild(e),this.$childViews[t]=null},e.prototype._removeChild=function(e){null!=e&&(this.$childViews.items.Remove(e),e.view.dispose())},__decorate([typescript_ioc_1.Inject,__metadata("design:type",AnimateResourcesLoader_1.AnimateResourcesLoader)],e.prototype,"_resourcesLoader",void 0),__decorate([typescript_ioc_1.Inject,__metadata("design:type",DevicePixelRatio_1.DevicePixelRatio)],e.prototype,"_devicePixelRatio",void 0),__decorate([typescript_ioc_1.Inject,__metadata("design:type",GameResources_1.GameResources)],e.prototype,"_resourcesRoot",void 0),__decorate([typescript_ioc_1.Inject,__metadata("design:type",PIXIRenderer_1.PIXIRenderer)],e.prototype,"_renderer",void 0),__decorate([typescript_ioc_1.Inject,__metadata("design:type",RootHtml_1.RootHtml)],e.prototype,"_htmlElement",void 0),__decorate([typescript_ioc_1.Inject,__metadata("design:type",KeyboardManager_1.KeyboardManager)],e.prototype,"_keyboardManager",void 0),e}();exports.InteractiveBase=InteractiveBase;