"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */Object.defineProperty(exports,"__esModule",{value:!0});var Linq_1=require("../Linq/Linq"),ResourcesLoader_1=require("./Resources/ResourcesLoader"),IViewConfiguration_1=require("./IViewConfiguration"),expandFunc_1=require("./expandFunc"),SpriteEvents=function(){function s(){this.items=new Linq_1.List,this._scrollYOnDown=0,this._pointerDown=!1,this._pointerOver=!1}return s.prototype.initialize=function(e,t,n,i,o){if(e)for(var r=0;r<e.length;r++){var a=e[r],s=void 0;if(a.targetType==IViewConfiguration_1.EventsTargetTypeEnum.SPRITE)s=n[a.targetName];else if(a.targetType==IViewConfiguration_1.EventsTargetTypeEnum.BOUNDING_BOXE&&!s){var p=t[a.targetName];p&&(n["$boundingBoxes_"+a.targetName]||(n["$boundingBoxes_"+a.targetName]=p.toGraphics(),n["$boundingBoxes_"+a.targetName].hitArea=p.toPolygon(),p.sprite=n["$boundingBoxes_"+a.targetName]),s=n["$boundingBoxes_"+a.targetName],i.display.addChild(s))}s?this.addEvent(s,a.event,i,o,a):console.error(i.name+": error can't find target '"+a.targetName+"'")}},s.prototype.addEvent=function(t,e,n,i,o){var r=this,a=expandFunc_1.expandFunc(e,n);if(o.eventType==IViewConfiguration_1.EventsTypeEnum.CLICK_OR_TAP){this.items.Add(new SpritesEventItem(function(e){r._scrollYOnDown=window.scrollY},IViewConfiguration_1.EventsTypeEnum.POINTERDOWN,t,n,o.targetName)),this.items.Add(new SpritesEventItem(function(e){Math.abs(r._scrollYOnDown-window.scrollY)<5&&(SpritesEventItem.blockSpritesEvents||i.log(n.locator,"SpritesEvent",o.eventType,[e,o.targetName]),a(e))},IViewConfiguration_1.EventsTypeEnum.POINTERUP,t,n,o.targetName))}else o.eventType==IViewConfiguration_1.EventsTypeEnum.TAP_AND_POINTERMOVE?(this.items.Add(new SpritesEventItem(function(e){r._pointerDown=!0},IViewConfiguration_1.EventsTypeEnum.POINTERDOWN,t,n,o.targetName)),this.items.Add(new SpritesEventItem(function(e){r._pointerDown=!1},IViewConfiguration_1.EventsTypeEnum.POINTERUP,t,n,o.targetName)),this.items.Add(new SpritesEventItem(function(e){r._pointerDown&&(SpritesEventItem.blockSpritesEvents||i.log(n.locator,"SpritesEvent",IViewConfiguration_1.EventsTypeEnum.POINTERMOVE,[e,o.targetName]),a(e))},IViewConfiguration_1.EventsTypeEnum.POINTERMOVE,t,n,o.targetName))):o.eventType==IViewConfiguration_1.EventsTypeEnum.TAP_GLOBAL_AND_POINTERMOVE?(this.items.Add(new SpritesEventItem(function(e){s._pointerDownGlobal=!0},IViewConfiguration_1.EventsTypeEnum.POINTERDOWN,t,n,o.targetName)),this.items.Add(new SpritesEventItem(function(e){s._pointerDownGlobal=!1},IViewConfiguration_1.EventsTypeEnum.POINTERUP,t,n,o.targetName)),this.items.Add(new SpritesEventItem(function(e){s._pointerDownGlobal&&(SpritesEventItem.blockSpritesEvents||i.log(n.locator,"SpritesEvent",IViewConfiguration_1.EventsTypeEnum.POINTERMOVE,[e,o.targetName]),a(e))},IViewConfiguration_1.EventsTypeEnum.POINTERMOVE,t,n,o.targetName))):o.eventType==IViewConfiguration_1.EventsTypeEnum.POINTERMOVE?this.items.Add(new SpritesEventItem(function(e){SpritesEventItem.blockSpritesEvents||i.log(n.locator,"SpritesEvent",IViewConfiguration_1.EventsTypeEnum.POINTERMOVE,[e,o.targetName]),a(e)},IViewConfiguration_1.EventsTypeEnum.POINTERMOVE,t,n,o.targetName)):o.eventType==IViewConfiguration_1.EventsTypeEnum.POINTER_HITAREA_MOVE?this.items.Add(new SpritesEventItem(function(e){t.hitArea&&t.hitArea.contains(e.localPosition.x,e.localPosition.y)&&(SpritesEventItem.blockSpritesEvents||i.log(n.locator,"SpritesEvent",IViewConfiguration_1.EventsTypeEnum.POINTERMOVE,[e,o.targetName]),a(e))},IViewConfiguration_1.EventsTypeEnum.POINTERMOVE,t,n,o.targetName)):this.items.Add(new SpritesEventItem(function(e){o.eventType==IViewConfiguration_1.EventsTypeEnum.POINTERDOWN&&(s._pointerDownGlobal=!0),o.eventType==IViewConfiguration_1.EventsTypeEnum.POINTERUP&&(s._pointerDownGlobal=!1),SpritesEventItem.blockSpritesEvents||i.log(n.locator,"SpritesEvent",o.eventType,[e,o.targetName]),a(e)},o.eventType,t,n,o.targetName))},s.prototype.dispose=function(){this.items.ForEach(function(e){e.sprite.removeListener(e.name,e.event)})},s._pointerDownGlobal=!1,s}();exports.SpriteEvents=SpriteEvents;var SpritesEventItem=function(){function d(e,t,n,i,o,r){var l=this;void 0===r&&(r=!1),this._event=e,this.name=t,this.sprite=n,this._view=i,this.spriteName=o,this._tempPoint=new PIXI.Point,this.containsPoint=function(e){var t=l.sprite;t.worldTransform.applyInverse(e,l._tempPoint);var n=t._texture.orig.width,i=t._texture.orig.height,o=-n*t.anchor.x,r=0,a=!1;if(l._tempPoint.x>=o&&l._tempPoint.x<o+n&&(r=-i*t.anchor.y,l._tempPoint.y>=r&&l._tempPoint.y<r+i&&(a=!0)),!a)return!1;var s=t.texture,p=t.texture.baseTexture;if(!p.hitmap&&!d._genHitMap(p,127))return!0;var u=p.hitmap,E=p.resolution,m=Math.round((l._tempPoint.x-o+s.frame.x)*E)+Math.round((l._tempPoint.y-r+s.frame.y)*E)*p.hitmapWidth,v=m/32|0,g=m-32*v;return 0<(u[v]&1<<g)},this.event=function(e){if(l._view.isReady&&(!e.data.pointerType||"touch"!=e.data.pointerType||e.data.isPrimary)&&!ResourcesLoader_1.ResourcesLoader.loading){var t={localPosition:e.data.getLocalPosition(e.currentTarget.parent),preventDefault:function(){e.data.originalEvent.preventDefault()},stopPropagation:function(){e.stopPropagation()},globalPosition:e.data.global};"mouse"==e.data.pointerType&&(t.mouseEvent={button:e.data.button}),t.screenPosition=new PIXI.Point((t.globalPosition.x-n.transform.worldTransform.tx)/n.transform.worldTransform.a,(t.globalPosition.y-n.transform.worldTransform.ty)/n.transform.worldTransform.d),l._event(t)}},d.blockSpritesEvents||n.on(t,this.event,this._view),n.interactive=!0,n.buttonMode=!0}return d.prototype.run=function(e){return this._event(e),[e]},d.blockSpritesEvents=!1,d._genHitMap=function(e,t){if(!e.resource)return!1;var n=e.resource.source,i=null;if(!n)return!1;var o=null;if(n.getContext)o=(i=n).getContext("2d");else{if(!(n instanceof Image))return!1;(i=document.createElement("canvas")).width=n.width,i.height=n.height,(o=i.getContext("2d")).drawImage(n,0,0)}for(var r=i.width,a=i.height,s=o.getImageData(0,0,r,a),p=new Uint32Array(Math.ceil(r*a/32)),u=0;u<a;u++)for(var E=0;E<r;E++){var m=u*r+E,v=m/32|0,g=m-32*v;s.data[4*m+3]>=t&&(p[v]|=1<<g)}return e.hitmap=p,e.hitmapWidth=r,!0},d}();exports.SpritesEventItem=SpritesEventItem;