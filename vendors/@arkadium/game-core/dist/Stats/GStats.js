"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __extends=this&&this.__extends||function(){var o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var TextureHook=function(){function e(e){this.createdTextures=new Array,this.maxTexturesCount=0,this.isInit=!1,this.realGLCreateTexture=function(){},this.realGLDeleteTexture=function(){},e?e.__proto__.createTexture&&(this.gl=e,this.realGLCreateTexture=e.__proto__.createTexture,this.realGLDeleteTexture=e.__proto__.deleteTexture,e.__proto__.createTexture=this.fakeGLCreateTexture.bind(this),e.__proto__.deleteTexture=this.fakeGLDeleteTexture.bind(this),this.isInit=!0,console.log("[TextureHook] GL was Hooked!")):console.error("[TextureHook] GL can't be NULL")}return Object.defineProperty(e.prototype,"currentTextureCount",{get:function(){return this.createdTextures.length},enumerable:!0,configurable:!0}),e.prototype.registerTexture=function(e){this.createdTextures.push(e),this.maxTexturesCount=Math.max(this.createdTextures.length,this.maxTexturesCount)},e.prototype.fakeGLCreateTexture=function(){var e=this.realGLCreateTexture.call(this.gl);return this.registerTexture(e),e},e.prototype.fakeGLDeleteTexture=function(e){var t=this.createdTextures.indexOf(e);-1<t&&this.createdTextures.splice(t,1),this.realGLDeleteTexture.call(this.gl,e)},e.prototype.reset=function(){this.createdTextures=new Array,this.maxTexturesCount=0},e.prototype.release=function(){this.isInit&&(this.gl.__proto__.createTexture=this.realGLCreateTexture,this.gl.__proto__.deleteTexture=this.realGLDeleteTexture,console.log("[TextureHook] Hook was removed!")),this.isInit=!1},e}();exports.TextureHook=TextureHook;var GLHook=function(){function e(e){this.drawPasses=0,this.isInit=!1,this.realGLDrawElements=function(){},e?e.__proto__.drawElements&&(this.gl=e,this.realGLDrawElements=e.__proto__.drawElements,e.__proto__.drawElements=this.fakeGLdrawElements.bind(this),this.isInit=!0,console.log("[GLHook] GL was Hooked!")):console.error("[GLHook] GL can't be NULL")}return e.prototype.fakeGLdrawElements=function(e,t,r,o){this.drawPasses++,this.realGLDrawElements.call(this.gl,e,t,r,o)},e.prototype.reset=function(){this.drawPasses=0},e.prototype.release=function(){this.isInit&&(this.gl.__proto__.drawElements=this.realGLDrawElements,console.log("[GLHook] Hook was removed!")),this.isInit=!1},e}();exports.GLHook=GLHook;var BaseHooks=function(){function e(){this._drawCalls=-1,this._maxDeltaDrawCalls=-1}return e.prototype.attach=function(e){this.glhook=new GLHook(e),this.texturehook=new TextureHook(e)},Object.defineProperty(e.prototype,"drawCalls",{get:function(){return this.glhook&&this.glhook.isInit?this.glhook.drawPasses:-1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxDeltaDrawCalls",{get:function(){return this._maxDeltaDrawCalls},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"deltaDrawCalls",{get:function(){if(-1==this._drawCalls)return this._drawCalls=this.drawCalls,0;var e=this.drawCalls,t=e-this._drawCalls;return this._drawCalls=e,this._maxDeltaDrawCalls=Math.max(this._maxDeltaDrawCalls,t),t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"maxTextureCount",{get:function(){return this.texturehook&&this.texturehook.isInit?this.texturehook.maxTexturesCount:0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texturesCount",{get:function(){return this.texturehook&&this.texturehook.isInit?this.texturehook.currentTextureCount:0},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this._maxDeltaDrawCalls=-1,this._drawCalls=-1,this.glhook&&this.glhook.reset(),this.texturehook&&this.texturehook.reset()},e.prototype.release=function(){this.glhook&&this.glhook.release(),this.texturehook&&this.texturehook.release()},e}(),PIXIHooks=function(a){function e(e){var t=a.call(this)||this;if(!e)return console.error("renderer can't passed or NULL"),t;if(e instanceof PIXI.WebGLRenderer){t.attach(e.gl);var r=e.textureManager._managedTextures;if(r&&t.texturehook){console.log("[PIXI Hooks] Collect used textures:",r.length);for(var o=0;o<r.length;++o)for(var s=r[o]._glTextures,i=0;i<s.length;++i)s[i].gl===e.gl&&t.texturehook.registerTexture(s[i].texture)}}else console.error("[PIXI Hook]Canvas renderer is not allowed");return t}return __extends(e,a),e}(exports.BaseHooks=BaseHooks);exports.PIXIHooks=PIXIHooks;var StatsJSAdapter=function(){function e(e,t){this.hook=e,t?this.stats=t:(this.stats=null,window.Stats&&(this.stats=new window.Stats)),this.stats?(this.dcPanel=this.stats.addPanel(Stats.Panel("DC:","#330570","#A69700")),this.tcPanel=this.stats.addPanel(Stats.Panel("TC:","#A62500","#00B454")),this.stats.showPanel(0)):console.error("Stats can't found in window, pass instance of Stats.js as second param")}return e.prototype.update=function(){this.stats&&(this.hook&&(this.dcPanel.update(this.hook.deltaDrawCalls,Math.max(50,this.hook.maxDeltaDrawCalls)),this.tcPanel.update(this.hook.texturesCount,Math.max(20,this.hook.maxTextureCount))),this.stats.update())},e.prototype.reset=function(){this.hook&&this.hook.reset()},e}();exports.StatsJSAdapter=StatsJSAdapter;var Stats=function(){function s(){var r=0,o=document.createElement("div");function e(e){return o.appendChild(e.dom),e}function t(e){for(var t=0;t<o.children.length;t++)o.children[t].style.display=t===e?"block":"none";r=e}o.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",o.addEventListener("click",function(e){e.preventDefault(),t(++r%o.children.length)},!1),this.beginTime=(performance||Date).now(),this.prevTime=this.beginTime,this.frames=0,this.fpsPanel=e(s.Panel("FPS","#0ff","#002")),this.msPanel=e(s.Panel("MS","#0f0","#020")),self.performance&&self.performance.memory&&(this.memPanel=e(s.Panel("MB","#f08","#201"))),t(0),this.dom=o,this.domElement=o,this.addPanel=e,this.showPanel=t,this.setMode=t}return s.prototype.begin=function(){this.beginTime=(performance||Date).now()},s.prototype.end=function(){this.frames++;var e=(performance||Date).now();if(this.msPanel.update(e-this.beginTime,200),e>=this.prevTime+1e3&&(this.fpsPanel.update(1e3*this.frames/(e-this.prevTime),100),this.prevTime=e,this.frames=0,this.memPanel)){var t=performance.memory;this.memPanel.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e},s.prototype.update=function(){this.beginTime=this.end()},s.Panel=function(r,o,s){var i=1/0,a=0,n=Math.round,l=n(window.devicePixelRatio||1),h=80*l,e=48*l,u=3*l,c=2*l,p=3*l,f=15*l,d=74*l,x=30*l,m=document.createElement("canvas");m.width=h,m.height=e,m.style.cssText="width:80px;height:48px";var _=m.getContext("2d");return _.font="bold "+9*l+"px Helvetica,Arial,sans-serif",_.textBaseline="top",_.fillStyle=s,_.fillRect(0,0,h,e),_.fillStyle=o,_.fillText(r,u,c),_.fillRect(p,f,d,x),_.fillStyle=s,_.globalAlpha=.9,_.fillRect(p,f,d,x),{dom:m,update:function(e,t){i=Math.min(i,e),a=Math.max(a,e),_.fillStyle=s,_.globalAlpha=1,_.fillRect(0,0,h,f),_.fillStyle=o,_.fillText(n(e)+" "+r+" ("+n(i)+"-"+n(a)+")",u,c),_.drawImage(m,p+l,f,d-l,x,p,f,d-l,x),_.fillRect(p+d-l,f,l,x),_.fillStyle=s,_.globalAlpha=.9,_.fillRect(p+d-l,f,l,n((1-e/t)*x))}}},s}();exports.Stats=Stats;