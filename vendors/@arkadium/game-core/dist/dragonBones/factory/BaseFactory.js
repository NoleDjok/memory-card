"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Armature_1=require("../armature/Armature"),BaseObject_1=require("../core/BaseObject"),EventObject_1=require("../event/EventObject"),Constraint_1=require("../armature/Constraint"),Bone_1=require("../armature/Bone"),Surface_1=require("../armature/Surface"),BinaryDataParser_1=require("../parser/BinaryDataParser"),ObjectDataParser_1=require("../parser/ObjectDataParser"),BaseFactory=function(){function l(a){void 0===a&&(a=null),this.autoSearch=!1,this._dragonBonesDataMap={},this._textureAtlasDataMap={},this._dragonBones=null,(this._dataParser=null)===l._objectParser&&(l._objectParser=new ObjectDataParser_1.ObjectDataParser),null===l._binaryParser&&(l._binaryParser=new BinaryDataParser_1.BinaryDataParser),this._dataParser=null!==a?a:l._objectParser}return l.prototype._isSupportMesh=function(){return!0},l.prototype._getTextureData=function(a,t){if(a in this._textureAtlasDataMap)for(var e=0,r=this._textureAtlasDataMap[a];e<r.length;e++){if(null!==(o=(s=r[e]).getTexture(t)))return o}if(this.autoSearch)for(var n in this._textureAtlasDataMap)for(var i=0,l=this._textureAtlasDataMap[n];i<l.length;i++){var s,o;if((s=l[i]).autoSearch)if(null!==(o=s.getTexture(t)))return o}return null},l.prototype._fillBuildArmaturePackage=function(a,t,e,r,n){var i=null,l=null;if(0<t.length&&t in this._dragonBonesDataMap&&(l=(i=this._dragonBonesDataMap[t]).getArmature(e)),null===l&&(0===t.length||this.autoSearch))for(var s in this._dragonBonesDataMap)if(i=this._dragonBonesDataMap[s],(0===t.length||i.autoSearch)&&null!==(l=i.getArmature(e))){t=s;break}if(null===l)return!1;if(a.dataName=t,a.textureAtlasName=n,a.data=i,a.armature=l,a.skin=null,0<r.length&&(a.skin=l.getSkin(r),null===a.skin&&this.autoSearch))for(var s in this._dragonBonesDataMap){var o=this._dragonBonesDataMap[s].getArmature(r);if(null!==o){a.skin=o.defaultSkin;break}}return null===a.skin&&(a.skin=l.defaultSkin),!0},l.prototype._buildBones=function(a,t){for(var e=0,r=a.armature.sortedBones;e<r.length;e++){var n=r[e];BaseObject_1.BaseObject.borrowObject(0===n.type?Bone_1.Bone:Surface_1.Surface).init(n,t)}},l.prototype._buildSlots=function(a,t){var e=a.skin,r=a.armature.defaultSkin;if(null!==e&&null!==r){var n={};for(var i in r.displays){var l=r.getDisplays(i);n[i]=l}if(e!==r)for(var i in e.displays){l=e.getDisplays(i);n[i]=l}for(var s=0,o=a.armature.sortedSlots;s<o.length;s++){var u=o[s],p=u.name in n?n[u.name]:null,d=this._buildSlot(a,u,t);if(null!==p){d.displayFrameCount=p.length;for(var c=0,f=d.displayFrameCount;c<f;++c){var h=p[c];if(d.replaceRawDisplayData(h,c),null!==h){if(0<a.textureAtlasName.length){var D=this._getTextureData(a.textureAtlasName,h.path);d.replaceTextureData(D,c)}var _=this._getSlotDisplay(a,h,d);d.replaceDisplay(_,c)}else d.replaceDisplay(null)}}d._setDisplayIndex(u.displayIndex,!0)}}},l.prototype._buildConstraints=function(a,t){var e=a.armature.constraints;for(var r in e){var n=e[r];switch(n.type){case 0:var i=BaseObject_1.BaseObject.borrowObject(Constraint_1.IKConstraint);i.init(n,t),t._addConstraint(i);break;case 1:var l=BaseObject_1.BaseObject.borrowObject(Constraint_1.PathConstraint);l.init(n,t),t._addConstraint(l);break;default:var s=BaseObject_1.BaseObject.borrowObject(Constraint_1.IKConstraint);s.init(n,t),t._addConstraint(s)}}},l.prototype._buildChildArmature=function(a,t,e){return this.buildArmature(e.path,null!==a?a.dataName:"","",null!==a?a.textureAtlasName:"")},l.prototype._getSlotDisplay=function(a,t,e){var r=null!==a?a.dataName:t.parent.parent.parent.name,n=null;switch(t.type){case 0:var i=t;null===i.texture&&(i.texture=this._getTextureData(r,t.path)),n=e.rawDisplay;break;case 2:var l=t;null===l.texture&&(l.texture=this._getTextureData(r,l.path)),n=this._isSupportMesh()?e.meshDisplay:e.rawDisplay;break;case 1:var s=t,o=this._buildChildArmature(a,e,s);if(null!==o){if(o.inheritAnimation=s.inheritAnimation,!o.inheritAnimation){var u=0<s.actions.length?s.actions:o.armatureData.defaultActions;if(0<u.length)for(var p=0,d=u;p<d.length;p++){var c=d[p],f=BaseObject_1.BaseObject.borrowObject(EventObject_1.EventObject);EventObject_1.EventObject.actionDataToInstance(c,f,e.armature),(f.slot=e).armature._bufferAction(f,!1)}else o.animation.play()}s.armature=o.armatureData}n=o}return n},l.prototype.parseDragonBonesData=function(a,t,e){void 0===t&&(t=null),void 0===e&&(e=1);for(var r=a instanceof ArrayBuffer?l._binaryParser:this._dataParser,n=r.parseDragonBonesData(a,e);;){var i=this._buildTextureAtlasData(null,null);if(!r.parseTextureAtlasData(null,i,e)){i.returnToPool();break}this.addTextureAtlasData(i,t)}return null!==n&&this.addDragonBonesData(n,t),n},l.prototype.parseTextureAtlasData=function(a,t,e,r){void 0===e&&(e=null),void 0===r&&(r=1);var n=this._buildTextureAtlasData(null,null);return this._dataParser.parseTextureAtlasData(a,n,r),this._buildTextureAtlasData(n,t||null),this.addTextureAtlasData(n,e),n},l.prototype.updateTextureAtlases=function(a,t){var e=this.getTextureAtlasData(t);if(null!==e)for(var r=0,n=e.length;r<n;++r)r<a.length&&this._buildTextureAtlasData(e[r],a[r])},l.prototype.getDragonBonesData=function(a){return a in this._dragonBonesDataMap?this._dragonBonesDataMap[a]:null},l.prototype.addDragonBonesData=function(a,t){if(void 0===t&&(t=null),(t=null!==t?t:a.name)in this._dragonBonesDataMap){if(this._dragonBonesDataMap[t]===a)return;console.warn("Can not add same name data: "+t)}else this._dragonBonesDataMap[t]=a},l.prototype.removeDragonBonesData=function(a,t){void 0===t&&(t=!0),a in this._dragonBonesDataMap&&(t&&this._dragonBones.bufferObject(this._dragonBonesDataMap[a]),delete this._dragonBonesDataMap[a])},l.prototype.getTextureAtlasData=function(a){return a in this._textureAtlasDataMap?this._textureAtlasDataMap[a]:null},l.prototype.addTextureAtlasData=function(a,t){void 0===t&&(t=null);var e=(t=null!==t?t:a.name)in this._textureAtlasDataMap?this._textureAtlasDataMap[t]:this._textureAtlasDataMap[t]=[];e.indexOf(a)<0&&e.push(a)},l.prototype.removeTextureAtlasData=function(a,t){if(void 0===t&&(t=!0),a in this._textureAtlasDataMap){var e=this._textureAtlasDataMap[a];if(t)for(var r=0,n=e;r<n.length;r++){var i=n[r];this._dragonBones.bufferObject(i)}delete this._textureAtlasDataMap[a]}},l.prototype.getArmatureData=function(a,t){void 0===t&&(t="");var e=new BuildArmaturePackage;return this._fillBuildArmaturePackage(e,t,a,"","")?e.armature:null},l.prototype.clear=function(a){for(var t in void 0===a&&(a=!0),this._dragonBonesDataMap)a&&this._dragonBones.bufferObject(this._dragonBonesDataMap[t]),delete this._dragonBonesDataMap[t];for(var t in this._textureAtlasDataMap){if(a)for(var e=0,r=this._textureAtlasDataMap[t];e<r.length;e++){var n=r[e];this._dragonBones.bufferObject(n)}delete this._textureAtlasDataMap[t]}},l.prototype.buildArmature=function(a,t,e,r){void 0===t&&(t=""),void 0===e&&(e=""),void 0===r&&(r="");var n=new BuildArmaturePackage;if(!this._fillBuildArmaturePackage(n,t||"",a,e||"",r||""))return console.warn("No armature data: "+a+", "+(null!==t?t:"")),null;var i=this._buildArmature(n);return this._buildBones(n,i),this._buildSlots(n,i),this._buildConstraints(n,i),i.invalidUpdate(null,!0),i.advanceTime(0),i},l.prototype.replaceDisplay=function(a,t,e){if(void 0===e&&(e=-1),e<0&&(e=a.displayIndex),e<0&&(e=0),a.replaceDisplayData(t,e),null!==t){var r=this._getSlotDisplay(null,t,a);if(0===t.type){var n=a.getDisplayFrameAt(e).rawDisplayData;null!==n&&2===n.type&&(r=a.meshDisplay)}a.replaceDisplay(r,e)}else a.replaceDisplay(null,e)},l.prototype.replaceSlotDisplay=function(a,t,e,r,n,i){void 0===i&&(i=-1);var l=this.getArmatureData(t,a||"");if(null===l||null===l.defaultSkin)return!1;var s=l.defaultSkin.getDisplay(e,r);return this.replaceDisplay(n,s,i),!0},l.prototype.replaceSlotDisplayList=function(a,t,e,r){var n=this.getArmatureData(t,a||"");if(!n||!n.defaultSkin)return!1;var i=n.defaultSkin.getDisplays(e);if(!i)return!1;r.displayFrameCount=i.length;for(var l=0,s=r.displayFrameCount;l<s;++l){var o=i[l];this.replaceDisplay(r,o,l)}return!0},l.prototype.replaceSkin=function(a,t,e,r){void 0===e&&(e=!1),void 0===r&&(r=null);for(var n=!1,i=t.parent.defaultSkin,l=0,s=a.getSlots();l<s.length;l++){var o=s[l];if(!(null!==r&&0<=r.indexOf(o.name))){var u=t.getDisplays(o.name);if(null!==u||(null!==i&&t!==i&&(u=i.getDisplays(o.name)),null!==u)){o.displayFrameCount=u.length;for(var p=0,d=o.displayFrameCount;p<d;++p){var c=u[p];o.replaceRawDisplayData(c,p),null!==c?o.replaceDisplay(this._getSlotDisplay(null,c,o),p):o.replaceDisplay(null,p)}n=!0}else e&&(o.displayFrameCount=0)}}return n},l.prototype.replaceAnimation=function(a,t,e){void 0===e&&(e=!0);var r=t.defaultSkin;if(null===r)return!1;if(e)a.animation.animations=t.animations;else{var n=a.animation.animations,i={};for(var l in n)i[l]=n[l];for(var l in t.animations)i[l]=t.animations[l];a.animation.animations=i}for(var s=0,o=a.getSlots();s<o.length;s++)for(var u=o[s],p=0,d=0,c=u.displayList;d<c.length;d++){var f=c[d];if(f instanceof Armature_1.Armature){var h=r.getDisplays(u.name);if(null!==h&&p<h.length){var D=h[p];if(null!==D&&1===D.type){var _=this.getArmatureData(D.path,D.parent.parent.parent.name);_&&this.replaceAnimation(f,_,e)}}}p++}return!0},l.prototype.getAllDragonBonesData=function(){return this._dragonBonesDataMap},l.prototype.getAllTextureAtlasData=function(){return this._textureAtlasDataMap},Object.defineProperty(l.prototype,"clock",{get:function(){return this._dragonBones.clock},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"dragonBones",{get:function(){return this._dragonBones},enumerable:!0,configurable:!0}),l._objectParser=null,l._binaryParser=null,l}();exports.BaseFactory=BaseFactory;var BuildArmaturePackage=function(){this.dataName="",this.textureAtlasName="",this.skin=null};exports.BuildArmaturePackage=BuildArmaturePackage;