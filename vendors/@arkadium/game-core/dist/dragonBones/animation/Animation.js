"use strict";var __extends=this&&this.__extends||function(){var a=function(t,i){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])})(t,i)};return function(t,i){function n(){this.constructor=t}a(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var BaseObject_1=require("../core/BaseObject"),AnimationState_1=require("./AnimationState"),AnimationConfig_1=require("../model/AnimationConfig"),Animation=function(i){function t(){var t=null!==i&&i.apply(this,arguments)||this;return t._animationNames=[],t._animationStates=[],t._animations={},t._blendStates={},t._animationConfig=null,t}return __extends(t,i),t.toString=function(){return"[class dragonBones.Animation]"},t.prototype._onClear=function(){for(var t=0,i=this._animationStates;t<i.length;t++){i[t].returnToPool()}for(var n in this._animations)delete this._animations[n];for(var n in this._blendStates){var a=this._blendStates[n];for(var e in a)a[e].returnToPool();delete this._blendStates[n]}null!==this._animationConfig&&this._animationConfig.returnToPool(),this.timeScale=1,this._animationDirty=!1,this._inheritTimeScale=1,this._animationNames.length=0,this._animationStates.length=0,this._armature=null,this._animationConfig=null,this._lastAnimationState=null},t.prototype._fadeOut=function(t){switch(t.fadeOutMode){case 1:for(var i=0,n=this._animationStates;i<n.length;i++){null===(l=n[i])._parent&&(l.layer===t.layer&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut))}break;case 2:for(var a=0,e=this._animationStates;a<e.length;a++){null===(l=e[a])._parent&&(l.group===t.group&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut))}break;case 3:for(var o=0,s=this._animationStates;o<s.length;o++){null===(l=s[o])._parent&&(l.layer===t.layer&&l.group===t.group&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut))}break;case 4:for(var r=0,m=this._animationStates;r<m.length;r++){var l;null===(l=m[r])._parent&&l.fadeOut(t.fadeOutTime,t.pauseFadeOut)}}},t.prototype.init=function(t){null===this._armature&&(this._armature=t,this._animationConfig=BaseObject_1.BaseObject.borrowObject(AnimationConfig_1.AnimationConfig))},t.prototype.advanceTime=function(t){for(var i in t<0&&(t=-t),this._armature.inheritAnimation&&null!==this._armature._parent?this._inheritTimeScale=this._armature._parent._armature.animation._inheritTimeScale*this.timeScale:this._inheritTimeScale=this.timeScale,1!==this._inheritTimeScale&&(t*=this._inheritTimeScale),this._blendStates){var n=this._blendStates[i];for(var a in n)n[a].reset()}var e=this._animationStates.length;if(1===e)if(0<(g=this._animationStates[0])._fadeState&&0<g._subFadeState)this._armature._dragonBones.bufferObject(g),this._animationStates.length=0,this._lastAnimationState=null;else{var o=g.animationData,s=o.cacheFrameRate;if(this._animationDirty&&0<s){this._animationDirty=!1;for(var r=0,m=this._armature.getBones();r<m.length;r++){var l=m[r];l._cachedFrameIndices=o.getBoneCachedFrameIndices(l.name)}for(var h=0,u=this._armature.getSlots();h<u.length;h++){var _=u[h];if(0<_.displayFrameCount){var f=_.getDisplayFrameAt(0).rawDisplayData;if(null!==f&&f.parent===this._armature.armatureData.defaultSkin){_._cachedFrameIndices=o.getSlotCachedFrameIndices(_.name);continue}}_._cachedFrameIndices=null}}g.advanceTime(t,s)}else if(1<e){for(var p=0,d=0;p<e;++p){var g;0<(g=this._animationStates[p])._fadeState&&0<g._subFadeState?(d++,this._armature._dragonBones.bufferObject(g),this._animationDirty=!0,this._lastAnimationState===g&&(this._lastAnimationState=null)):(0<d&&(this._animationStates[p-d]=g),g.advanceTime(t,0)),p===e-1&&0<d&&(this._animationStates.length-=d,null===this._lastAnimationState&&0<this._animationStates.length&&(this._lastAnimationState=this._animationStates[this._animationStates.length-1]))}this._armature._cacheFrameIndex=-1}else this._armature._cacheFrameIndex=-1},t.prototype.reset=function(){for(var t=0,i=this._animationStates;t<i.length;t++){i[t].returnToPool()}this._animationDirty=!1,this._animationConfig.clear(),this._animationStates.length=0,this._lastAnimationState=null},t.prototype.stop=function(t){if(void 0===t&&(t=null),null!==t)null!==(a=this.getState(t))&&a.stop();else for(var i=0,n=this._animationStates;i<n.length;i++){var a;(a=n[i]).stop()}},t.prototype.playConfig=function(t){var i=t.animation;if(!(i in this._animations))return console.warn("Non-existent animation.\n","DragonBones name: "+this._armature.armatureData.parent.name,"Armature name: "+this._armature.name,"Animation name: "+i),null;var n=this._animations[i];if(5===t.fadeOutMode)for(var a=0,e=this._animationStates;a<e.length;a++){var o=e[a];if(o._fadeState<1&&o.layer===t.layer&&o.animationData===n)return o}0===this._animationStates.length?t.fadeInTime=0:t.fadeInTime<0&&(t.fadeInTime=n.fadeInTime),t.fadeOutTime<0&&(t.fadeOutTime=t.fadeInTime),t.timeScale<=-100&&(t.timeScale=1/n.scale),0<n.frameCount?(t.position<0?(t.position%=n.duration,t.position=n.duration-t.position):t.position===n.duration?t.position-=1e-6:t.position>n.duration&&(t.position%=n.duration),0<t.duration&&t.position+t.duration>n.duration&&(t.duration=n.duration-t.position),t.playTimes<0&&(t.playTimes=n.playTimes)):(t.playTimes=1,(t.position=0)<t.duration&&(t.duration=0)),0===t.duration&&(t.duration=-1),this._fadeOut(t);var s=BaseObject_1.BaseObject.borrowObject(AnimationState_1.AnimationState);if(s.init(this._armature,n,t),this._animationDirty=!0,this._armature._cacheFrameIndex=-1,0<this._animationStates.length){for(var r=!1,m=0,l=this._animationStates.length;m<l;++m){if(s.layer>this._animationStates[m].layer){r=!0,this._animationStates.splice(m,0,s);break}if(m!==l-1&&s.layer>this._animationStates[m+1].layer){r=!0,this._animationStates.splice(m+1,0,s);break}}r||this._animationStates.push(s)}else this._animationStates.push(s);for(var h=0,u=this._armature.getSlots();h<u.length;h++){var _=u[h].childArmature;null!==_&&_.inheritAnimation&&_.animation.hasAnimation(i)&&null===_.animation.getState(i)&&_.animation.fadeIn(i)}for(var f in n.animationTimelines){var p=this.fadeIn(f,0,1,s.layer,"",5);if(null!==p){var d=n.animationTimelines[f];p.actionEnabled=!1,p.resetToPose=!1,p.stop(),s.addState(p,d);var g=this._animationStates.indexOf(s),c=this._animationStates.indexOf(p);c<g&&(this._animationStates.splice(g,1),this._animationStates.splice(c,0,s))}}return this._lastAnimationState=s},t.prototype.play=function(t,i){if(void 0===t&&(t=null),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.fadeInTime=0,this._animationConfig.animation=null!==t?t:"",null!==t&&0<t.length)this.playConfig(this._animationConfig);else if(null===this._lastAnimationState){var n=this._armature.armatureData.defaultAnimation;null!==n&&(this._animationConfig.animation=n.name,this.playConfig(this._animationConfig))}else this._lastAnimationState.isPlaying||this._lastAnimationState.isCompleted?(this._animationConfig.animation=this._lastAnimationState.name,this.playConfig(this._animationConfig)):this._lastAnimationState.play();return this._lastAnimationState},t.prototype.fadeIn=function(t,i,n,a,e,o){return void 0===i&&(i=-1),void 0===n&&(n=-1),void 0===a&&(a=0),void 0===e&&(e=null),void 0===o&&(o=3),this._animationConfig.clear(),this._animationConfig.fadeOutMode=o,this._animationConfig.playTimes=n,this._animationConfig.layer=a,this._animationConfig.fadeInTime=i,this._animationConfig.animation=t,this._animationConfig.group=null!==e?e:"",this.playConfig(this._animationConfig)},t.prototype.gotoAndPlayByTime=function(t,i,n){return void 0===i&&(i=0),void 0===n&&(n=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=n,this._animationConfig.position=i,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t,this.playConfig(this._animationConfig)},t.prototype.gotoAndPlayByFrame=function(t,i,n){void 0===i&&(i=0),void 0===n&&(n=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=n,this._animationConfig.fadeInTime=0;var a=(this._animationConfig.animation=t)in this._animations?this._animations[t]:null;return null!==a&&(this._animationConfig.position=0<a.frameCount?a.duration*i/a.frameCount:0),this.playConfig(this._animationConfig)},t.prototype.gotoAndPlayByProgress=function(t,i,n){void 0===i&&(i=0),void 0===n&&(n=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=n,this._animationConfig.fadeInTime=0;var a=(this._animationConfig.animation=t)in this._animations?this._animations[t]:null;return null!==a&&(this._animationConfig.position=a.duration*(0<i?i:0)),this.playConfig(this._animationConfig)},t.prototype.gotoAndStopByTime=function(t,i){void 0===i&&(i=0);var n=this.gotoAndPlayByTime(t,i,1);return null!==n&&n.stop(),n},t.prototype.gotoAndStopByFrame=function(t,i){void 0===i&&(i=0);var n=this.gotoAndPlayByFrame(t,i,1);return null!==n&&n.stop(),n},t.prototype.gotoAndStopByProgress=function(t,i){void 0===i&&(i=0);var n=this.gotoAndPlayByProgress(t,i,1);return null!==n&&n.stop(),n},t.prototype.getBlendState=function(t,i,n){t in this._blendStates||(this._blendStates[t]={});var a=this._blendStates[t];i in a||((a[i]=BaseObject_1.BaseObject.borrowObject(AnimationState_1.BlendState)).target=n);return a[i]},t.prototype.getState=function(t,i){void 0===i&&(i=-1);for(var n=this._animationStates.length;n--;){var a=this._animationStates[n];if(a.name===t&&(i<0||a.layer===i))return a}return null},t.prototype.hasAnimation=function(t){return t in this._animations},t.prototype.getStates=function(){return this._animationStates},Object.defineProperty(t.prototype,"isPlaying",{get:function(){for(var t=0,i=this._animationStates;t<i.length;t++){if(i[t].isPlaying)return!0}return!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isCompleted",{get:function(){for(var t=0,i=this._animationStates;t<i.length;t++){if(!i[t].isCompleted)return!1}return 0<this._animationStates.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lastAnimationName",{get:function(){return null!==this._lastAnimationState?this._lastAnimationState.name:""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"animationNames",{get:function(){return this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"animations",{get:function(){return this._animations},set:function(t){if(this._animations!==t){for(var i in this._animationNames.length=0,this._animations)delete this._animations[i];for(var i in t)this._animationNames.push(i),this._animations[i]=t[i]}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"animationConfig",{get:function(){return this._animationConfig.clear(),this._animationConfig},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lastAnimationState",{get:function(){return this._lastAnimationState},enumerable:!0,configurable:!0}),t}(BaseObject_1.BaseObject);exports.Animation=Animation;