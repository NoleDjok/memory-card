"use strict";var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var a in i)i.hasOwnProperty(a)&&(t[a]=i[a])})(t,i)};return function(t,i){function a(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var TransformObject_1=require("./TransformObject"),Armature_1=require("./Armature"),BaseObject_1=require("../core/BaseObject"),DragonBones_1=require("../core/DragonBones"),ColorTransform_1=require("../geom/ColorTransform"),EventObject_1=require("../event/EventObject"),Matrix_1=require("../geom/Matrix"),DisplayFrame=function(i){function t(){var t=null!==i&&i.apply(this,arguments)||this;return t.deformVertices=[],t}return __extends(t,i),t.toString=function(){return"[class dragonBones.DisplayFrame]"},t.prototype._onClear=function(){this.rawDisplayData=null,this.displayData=null,this.textureData=null,this.display=null,this.deformVertices.length=0},t.prototype.updateDeformVertices=function(){if(null!==this.rawDisplayData&&0===this.deformVertices.length){var t;if(2===this.rawDisplayData.type)t=this.rawDisplayData.geometry;else{if(4!==this.rawDisplayData.type)return;t=this.rawDisplayData.geometry}var i=0;i=null!==t.weight?2*t.weight.count:2*t.data.intArray[t.offset+0],this.deformVertices.length=i;for(var a=0,e=this.deformVertices.length;a<e;++a)this.deformVertices[a]=0}},t.prototype.getGeometryData=function(){if(null!==this.displayData){if(2===this.displayData.type)return this.displayData.geometry;if(4===this.displayData.type)return this.displayData.geometry}if(null!==this.rawDisplayData){if(2===this.rawDisplayData.type)return this.rawDisplayData.geometry;if(4===this.rawDisplayData.type)return this.rawDisplayData.geometry}return null},t.prototype.getBoundingBox=function(){return null!==this.displayData&&3===this.displayData.type?this.displayData.boundingBox:null!==this.rawDisplayData&&3===this.rawDisplayData.type?this.rawDisplayData.boundingBox:null},t.prototype.getTextureData=function(){if(null!==this.displayData){if(0===this.displayData.type)return this.displayData.texture;if(2===this.displayData.type)return this.displayData.texture}if(null!==this.textureData)return this.textureData;if(null!==this.rawDisplayData){if(0===this.rawDisplayData.type)return this.rawDisplayData.texture;if(2===this.rawDisplayData.type)return this.rawDisplayData.texture}return null},t}(BaseObject_1.BaseObject);exports.DisplayFrame=DisplayFrame;var Slot=function(h){function d(){var t=null!==h&&h.apply(this,arguments)||this;return t._localMatrix=new Matrix_1.Matrix,t._colorTransform=new ColorTransform_1.ColorTransform,t._displayFrames=[],t._geometryBones=[],t._rawDisplay=null,t._meshDisplay=null,t._display=null,t}return __extends(d,h),d.prototype._onClear=function(){h.prototype._onClear.call(this);for(var t=[],i=0,a=this._displayFrames;i<a.length;i++){var e=a[i],r=e.display;r!==this._rawDisplay&&r!==this._meshDisplay&&t.indexOf(r)<0&&t.push(r),e.returnToPool()}for(var s=0,l=t;s<l.length;s++){var n=l[s];n instanceof Armature_1.Armature?n.dispose():this._disposeDisplay(n,!0)}null!==this._meshDisplay&&this._meshDisplay!==this._rawDisplay&&this._disposeDisplay(this._meshDisplay,!1),null!==this._rawDisplay&&this._disposeDisplay(this._rawDisplay,!1),this.displayController=null,this._displayDataDirty=!1,this._displayDirty=!1,this._geometryDirty=!1,this._textureDirty=!1,this._visibleDirty=!1,this._blendModeDirty=!1,this._zOrderDirty=!1,this._colorDirty=!1,this._verticesDirty=!1,this._transformDirty=!1,this._visible=!0,this._blendMode=0,this._displayIndex=-1,this._animationDisplayIndex=-1,this._zOrder=0,this._zIndex=0,this._cachedFrameIndex=-1,this._pivotX=0,this._pivotY=0,this._localMatrix.identity(),this._colorTransform.identity(),this._displayFrames.length=0,this._geometryBones.length=0,this._slotData=null,this._displayFrame=null,this._geometryData=null,this._boundingBoxData=null,this._textureData=null,this._rawDisplay=null,this._meshDisplay=null,this._display=null,this._childArmature=null,this._parent=null,this._cachedFrameIndices=null},d.prototype._hasDisplay=function(t){for(var i=0,a=this._displayFrames;i<a.length;i++){if(a[i].display===t)return!0}return!1},d.prototype._isBonesUpdate=function(){for(var t=0,i=this._geometryBones;t<i.length;t++){var a=i[t];if(null!==a&&a._childrenTransformDirty)return!0}return!1},d.prototype._updateAlpha=function(){var t=this._alpha*this._parent._globalAlpha;this._globalAlpha!==t&&(this._globalAlpha=t,this._colorDirty=!0)},d.prototype._updateDisplayData=function(){var t=this._displayFrame,i=this._geometryData,a=this._textureData,e=null,r=null;if(this._displayFrame=null,this._geometryData=null,this._boundingBoxData=null,this._textureData=null,0<=this._displayIndex&&this._displayIndex<this._displayFrames.length&&(this._displayFrame=this._displayFrames[this._displayIndex],e=this._displayFrame.rawDisplayData,r=this._displayFrame.displayData,this._geometryData=this._displayFrame.getGeometryData(),this._boundingBoxData=this._displayFrame.getBoundingBox(),this._textureData=this._displayFrame.getTextureData()),this._displayFrame!==t||this._geometryData!==i||this._textureData!==a){if(null===this._geometryData&&null!==this._textureData){var s=null!==r&&0===r.type?r:e,l=this._textureData.parent.scale*this._armature._armatureData.scale,n=this._textureData.frame;this._pivotX=s.pivot.x,this._pivotY=s.pivot.y;var h=null!==n?n:this._textureData.region,o=h.width,p=h.height;this._textureData.rotated&&null===n&&(o=h.height,p=h.width),this._pivotX*=o*l,this._pivotY*=p*l,null!==n&&(this._pivotX+=n.x*l,this._pivotY+=n.y*l),null!==e&&s!==e&&(e.transform.toMatrix(d._helpMatrix),d._helpMatrix.invert(),d._helpMatrix.transformPoint(0,0,d._helpPoint),this._pivotX-=d._helpPoint.x,this._pivotY-=d._helpPoint.y,s.transform.toMatrix(d._helpMatrix),d._helpMatrix.invert(),d._helpMatrix.transformPoint(0,0,d._helpPoint),this._pivotX+=d._helpPoint.x,this._pivotY+=d._helpPoint.y),DragonBones_1.DragonBones.yDown||(this._pivotY=(this._textureData.rotated?this._textureData.region.width:this._textureData.region.height)*l-this._pivotY)}else this._pivotX=0,this._pivotY=0;if(this.origin=null!==e?e.transform:null!==r?r.transform:null,null!==this.origin?this.global.copyFrom(this.origin).add(this.offset).toMatrix(this._localMatrix):this.global.copyFrom(this.offset).toMatrix(this._localMatrix),this._geometryData!==i)if(this._geometryDirty=!0,this._verticesDirty=!0,null!==this._geometryData){if(this._geometryBones.length=0,null!==this._geometryData.weight)for(var _=0,y=this._geometryData.weight.bones.length;_<y;++_){var u=this._armature.getBone(this._geometryData.weight.bones[_].name);this._geometryBones.push(u)}}else this._geometryBones.length=0,this._geometryData=null;this._textureDirty=this._textureData!==a,this._transformDirty=!0}},d.prototype._updateDisplay=function(){var t=null!==this._display?this._display:this._rawDisplay,i=this._childArmature;if(null!==this._displayFrame?(this._display=this._displayFrame.display,null!==this._display&&this._display instanceof Armature_1.Armature?(this._childArmature=this._display,this._display=this._childArmature.display):this._childArmature=null):(this._display=null,this._childArmature=null),(null!==this._display?this._display:this._rawDisplay)!==t&&(this._textureDirty=!0,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0,this._transformDirty=!0,this._onUpdateDisplay(),this._replaceDisplay(t)),this._childArmature!==i&&(null!==i&&(i._parent=null,i.clock=null,i.inheritAnimation&&i.animation.reset()),null!==this._childArmature&&((this._childArmature._parent=this)._childArmature.clock=this._armature.clock,this._childArmature.inheritAnimation))){if(0===this._childArmature.cacheFrameRate){var a=this._armature.cacheFrameRate;0!==a&&(this._childArmature.cacheFrameRate=a)}if(null!==this._displayFrame){var e=null,r=null!==this._displayFrame.displayData?this._displayFrame.displayData:this._displayFrame.rawDisplayData;if(null!==r&&1===r.type&&(e=r.actions),null!==e&&0<e.length)for(var s=0,l=e;s<l.length;s++){var n=l[s],h=BaseObject_1.BaseObject.borrowObject(EventObject_1.EventObject);EventObject_1.EventObject.actionDataToInstance(n,h,this._armature),(h.slot=this)._armature._bufferAction(h,!1)}else this._childArmature.animation.play()}}},d.prototype._updateGlobalTransformMatrix=function(t){var i=0===this._parent._boneData.type?this._parent.globalTransformMatrix:this._parent._getGlobalTransformMatrix(this.global.x,this.global.y);this.globalTransformMatrix.copyFrom(this._localMatrix),this.globalTransformMatrix.concat(i),t?this.global.fromMatrix(this.globalTransformMatrix):this._globalDirty=!0},d.prototype._setDisplayIndex=function(t,i){if(void 0===i&&(i=!1),i){if(this._animationDisplayIndex===t)return;this._animationDisplayIndex=t}this._displayIndex!==t&&(this._displayIndex=t<this._displayFrames.length?t:this._displayFrames.length-1,this._displayDataDirty=!0,this._displayDirty=this._displayIndex<0||this._display!==this._displayFrames[this._displayIndex].display)},d.prototype._setZOrder=function(t){return this._zOrder,this._zOrder=t,this._zOrderDirty=!0,this._zOrderDirty},d.prototype._setColor=function(t){return this._colorTransform.copyFrom(t),this._colorDirty=!0},d.prototype.init=function(t,i,a,e){if(null===this._slotData){this._slotData=t,this._colorDirty=!0,this._blendModeDirty=!0,this._blendMode=this._slotData.blendMode,this._zOrder=this._slotData.zOrder,this._zIndex=this._slotData.zIndex,this._alpha=this._slotData.alpha,this._colorTransform.copyFrom(this._slotData.color),this._rawDisplay=a,this._meshDisplay=e,this._armature=i;var r=this._armature.getBone(this._slotData.parent.name);null!==r&&(this._parent=r),this._armature._addSlot(this),this._initDisplay(this._rawDisplay,!1),this._rawDisplay!==this._meshDisplay&&this._initDisplay(this._meshDisplay,!1),this._onUpdateDisplay(),this._addDisplay()}},d.prototype.update=function(t){if(this._displayDataDirty&&(this._updateDisplayData(),this._displayDataDirty=!1),this._displayDirty&&(this._updateDisplay(),this._displayDirty=!1),(this._geometryDirty||this._textureDirty)&&(null!==this._display&&this._display!==this._rawDisplay&&this._display!==this._meshDisplay||this._updateFrame(),this._geometryDirty=!1,this._textureDirty=!1),null!==this._display){if(this._visibleDirty&&(this._updateVisible(),this._visibleDirty=!1),this._blendModeDirty&&(this._updateBlendMode(),this._blendModeDirty=!1),this._colorDirty&&(this._updateColor(),this._colorDirty=!1),this._zOrderDirty&&(this._updateZOrder(),this._zOrderDirty=!1),null!==this._geometryData&&this._display===this._meshDisplay){var i=null!==this._geometryData.weight,a=0!==this._parent._boneData.type;if((this._verticesDirty||i&&this._isBonesUpdate()||a&&this._parent._childrenTransformDirty)&&(this._verticesDirty=!1,this._updateMesh()),i||a)return}if(0<=t&&null!==this._cachedFrameIndices){var e=this._cachedFrameIndices[t];0<=e&&this._cachedFrameIndex===e?this._transformDirty=!1:0<=e?(this._transformDirty=!0,this._cachedFrameIndex=e):this._transformDirty||this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):0<=this._cachedFrameIndex?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}else(this._transformDirty||this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1);if(this._transformDirty){if(this._cachedFrameIndex<0){var r=0<=t;this._updateGlobalTransformMatrix(r),r&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);this._updateTransform(),this._transformDirty=!1}}},d.prototype.invalidUpdate=function(){this._displayDataDirty=!0,this._displayDirty=!0,this._transformDirty=!0},d.prototype.updateTransformAndMatrix=function(){this._transformDirty&&(this._updateGlobalTransformMatrix(!1),this._transformDirty=!1)},d.prototype.replaceRawDisplayData=function(t,i){if(void 0===i&&(i=-1),i<0)i=this._displayIndex<0?0:this._displayIndex;else if(i>=this._displayFrames.length)return;var a=this._displayFrames[i];if(a.rawDisplayData!==t){if(a.deformVertices.length=0,a.rawDisplayData=t,null===a.rawDisplayData){var e=this._armature._armatureData.defaultSkin;if(null!==e){var r=e.getDisplays(this._slotData.name);null!==r&&i<r.length&&(a.rawDisplayData=r[i])}}i===this._displayIndex&&(this._displayDataDirty=!0)}},d.prototype.replaceDisplayData=function(t,i){if(void 0===i&&(i=-1),i<0)i=this._displayIndex<0?0:this._displayIndex;else if(i>=this._displayFrames.length)return;var a=this._displayFrames[i];a.displayData!==t&&a.rawDisplayData!==t&&(a.displayData=t,i===this._displayIndex&&(this._displayDataDirty=!0))},d.prototype.replaceTextureData=function(t,i){if(void 0===i&&(i=-1),i<0)i=this._displayIndex<0?0:this._displayIndex;else if(i>=this._displayFrames.length)return;var a=this._displayFrames[i];a.textureData!==t&&(a.textureData=t,i===this._displayIndex&&(this._displayDataDirty=!0))},d.prototype.replaceDisplay=function(t,i){if(void 0===i&&(i=-1),i<0)i=this._displayIndex<0?0:this._displayIndex;else if(i>=this._displayFrames.length)return;var a=this._displayFrames[i];if(a.display!==t){var e=a.display;a.display=t,null===e||e===this._rawDisplay||e===this._meshDisplay||this._hasDisplay(e)||e instanceof Armature_1.Armature||this._disposeDisplay(e,!0),null===t||t===this._rawDisplay||t===this._meshDisplay||this._hasDisplay(e)||t instanceof Armature_1.Armature||this._initDisplay(t,!0),i===this._displayIndex&&(this._displayDirty=!0)}},d.prototype.containsPoint=function(t,i){return null!==this._boundingBoxData&&(this.updateTransformAndMatrix(),d._helpMatrix.copyFrom(this.globalTransformMatrix),d._helpMatrix.invert(),d._helpMatrix.transformPoint(t,i,d._helpPoint),this._boundingBoxData.containsPoint(d._helpPoint.x,d._helpPoint.y))},d.prototype.intersectsSegment=function(t,i,a,e,r,s,l){if(void 0===r&&(r=null),void 0===s&&(s=null),void 0===l&&(l=null),null===this._boundingBoxData)return 0;this.updateTransformAndMatrix(),d._helpMatrix.copyFrom(this.globalTransformMatrix),d._helpMatrix.invert(),d._helpMatrix.transformPoint(t,i,d._helpPoint),t=d._helpPoint.x,i=d._helpPoint.y,d._helpMatrix.transformPoint(a,e,d._helpPoint),a=d._helpPoint.x,e=d._helpPoint.y;var n=this._boundingBoxData.intersectsSegment(t,i,a,e,r,s,l);return 0<n&&(1===n||2===n?null!==r?(this.globalTransformMatrix.transformPoint(r.x,r.y,r),null!==s&&(s.x=r.x,s.y=r.y)):null!==s&&this.globalTransformMatrix.transformPoint(s.x,s.y,s):(null!==r&&this.globalTransformMatrix.transformPoint(r.x,r.y,r),null!==s&&this.globalTransformMatrix.transformPoint(s.x,s.y,s)),null!==l&&(this.globalTransformMatrix.transformPoint(Math.cos(l.x),Math.sin(l.x),d._helpPoint,!0),l.x=Math.atan2(d._helpPoint.y,d._helpPoint.x),this.globalTransformMatrix.transformPoint(Math.cos(l.y),Math.sin(l.y),d._helpPoint,!0),l.y=Math.atan2(d._helpPoint.y,d._helpPoint.x))),n},d.prototype.getDisplayFrameAt=function(t){return this._displayFrames[t]},Object.defineProperty(d.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible!==t&&(this._visible=t,this._updateVisible())},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"displayFrameCount",{get:function(){return this._displayFrames.length},set:function(t){var i=this._displayFrames.length;if(i<t){this._displayFrames.length=t;for(var a=i;a<t;++a)this._displayFrames[a]=BaseObject_1.BaseObject.borrowObject(DisplayFrame)}else if(t<i){for(a=i-1;a<t;--a)this.replaceDisplay(null,a),this._displayFrames[a].returnToPool();this._displayFrames.length=t}},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"displayIndex",{get:function(){return this._displayIndex},set:function(t){this._setDisplayIndex(t),this.update(-1)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"name",{get:function(){return this._slotData.name},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"displayList",{get:function(){for(var t=new Array,i=0,a=this._displayFrames;i<a.length;i++){var e=a[i];t.push(e.display)}return t},set:function(t){this.displayFrameCount=t.length;for(var i=0,a=0,e=t;a<e.length;a++){var r=e[a];this.replaceDisplay(r,i++)}},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"slotData",{get:function(){return this._slotData},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"boundingBoxData",{get:function(){return this._boundingBoxData},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"rawDisplay",{get:function(){return this._rawDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"meshDisplay",{get:function(){return this._meshDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"display",{get:function(){return this._display},set:function(t){this._display!==t&&(0===this._displayFrames.length&&(this.displayFrameCount=1,this._displayIndex=0),this.replaceDisplay(t,this._displayIndex))},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"childArmature",{get:function(){return this._childArmature},set:function(t){this._childArmature!==t&&(this.display=t)},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),d.prototype.getDisplay=function(){return this._display},d.prototype.setDisplay=function(t){this.display=t},d}(TransformObject_1.TransformObject);exports.Slot=Slot;