"use strict";var __extends=this&&this.__extends||function(){var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var BaseObject_1=require("../core/BaseObject"),Animation_1=require("../animation/Animation"),Armature=function(e){function y(){var t=null!==e&&e.apply(this,arguments)||this;return t._bones=[],t._slots=[],t._constraints=[],t._actions=[],t._animation=null,t._proxy=null,t._replaceTextureAtlasData=null,t._clock=null,t}return __extends(y,e),y.toString=function(){return"[class dragonBones.Armature]"},y._onSortSlots=function(t,e){return 1e3*t._zIndex+t._zOrder>1e3*e._zIndex+e._zOrder?1:-1},y.prototype._onClear=function(){null!==this._clock&&this._clock.remove(this);for(var t=0,e=this._bones;t<e.length;t++){e[t].returnToPool()}for(var n=0,r=this._slots;n<r.length;n++){r[n].returnToPool()}for(var i=0,a=this._constraints;i<a.length;i++){a[i].returnToPool()}for(var o=0,s=this._actions;o<s.length;o++){s[o].returnToPool()}null!==this._animation&&this._animation.returnToPool(),null!==this._proxy&&this._proxy.dbClear(),null!==this._replaceTextureAtlasData&&this._replaceTextureAtlasData.returnToPool(),this.inheritAnimation=!0,this.userData=null,this._lockUpdate=!1,this._slotsDirty=!0,this._zOrderDirty=!1,this._zIndexDirty=!1,this._alphaDirty=!0,this._flipX=!1,this._flipY=!1,this._cacheFrameIndex=-1,this._alpha=1,this._globalAlpha=1,this._bones.length=0,this._slots.length=0,this._constraints.length=0,this._actions.length=0,this._armatureData=null,this._animation=null,this._proxy=null,this._display=null,this._replaceTextureAtlasData=null,this._replacedTexture=null,this._dragonBones=null,this._clock=null,this._parent=null},y.prototype._sortZOrder=function(t,e){var n=this._armatureData.sortedSlots,r=null===t;if(this._zOrderDirty||!r){for(var i=0,a=n.length;i<a;++i){var o=r?i:t[e+i];if(!(o<0||a<=o)){var s=n[o],l=this.getSlot(s.name);null!==l&&l._setZOrder(i)}}this._slotsDirty=!0,this._zOrderDirty=!r}},y.prototype._addBone=function(t){this._bones.indexOf(t)<0&&this._bones.push(t)},y.prototype._addSlot=function(t){this._slots.indexOf(t)<0&&this._slots.push(t)},y.prototype._addConstraint=function(t){this._constraints.indexOf(t)<0&&this._constraints.push(t)},y.prototype._bufferAction=function(t,e){this._actions.indexOf(t)<0&&(e?this._actions.push(t):this._actions.unshift(t))},y.prototype.dispose=function(){null!==this._armatureData&&(this._lockUpdate=!0,this._dragonBones.bufferObject(this))},y.prototype.init=function(t,e,n,r){null===this._armatureData&&(this._armatureData=t,this._animation=BaseObject_1.BaseObject.borrowObject(Animation_1.Animation),this._proxy=e,this._display=n,this._dragonBones=r,this._proxy.dbInit(this),this._animation.init(this),this._animation.animations=this._armatureData.animations)},y.prototype.advanceTime=function(t){if(!this._lockUpdate)if(this._lockUpdate=!0,null!==this._armatureData)if(null!==this._armatureData.parent){var e=this._cacheFrameIndex;if(this._animation.advanceTime(t),this._slotsDirty||this._zIndexDirty){if(this._slots.sort(y._onSortSlots),this._zIndexDirty)for(var n=0,r=this._slots.length;n<r;++n)this._slots[n]._setZOrder(n);this._slotsDirty=!1,this._zIndexDirty=!1}if(this._alphaDirty){this._alphaDirty=!1,this._globalAlpha=this._alpha*(null!==this._parent?this._parent._globalAlpha:1);for(var i=0,a=this._bones;i<a.length;i++){a[i]._updateAlpha()}for(var o=0,s=this._slots;o<s.length;o++){(f=s[o])._updateAlpha()}}if(this._cacheFrameIndex<0||this._cacheFrameIndex!==e){n=0,r=0;for(n=0,r=this._bones.length;n<r;++n)this._bones[n].update(this._cacheFrameIndex);for(n=0,r=this._slots.length;n<r;++n)this._slots[n].update(this._cacheFrameIndex)}if(0<this._actions.length){for(var l=0,u=this._actions;l<u.length;l++){var h=u[l],c=h.actionData;if(null!==c)if(0===c.type)if(null!==h.slot)null!==(d=h.slot.childArmature)&&d.animation.fadeIn(c.name);else if(null!==h.bone)for(var _=0,p=this.getSlots();_<p.length;_++){var f,d;if((f=p[_]).parent===h.bone)null!==(d=f.childArmature)&&d.animation.fadeIn(c.name)}else this._animation.fadeIn(c.name);h.returnToPool()}this._actions.length=0}this._lockUpdate=!1,this._proxy.dbUpdate()}else console.warn("The armature data has been disposed.\nPlease make sure dispose armature before call factory.clear().");else console.warn("The armature has been disposed.")},y.prototype.invalidUpdate=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=!1),null!==t&&0<t.length){if(null!==(o=this.getBone(t))&&(o.invalidUpdate(),e))for(var n=0,r=this._slots;n<r.length;n++){(u=r[n]).parent===o&&u.invalidUpdate()}}else{for(var i=0,a=this._bones;i<a.length;i++){var o;(o=a[i]).invalidUpdate()}if(e)for(var s=0,l=this._slots;s<l.length;s++){var u;(u=l[s]).invalidUpdate()}}},y.prototype.containsPoint=function(t,e){for(var n=0,r=this._slots;n<r.length;n++){var i=r[n];if(i.containsPoint(t,e))return i}return null},y.prototype.intersectsSegment=function(t,e,n,r,i,a,o){void 0===i&&(i=null),void 0===a&&(a=null),void 0===o&&(o=null);for(var s=t===n,l=0,u=0,h=0,c=0,_=0,p=0,f=0,d=0,y=null,m=null,g=0,b=this._slots;g<b.length;g++){var v=b[g];if(0<v.intersectsSegment(t,e,n,r,i,a,o)){if(null===i&&null===a){y=v;break}var x;null!==i&&((x=s?i.y-e:i.x-t)<0&&(x=-x),(null===y||x<l)&&(l=x,h=i.x,c=i.y,y=v,o&&(f=o.x))),null!==a&&((x=a.x-t)<0&&(x=-x),(null===m||u<x)&&(u=x,_=a.x,p=a.y,m=v,null!==o&&(d=o.y)))}}return null!==y&&null!==i&&(i.x=h,i.y=c,null!==o&&(o.x=f)),null!==m&&null!==a&&(a.x=_,a.y=p,null!==o&&(o.y=d)),y},y.prototype.getBone=function(t){for(var e=0,n=this._bones;e<n.length;e++){var r=n[e];if(r.name===t)return r}return null},y.prototype.getBoneByDisplay=function(t){var e=this.getSlotByDisplay(t);return null!==e?e.parent:null},y.prototype.getSlot=function(t){for(var e=0,n=this._slots;e<n.length;e++){var r=n[e];if(r.name===t)return r}return null},y.prototype.getSlotByDisplay=function(t){if(null!==t)for(var e=0,n=this._slots;e<n.length;e++){var r=n[e];if(r.display===t)return r}return null},y.prototype.getBones=function(){return this._bones},y.prototype.getSlots=function(){return this._slots},Object.defineProperty(y.prototype,"flipX",{get:function(){return this._flipX},set:function(t){this._flipX!==t&&(this._flipX=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"flipY",{get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"cacheFrameRate",{get:function(){return this._armatureData.cacheFrameRate},set:function(t){if(this._armatureData.cacheFrameRate!==t){this._armatureData.cacheFrames(t);for(var e=0,n=this._slots;e<n.length;e++){var r=n[e].childArmature;null!==r&&(r.cacheFrameRate=t)}}},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"name",{get:function(){return this._armatureData.name},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"armatureData",{get:function(){return this._armatureData},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"proxy",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"eventDispatcher",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"display",{get:function(){return this._display},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"replacedTexture",{get:function(){return this._replacedTexture},set:function(t){if(this._replacedTexture!==t){null!==this._replaceTextureAtlasData&&(this._replaceTextureAtlasData.returnToPool(),this._replaceTextureAtlasData=null),this._replacedTexture=t;for(var e=0,n=this._slots;e<n.length;e++){var r=n[e];r.invalidUpdate(),r.update(-1)}}},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"clock",{get:function(){return this._clock},set:function(t){if(this._clock!==t){null!==this._clock&&this._clock.remove(this),this._clock=t,this._clock&&this._clock.add(this);for(var e=0,n=this._slots;e<n.length;e++){var r=n[e].childArmature;null!==r&&(r.clock=this._clock)}}},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),y.prototype.getDisplay=function(){return this._display},y}(BaseObject_1.BaseObject);exports.Armature=Armature;