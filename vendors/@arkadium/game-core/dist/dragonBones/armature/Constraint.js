"use strict";var __extends=this&&this.__extends||function(){var e=function(t,a){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,a){t.__proto__=a}||function(t,a){for(var r in a)a.hasOwnProperty(r)&&(t[r]=a[r])})(t,a)};return function(t,a){function r(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(r.prototype=a.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var BaseObject_1=require("../core/BaseObject"),Matrix_1=require("../geom/Matrix"),Transform_1=require("../geom/Transform"),Point_1=require("../geom/Point"),Constraint=function(t){function a(){return null!==t&&t.apply(this,arguments)||this}return __extends(a,t),a.prototype._onClear=function(){this._armature=null,this._target=null,this._root=null,this._bone=null},Object.defineProperty(a.prototype,"name",{get:function(){return this._constraintData.name},enumerable:!0,configurable:!0}),a._helpMatrix=new Matrix_1.Matrix,a._helpTransform=new Transform_1.Transform,a._helpPoint=new Point_1.Point,a}(BaseObject_1.BaseObject),IKConstraint=function(t){function a(){return null!==t&&t.apply(this,arguments)||this}return __extends(a,t),a.toString=function(){return"[class dragonBones.IKConstraint]"},a.prototype._onClear=function(){t.prototype._onClear.call(this),this._scaleEnabled=!1,this._bendPositive=!1,this._weight=1,this._constraintData=null},a.prototype._computeA=function(){var t=this._target.global,a=this._root.global,r=this._root.globalTransformMatrix,e=Math.atan2(t.y-a.y,t.x-a.x);a.scaleX<0&&(e+=Math.PI),a.rotation+=Transform_1.Transform.normalizeRadian(e-a.rotation)*this._weight,a.toMatrix(r)},a.prototype._computeB=function(){var t=this._bone._boneData.length,a=this._root,r=this._target.global,e=a.global,o=this._bone.global,i=this._bone.globalTransformMatrix,n=i.a*t,s=i.b*t,h=n*n+s*s,l=Math.sqrt(h),_=o.x-e.x,f=o.y-e.y,p=_*_+f*f,c=Math.sqrt(p),u=o.rotation,m=e.rotation,g=Math.atan2(f,_),b=(_=r.x-e.x)*_+(f=r.y-e.y)*f,v=Math.sqrt(b),y=0;if(l+c<=v||v+l<=c||v+c<=l)y=Math.atan2(r.y-e.y,r.x-e.x),l+c<=v||c<l&&(y+=Math.PI);else{var d=(p-h+b)/(2*b),M=Math.sqrt(p-d*d*b)/v,x=e.x+_*d,D=e.y+f*d,T=-f*M,C=_*M,P=!1,B=a.parent;if(null!==B){var V=B.globalTransformMatrix;P=V.a*V.d-V.b*V.c<0}P!==this._bendPositive?(o.x=x-T,o.y=D-C):(o.x=x+T,o.y=D+C),y=Math.atan2(o.y-e.y,o.x-e.x)}var q=Transform_1.Transform.normalizeRadian(y-g);e.rotation=m+q*this._weight,e.toMatrix(a.globalTransformMatrix);var O=g+q*this._weight;o.x=e.x+Math.cos(O)*c,o.y=e.y+Math.sin(O)*c;var w=Math.atan2(r.y-o.y,r.x-o.x);o.scaleX<0&&(w+=Math.PI),o.rotation=e.rotation+u-m+Transform_1.Transform.normalizeRadian(w-q-u)*this._weight,o.toMatrix(i)},a.prototype.init=function(t,a){if(null===this._constraintData){this._constraintData=t,this._armature=a,this._target=this._armature.getBone(this._constraintData.target.name),this._root=this._armature.getBone(this._constraintData.root.name),this._bone=null!==this._constraintData.bone?this._armature.getBone(this._constraintData.bone.name):null;var r=this._constraintData;this._scaleEnabled=r.scaleEnabled,this._bendPositive=r.bendPositive,this._weight=r.weight,this._root._hasConstraint=!0}},a.prototype.update=function(){this._root.updateByConstraint(),null!==this._bone?(this._bone.updateByConstraint(),this._computeB()):this._computeA()},a.prototype.invalidUpdate=function(){this._root.invalidUpdate(),null!==this._bone&&this._bone.invalidUpdate()},a}(exports.Constraint=Constraint);exports.IKConstraint=IKConstraint;var PathConstraint=function(a){function t(){var t=null!==a&&a.apply(this,arguments)||this;return t._bones=[],t._spaces=[],t._positions=[],t._curves=[],t._boneLengths=[],t._pathGlobalVertices=[],t._segments=[10],t}return __extends(t,a),t.toString=function(){return"[class dragonBones.PathConstraint]"},t.prototype._onClear=function(){a.prototype._onClear.call(this),this.dirty=!1,this.pathOffset=0,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=1,this.translateMix=1,this._pathSlot=null,this._bones.length=0,this._spaces.length=0,this._positions.length=0,this._curves.length=0,this._boneLengths.length=0,this._pathGlobalVertices.length=0},t.prototype._updatePathVertices=function(t){var a=this._armature,r=a.armatureData.parent,e=a.armatureData.scale,o=r.intArray,i=r.floatArray,n=t.offset,s=o[n+0],h=o[n+2];this._pathGlobalVertices.length=2*s;var l=t.weight;if(null!==l)for(var _=this._pathSlot._geometryBones,f=l.bones.length,p=l.offset,c=o[p+1],u=p+2+f,m=(T=0,0);T<s;T++){for(var g=0,b=0,v=0,y=o[u++];v<y;v++){var d=_[o[u++]];if(null!==d){d.updateByConstraint();D=d.globalTransformMatrix;var M=i[c++];P=i[c++]*e,B=i[c++]*e;g+=(D.a*P+D.c*B+D.tx)*M,b+=(D.b*P+D.d*B+D.ty)*M}}this._pathGlobalVertices[m++]=g,this._pathGlobalVertices[m++]=b}else{var x=this._pathSlot.parent;x.updateByConstraint();for(var D=x.globalTransformMatrix,T=0,C=h;T<s;T+=2){var P=i[C++]*e,B=i[C++]*e,V=D.a*P+D.c*B+D.tx,q=D.b*P+D.d*B+D.ty;this._pathGlobalVertices[T]=V,this._pathGlobalVertices[T+1]=q}}},t.prototype._computeVertices=function(t,a,r,e){for(var o=r,i=t;o<a;o+=2)e[o]=this._pathGlobalVertices[i++],e[o+1]=this._pathGlobalVertices[i++]},t.prototype._computeBezierCurve=function(t,a,r,e,o){var i=this._armature.armatureData.parent.intArray[t.geometry.offset+0],n=this._positions,s=this._spaces,h=t.closed,l=Array(),_=2*i,f=_/6,p=-1,c=this.position;n.length=3*a+2;var u=0;if(t.constantSpeed){h?(_+=2,l.length=i,this._computeVertices(2,_-4,0,l),this._computeVertices(0,2,_-4,l),l[_-2]=l[0],l[_-1]=l[1]):(f--,_-=4,l.length=_,this._computeVertices(2,_,0,l));for(var m,g,b,v,y,d,M,x,D=new Array(f),T=l[u=0],C=l[1],P=0,B=0,V=0,q=0,O=0,w=0,G=(K=0,2);K<f;K++,G+=6)P=l[G],B=l[G+1],V=l[G+2],q=l[G+3],y=2*(m=.1875*(T-2*P+V))+(b=.09375*(3*(P-V)-T+(O=l[G+4]))),d=2*(g=.1875*(C-2*B+q))+(v=.09375*(3*(B-q)-C+(w=l[G+5]))),M=.75*(P-T)+m+.16666667*b,x=.75*(B-C)+g+.16666667*v,u+=Math.sqrt(M*M+x*x),M+=y,x+=d,y+=b,d+=v,u+=Math.sqrt(M*M+x*x),M+=y,x+=d,u+=Math.sqrt(M*M+x*x),M+=y+b,x+=d+v,u+=Math.sqrt(M*M+x*x),D[K]=u,T=O,C=w;if(e&&(c*=u),o)for(K=0;K<a;K++)s[K]*=u;for(var I=this._segments,A=0,S=(K=0,k=0,X=0,0);K<a;K++,k+=3){var j=c+=s[K];if(h)(j%=u)<0&&(j+=u),X=0;else{if(j<0)continue;if(u<j)continue}for(;;X++){var L=D[X];if(!(L<j)){if(0===X)j/=L;else j=(j-(R=D[X-1]))/(L-R);break}}if(X!==p){var z=6*(p=X);for(T=l[z],C=l[z+1],P=l[z+2],B=l[z+3],V=l[z+4],q=l[z+5],y=2*(m=.03*(T-2*P+V))+(b=.006*(3*(P-V)-T+(O=l[z+6]))),d=2*(g=.03*(C-2*B+q))+(v=.006*(3*(B-q)-C+(w=l[z+7]))),M=.3*(P-T)+m+.16666667*b,x=.3*(B-C)+g+.16666667*v,A=Math.sqrt(M*M+x*x),I[0]=A,z=1;z<8;z++)M+=y,x+=d,y+=b,d+=v,A+=Math.sqrt(M*M+x*x),I[z]=A;M+=y,x+=d,A+=Math.sqrt(M*M+x*x),I[8]=A,M+=y+b,x+=d+v,A+=Math.sqrt(M*M+x*x),I[9]=A,S=0}for(j*=A;;S++){var E=I[S];if(!(E<j)){var R;if(0===S)j/=E;else j=S+(j-(R=I[S-1]))/(E-R);break}}this.addCurvePosition(.1*j,T,C,P,B,V,q,O,w,n,k,r)}}else{var U=t.curveLengths;if(u=U[f-=h?1:2],e&&(c*=u),o)for(var K=0;K<a;K++)s[K]*=u;l.length=8;for(var K=0,k=0,X=0;K<a;K++,k+=3){if(c+=s[K],h)(c%=u)<0&&(c+=u),X=0;else{if(c<0)continue;if(u<c)continue}for(var F=0;;X++){var H=U[X];if(!(H<c)){if(0===X)F=c/H;else{var J=U[X-1];F=(c-J)/(H-J)}break}}X!==p&&(p=X,h&&X===f?(this._computeVertices(_-4,4,0,l),this._computeVertices(0,4,4,l)):this._computeVertices(6*X+2,8,0,l)),this.addCurvePosition(F,l[0],l[1],l[2],l[3],l[4],l[5],l[6],l[7],n,k,r)}}},t.prototype.addCurvePosition=function(t,a,r,e,o,i,n,s,h,l,_,f){if(0===t)return l[_]=a,l[_+1]=r,void(l[_+2]=0);if(1===t)return l[_]=s,l[_+1]=h,void(l[_+2]=0);var p=1-t,c=p*p,u=t*t,m=c*p,g=c*t*3,b=p*u*3,v=t*u,y=m*a+g*e+b*i+v*s,d=m*r+g*o+b*n+v*h;l[_]=y,l[_+1]=d,l[_+2]=f?Math.atan2(d-(m*r+g*o+b*n),y-(m*a+g*e+b*i)):0},t.prototype.init=function(t,a){this._constraintData=t,this._armature=a;var r=t;this.pathOffset=r.pathDisplayData.geometry.offset,this.position=r.position,this.spacing=r.spacing,this.rotateOffset=r.rotateOffset,this.rotateMix=r.rotateMix,this.translateMix=r.translateMix,this._root=this._armature.getBone(r.root.name),this._target=this._armature.getBone(r.target.name),this._pathSlot=this._armature.getSlot(r.pathSlot.name);for(var e=0,o=r.bones.length;e<o;e++){var i=this._armature.getBone(r.bones[e].name);null!==i&&this._bones.push(i)}2===r.rotateMode&&(this._boneLengths.length=this._bones.length),this._root._hasConstraint=!0},t.prototype.update=function(){var t=this._pathSlot;if(null!==t._geometryData&&t._geometryData.offset===this.pathOffset){var a=this._constraintData,r=!1;if(this._root._childrenTransformDirty?(this._updatePathVertices(t._geometryData),r=!0):(t._verticesDirty||t._isBonesUpdate())&&(this._updatePathVertices(t._geometryData),r=!(t._verticesDirty=!1)),r||this.dirty){var e=a.positionMode,o=a.spacingMode,i=a.rotateMode,n=this._bones,s=0===o,h=2===i,l=0===i,_=n.length,f=l?_:_+1,p=this.spacing,c=this._spaces;if(c.length=f,h||s)for(var u=c[0]=0,m=f-1;u<m;u++){(V=n[u]).updateByConstraint();var g=V._boneData.length,b=g*(q=V.globalTransformMatrix).a,v=g*q.b,y=Math.sqrt(b*b+v*v);h&&(this._boneLengths[u]=y),c[u+1]=(g+p)*y/g}else for(u=0;u<f;u++)c[u]=p;this._computeBezierCurve(t._displayFrame.rawDisplayData,f,l,1===e,2===o);var d,M=this._positions,x=this.rotateOffset,D=M[0],T=M[1];if(0===x)d=1===i;else if(d=!1,null!==(V=t.parent))x*=0<(q=V.globalTransformMatrix).a*q.d-q.b*q.c?Transform_1.Transform.DEG_RAD:-Transform_1.Transform.DEG_RAD;for(var C=this.rotateMix,P=this.translateMix,B=(u=0,3);u<_;u++,B+=3){var V,q;(V=n[u]).updateByConstraint(),(q=V.globalTransformMatrix).tx+=(D-q.tx)*P,q.ty+=(T-q.ty)*P;var O=(b=M[B])-D,w=(v=M[B+1])-T;if(h){var G=this._boneLengths[u],I=(Math.sqrt(O*O+w*w)/G-1)*C+1;q.a*=I,q.b*=I}if(D=b,T=v,0<C){var A=q.a,S=q.b,j=q.c,L=q.d,z=void 0,E=void 0,R=void 0;if(z=l?M[B-1]:Math.atan2(w,O),z-=Math.atan2(S,A),d){E=Math.cos(z),R=Math.sin(z);var U=V._boneData.length;D+=(U*(E*A-R*S)-O)*C,T+=(U*(R*A+E*S)-w)*C}else z+=x;z>Transform_1.Transform.PI?z-=Transform_1.Transform.PI_D:z<-Transform_1.Transform.PI&&(z+=Transform_1.Transform.PI_D),z*=C,E=Math.cos(z),R=Math.sin(z),q.a=E*A-R*S,q.b=R*A+E*S,q.c=E*j-R*L,q.d=R*j+E*L}V.global.fromMatrix(q)}this.dirty=!1}}},t.prototype.invalidUpdate=function(){},t}(Constraint);exports.PathConstraint=PathConstraint;