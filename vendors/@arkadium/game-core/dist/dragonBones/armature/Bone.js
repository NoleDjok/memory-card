"use strict";var __extends=this&&this.__extends||function(){var o=function(t,r){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var a in r)r.hasOwnProperty(a)&&(t[a]=r[a])})(t,r)};return function(t,r){function a(){this.constructor=t}o(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var TransformObject_1=require("./TransformObject"),DragonBones_1=require("../core/DragonBones"),Transform_1=require("../geom/Transform"),Bone=function(r){function t(){var t=null!==r&&r.apply(this,arguments)||this;return t.animationPose=new Transform_1.Transform,t}return __extends(t,r),t.toString=function(){return"[class dragonBones.Bone]"},t.prototype._onClear=function(){r.prototype._onClear.call(this),this.offsetMode=1,this.animationPose.identity(),this._transformDirty=!1,this._childrenTransformDirty=!1,this._localDirty=!0,this._hasConstraint=!1,this._visible=!0,this._cachedFrameIndex=-1,this._boneData=null,this._parent=null,this._cachedFrameIndices=null},t.prototype._updateGlobalTransformMatrix=function(t){var r=this._boneData,a=this.global,o=this.globalTransformMatrix,e=this.origin,n=this.offset,i=this.animationPose,s=this._parent,l=this._armature.flipX,h=this._armature.flipY===DragonBones_1.DragonBones.yDown,_=null!==s,c=0;if(1===this.offsetMode?null!==e?(a.x=e.x+n.x+i.x,a.scaleX=e.scaleX*n.scaleX*i.scaleX,a.scaleY=e.scaleY*n.scaleY*i.scaleY,DragonBones_1.DragonBones.yDown?(a.y=e.y+n.y+i.y,a.skew=e.skew+n.skew+i.skew,a.rotation=e.rotation+n.rotation+i.rotation):(a.y=e.y-n.y+i.y,a.skew=e.skew-n.skew+i.skew,a.rotation=e.rotation-n.rotation+i.rotation)):(a.copyFrom(n),DragonBones_1.DragonBones.yDown||(a.y=-a.y,a.skew=-a.skew,a.rotation=-a.rotation),a.add(i)):0===this.offsetMode?null!==e?a.copyFrom(e).add(i):a.copyFrom(i):(_=!1,a.copyFrom(n),DragonBones_1.DragonBones.yDown||(a.y=-a.y,a.skew=-a.skew,a.rotation=-a.rotation)),_){var f=1===s._boneData.type,y=f?s._bone:null,u=f?s._getGlobalTransformMatrix(a.x,a.y):s.globalTransformMatrix;if(!r.inheritScale||f&&null===y){if(r.inheritTranslation){var p=a.x,m=a.y;a.x=u.a*p+u.c*m+u.tx,a.y=u.b*p+u.d*m+u.ty}else l&&(a.x=-a.x),h&&(a.y=-a.y);r.inheritRotation?(s.updateGlobalTransform(),c=s.global.scaleX<0?a.rotation+s.global.rotation+Math.PI:a.rotation+s.global.rotation,u.a*u.d-u.b*u.c<0&&(c-=2*a.rotation,(l!==h||r.inheritReflection)&&(a.skew+=Math.PI),DragonBones_1.DragonBones.yDown||(a.skew=-a.skew)),a.rotation=c):(l||h)&&(l&&h?c=a.rotation+Math.PI:(c=l?Math.PI-a.rotation:-a.rotation,a.skew+=Math.PI),a.rotation=c),a.toMatrix(o)}else f?(r.inheritRotation&&(a.rotation+=s.global.rotation),y.updateGlobalTransform(),a.scaleX*=y.global.scaleX,a.scaleY*=y.global.scaleY,u.transformPoint(a.x,a.y,a),a.toMatrix(o),r.inheritTranslation?(a.x=o.tx,a.y=o.ty):(o.tx=a.x,o.ty=a.y)):(r.inheritRotation||(s.updateGlobalTransform(),c=l&&h?a.rotation-(s.global.rotation+Math.PI):l?a.rotation+s.global.rotation+Math.PI:h?a.rotation+s.global.rotation:a.rotation-s.global.rotation,a.rotation=c),a.toMatrix(o),o.concat(u),r.inheritTranslation?(a.x=o.tx,a.y=o.ty):(o.tx=a.x,o.ty=a.y),t?a.fromMatrix(o):this._globalDirty=!0)}else(l||h)&&(l&&(a.x=-a.x),h&&(a.y=-a.y),l&&h?c=a.rotation+Math.PI:(c=l?Math.PI-a.rotation:-a.rotation,a.skew+=Math.PI),a.rotation=c),a.toMatrix(o)},t.prototype._updateAlpha=function(){null!==this._parent?this._globalAlpha=this._alpha*this._parent._globalAlpha:this._globalAlpha=this._alpha*this._armature._globalAlpha},t.prototype.init=function(t,r){null===this._boneData&&(this._boneData=t,this._armature=r,this._alpha=this._boneData.alpha,null!==this._boneData.parent&&(this._parent=this._armature.getBone(this._boneData.parent.name)),this._armature._addBone(this),this.origin=this._boneData.transform)},t.prototype.update=function(t){if(0<=t&&null!==this._cachedFrameIndices){var r=this._cachedFrameIndices[t];if(0<=r&&this._cachedFrameIndex===r)this._transformDirty=!1;else if(0<=r)this._transformDirty=!0,this._cachedFrameIndex=r;else{if(this._hasConstraint)for(var a=0,o=this._armature._constraints;a<o.length;a++){(i=o[a])._root===this&&i.update()}this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):0<=this._cachedFrameIndex?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var e=0,n=this._armature._constraints;e<n.length;e++){var i;(i=n[e])._root===this&&i.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty)if(this._transformDirty=!1,this._childrenTransformDirty=!0,this._cachedFrameIndex<0){var s=0<=t;this._localDirty&&this._updateGlobalTransformMatrix(s),s&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},t.prototype.updateByConstraint=function(){this._localDirty&&(this._localDirty=!1,(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&this._updateGlobalTransformMatrix(!0),this._transformDirty=!0)},t.prototype.invalidUpdate=function(){this._transformDirty=!0},t.prototype.contains=function(t){if(t===this)return!1;for(var r=t;r!==this&&null!==r;)r=r.parent;return r===this},Object.defineProperty(t.prototype,"boneData",{get:function(){return this._boneData},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return this._visible},set:function(t){if(this._visible!==t){this._visible=t;for(var r=0,a=this._armature.getSlots();r<a.length;r++){var o=a[r];o.parent===this&&o._updateVisible()}}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return this._boneData.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),t}(TransformObject_1.TransformObject);exports.Bone=Bone;