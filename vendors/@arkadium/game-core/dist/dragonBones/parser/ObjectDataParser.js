"use strict";var __extends=this&&this.__extends||function(){var t=function(a,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,r){a.__proto__=r}||function(a,r){for(var e in r)r.hasOwnProperty(e)&&(a[e]=r[e])})(a,r)};return function(a,r){function e(){this.constructor=a}t(a,r),a.prototype=null===r?Object.create(r):(e.prototype=r.prototype,new e)}}();Object.defineProperty(exports,"__esModule",{value:!0});var DataParser_1=require("./DataParser"),TextureAtlasData_1=require("../model/TextureAtlasData"),DragonBonesData_1=require("../model/DragonBonesData"),BaseObject_1=require("../core/BaseObject"),DisplayData_1=require("../model/DisplayData"),ColorTransform_1=require("../geom/ColorTransform"),Transform_1=require("../geom/Transform"),UserData_1=require("../model/UserData"),ArmatureData_1=require("../model/ArmatureData"),AnimationData_1=require("../model/AnimationData"),BoundingBoxData_1=require("../model/BoundingBoxData"),SkinData_1=require("../model/SkinData"),ConstraintData_1=require("../model/ConstraintData"),CanvasData_1=require("../model/CanvasData"),Matrix_1=require("../geom/Matrix"),Point_1=require("../geom/Point"),ObjectDataParser=function(r){function H(){var a=null!==r&&r.apply(this,arguments)||this;return a._rawTextureAtlasIndex=0,a._rawBones=[],a._data=null,a._armature=null,a._bone=null,a._geometry=null,a._slot=null,a._skin=null,a._mesh=null,a._animation=null,a._timeline=null,a._rawTextureAtlases=null,a._frameValueType=0,a._defaultColorOffset=-1,a._prevClockwise=0,a._prevRotation=0,a._frameDefaultValue=0,a._frameValueScale=1,a._helpMatrixA=new Matrix_1.Matrix,a._helpMatrixB=new Matrix_1.Matrix,a._helpTransform=new Transform_1.Transform,a._helpColorTransform=new ColorTransform_1.ColorTransform,a._helpPoint=new Point_1.Point,a._helpArray=[],a._intArray=[],a._floatArray=[],a._frameIntArray=[],a._frameFloatArray=[],a._frameArray=[],a._timelineArray=[],a._colorArray=[],a._cacheRawMeshes=[],a._cacheMeshes=[],a._actionFrames=[],a._weightSlotPose={},a._weightBonePoses={},a._cacheBones={},a._slotChildActions={},a}return __extends(H,r),H._getBoolean=function(a,r,e){if(r in a){var t=a[r],s=typeof t;if("boolean"===s)return t;if("string"!==s)return!!t;switch(t){case"0":case"NaN":case"":case"false":case"null":case"undefined":return!1;default:return!0}}return e},H._getNumber=function(a,r,e){if(r in a){var t=a[r];return null===t||"NaN"===t?e:+t||0}return e},H._getString=function(a,r,e){if(r in a){var t=a[r];return"string"===typeof t?t:String(t)}return e},H.prototype._getCurvePoint=function(a,r,e,t,s,i,n,_,o,l){var h=1-o,D=h*h,P=o*o,m=h*D,f=3*o*D,A=3*h*P,u=o*P;l.x=m*a+f*e+A*s+u*n,l.y=m*r+f*t+A*i+u*_},H.prototype._samplingEasingCurve=function(a,r){var e=a.length;if(e%3==1){for(var t=-2,s=0,i=r.length;s<i;++s){for(var n=(s+1)/(i+1);(t+6<e?a[t+6]:1)<n;)t+=6;for(var _=0<=t&&t+6<e,o=_?a[t]:0,l=_?a[t+1]:0,h=a[t+2],D=a[t+3],P=a[t+4],m=a[t+5],f=_?a[t+6]:1,A=_?a[t+7]:1,u=0,g=1;1e-4<g-u;){var y=.5*(g+u);this._getCurvePoint(o,l,h,D,P,m,f,A,y,this._helpPoint),0<n-this._helpPoint.x?u=y:g=y}r[s]=this._helpPoint.y}return!0}for(t=0,s=0,i=r.length;s<i;++s){for(n=(s+1)/(i+1);a[t+6]<n;)t+=6;for(o=a[t],l=a[t+1],h=a[t+2],D=a[t+3],P=a[t+4],m=a[t+5],f=a[t+6],A=a[t+7],u=0,g=1;1e-4<g-u;){y=.5*(g+u);this._getCurvePoint(o,l,h,D,P,m,f,A,y,this._helpPoint),0<n-this._helpPoint.x?u=y:g=y}r[s]=this._helpPoint.y}return!1},H.prototype._parseActionDataInFrame=function(a,r,e,t){DataParser_1.DataParser.EVENT in a&&this._mergeActionFrame(a[DataParser_1.DataParser.EVENT],r,10,e,t),DataParser_1.DataParser.SOUND in a&&this._mergeActionFrame(a[DataParser_1.DataParser.SOUND],r,11,e,t),DataParser_1.DataParser.ACTION in a&&this._mergeActionFrame(a[DataParser_1.DataParser.ACTION],r,0,e,t),DataParser_1.DataParser.EVENTS in a&&this._mergeActionFrame(a[DataParser_1.DataParser.EVENTS],r,10,e,t),DataParser_1.DataParser.ACTIONS in a&&this._mergeActionFrame(a[DataParser_1.DataParser.ACTIONS],r,0,e,t)},H.prototype._mergeActionFrame=function(a,r,e,t,s){for(var i=this._armature.actions.length,n=this._parseActionData(a,e,t,s),_=0,o=null,l=0,h=n;l<h.length;l++){var D=h[l];this._armature.addAction(D,!1)}0===this._actionFrames.length&&((o=new ActionFrame).frameStart=0,this._actionFrames.push(o),o=null);for(var P=0,m=this._actionFrames;P<m.length;P++){var f=m[P];if(f.frameStart===r){o=f;break}if(f.frameStart>r)break;_++}null===o&&((o=new ActionFrame).frameStart=r,this._actionFrames.splice(_,0,o));for(var A=0;A<n.length;++A)o.actions.push(i+A)},H.prototype._parseArmature=function(a,r){var e=BaseObject_1.BaseObject.borrowObject(ArmatureData_1.ArmatureData);if(e.name=H._getString(a,DataParser_1.DataParser.NAME,""),e.frameRate=H._getNumber(a,DataParser_1.DataParser.FRAME_RATE,this._data.frameRate),e.scale=r,DataParser_1.DataParser.TYPE in a&&"string"==typeof a[DataParser_1.DataParser.TYPE]?e.type=DataParser_1.DataParser._getArmatureType(a[DataParser_1.DataParser.TYPE]):e.type=H._getNumber(a,DataParser_1.DataParser.TYPE,0),0===e.frameRate&&(e.frameRate=24),this._armature=e,DataParser_1.DataParser.CANVAS in a){var t=a[DataParser_1.DataParser.CANVAS],s=BaseObject_1.BaseObject.borrowObject(CanvasData_1.CanvasData);DataParser_1.DataParser.COLOR in t?s.hasBackground=!0:s.hasBackground=!1,s.color=H._getNumber(t,DataParser_1.DataParser.COLOR,0),s.x=H._getNumber(t,DataParser_1.DataParser.X,0)*e.scale,s.y=H._getNumber(t,DataParser_1.DataParser.Y,0)*e.scale,s.width=H._getNumber(t,DataParser_1.DataParser.WIDTH,0)*e.scale,s.height=H._getNumber(t,DataParser_1.DataParser.HEIGHT,0)*e.scale,e.canvas=s}if(DataParser_1.DataParser.AABB in a){var i=a[DataParser_1.DataParser.AABB];e.aabb.x=H._getNumber(i,DataParser_1.DataParser.X,0)*e.scale,e.aabb.y=H._getNumber(i,DataParser_1.DataParser.Y,0)*e.scale,e.aabb.width=H._getNumber(i,DataParser_1.DataParser.WIDTH,0)*e.scale,e.aabb.height=H._getNumber(i,DataParser_1.DataParser.HEIGHT,0)*e.scale}if(DataParser_1.DataParser.BONE in a)for(var n=0,_=a[DataParser_1.DataParser.BONE];n<_.length;n++){var o=_[n],l=H._getString(o,DataParser_1.DataParser.PARENT,""),h=this._parseBone(o);if(0<l.length){var D=e.getBone(l);null!==D?h.parent=D:(l in this._cacheBones||(this._cacheBones[l]=[]),this._cacheBones[l].push(h))}if(h.name in this._cacheBones){for(var P=0,m=this._cacheBones[h.name];P<m.length;P++){m[P].parent=h}delete this._cacheBones[h.name]}e.addBone(h),this._rawBones.push(h)}if(DataParser_1.DataParser.IK in a)for(var f=0,A=a[DataParser_1.DataParser.IK];f<A.length;f++){var u=A[f];(N=this._parseIKConstraint(u))&&e.addConstraint(N)}if(e.sortBones(),DataParser_1.DataParser.SLOT in a)for(var g=0,y=0,p=a[DataParser_1.DataParser.SLOT];y<p.length;y++){var c=p[y];e.addSlot(this._parseSlot(c,g++))}if(DataParser_1.DataParser.SKIN in a)for(var T=0,E=a[DataParser_1.DataParser.SKIN];T<E.length;T++){var b=E[T];e.addSkin(this._parseSkin(b))}if(DataParser_1.DataParser.PATH_CONSTRAINT in a)for(var S=0,O=a[DataParser_1.DataParser.PATH_CONSTRAINT];S<O.length;S++){var N,v=O[S];(N=this._parsePathConstraint(v))&&e.addConstraint(N)}for(var d=0,F=this._cacheRawMeshes.length;d<F;++d){var B=this._cacheRawMeshes[d],I=H._getString(B,DataParser_1.DataParser.SHARE,"");if(0!==I.length){var R=H._getString(B,DataParser_1.DataParser.SKIN,DataParser_1.DataParser.DEFAULT_NAME);0===R.length&&(R=DataParser_1.DataParser.DEFAULT_NAME);var M=e.getMesh(R,"",I);if(null!==M)this._cacheMeshes[d].geometry.shareFrom(M.geometry)}}if(DataParser_1.DataParser.ANIMATION in a)for(var w=0,C=a[DataParser_1.DataParser.ANIMATION];w<C.length;w++){var L=C[w],x=this._parseAnimation(L);e.addAnimation(x)}if(DataParser_1.DataParser.DEFAULT_ACTIONS in a)for(var j=0,V=this._parseActionData(a[DataParser_1.DataParser.DEFAULT_ACTIONS],0,null,null);j<V.length;j++){var k=V[j];if(e.addAction(k,!0),0===k.type)null!==(x=e.getAnimation(k.name))&&(e.defaultAnimation=x)}if(DataParser_1.DataParser.ACTIONS in a)for(var Y=0,U=this._parseActionData(a[DataParser_1.DataParser.ACTIONS],0,null,null);Y<U.length;Y++){k=U[Y];e.addAction(k,!1)}for(var G in this._rawBones.length=0,this._cacheRawMeshes.length=0,this._cacheMeshes.length=0,this._armature=null,this._weightSlotPose)delete this._weightSlotPose[G];for(var G in this._weightBonePoses)delete this._weightBonePoses[G];for(var G in this._cacheBones)delete this._cacheBones[G];for(var G in this._slotChildActions)delete this._slotChildActions[G];return e},H.prototype._parseBone=function(a){if(0===(DataParser_1.DataParser.TYPE in a&&"string"==typeof a[DataParser_1.DataParser.TYPE]?DataParser_1.DataParser._getBoneType(a[DataParser_1.DataParser.TYPE]):H._getNumber(a,DataParser_1.DataParser.TYPE,0))){var r=this._armature.scale,e=BaseObject_1.BaseObject.borrowObject(ArmatureData_1.BoneData);return e.inheritTranslation=H._getBoolean(a,DataParser_1.DataParser.INHERIT_TRANSLATION,!0),e.inheritRotation=H._getBoolean(a,DataParser_1.DataParser.INHERIT_ROTATION,!0),e.inheritScale=H._getBoolean(a,DataParser_1.DataParser.INHERIT_SCALE,!0),e.inheritReflection=H._getBoolean(a,DataParser_1.DataParser.INHERIT_REFLECTION,!0),e.length=H._getNumber(a,DataParser_1.DataParser.LENGTH,0)*r,e.alpha=H._getNumber(a,DataParser_1.DataParser.ALPHA,1),e.name=H._getString(a,DataParser_1.DataParser.NAME,""),DataParser_1.DataParser.TRANSFORM in a&&this._parseTransform(a[DataParser_1.DataParser.TRANSFORM],e.transform,r),e}var t=BaseObject_1.BaseObject.borrowObject(ArmatureData_1.SurfaceData);return t.alpha=H._getNumber(a,DataParser_1.DataParser.ALPHA,1),t.name=H._getString(a,DataParser_1.DataParser.NAME,""),t.segmentX=H._getNumber(a,DataParser_1.DataParser.SEGMENT_X,0),t.segmentY=H._getNumber(a,DataParser_1.DataParser.SEGMENT_Y,0),this._parseGeometry(a,t.geometry),t},H.prototype._parseIKConstraint=function(a){var r=this._armature.getBone(H._getString(a,DataParser_1.DataParser.BONE,""));if(null===r)return null;var e=this._armature.getBone(H._getString(a,DataParser_1.DataParser.TARGET,""));if(null===e)return null;var t=H._getNumber(a,DataParser_1.DataParser.CHAIN,0),s=BaseObject_1.BaseObject.borrowObject(ConstraintData_1.IKConstraintData);return s.scaleEnabled=H._getBoolean(a,DataParser_1.DataParser.SCALE,!1),s.bendPositive=H._getBoolean(a,DataParser_1.DataParser.BEND_POSITIVE,!0),s.weight=H._getNumber(a,DataParser_1.DataParser.WEIGHT,1),s.name=H._getString(a,DataParser_1.DataParser.NAME,""),s.type=0,s.target=e,0<t&&null!==r.parent?(s.root=r.parent,s.bone=r):(s.root=r,s.bone=null),s},H.prototype._parsePathConstraint=function(a){var r=this._armature.getSlot(H._getString(a,DataParser_1.DataParser.TARGET,""));if(null===r)return null;var e=this._armature.defaultSkin;if(null===e)return null;var t=e.getDisplay(r.name,H._getString(a,DataParser_1.DataParser.TARGET_DISPLAY,r.name));if(null===t||!(t instanceof DisplayData_1.PathDisplayData))return null;var s=a[DataParser_1.DataParser.BONES];if(null===s||0===s.length)return null;var i=BaseObject_1.BaseObject.borrowObject(ConstraintData_1.PathConstraintData);i.name=H._getString(a,DataParser_1.DataParser.NAME,""),i.type=1,i.pathSlot=r,i.pathDisplayData=t,i.target=r.parent,i.positionMode=DataParser_1.DataParser._getPositionMode(H._getString(a,DataParser_1.DataParser.POSITION_MODE,"")),i.spacingMode=DataParser_1.DataParser._getSpacingMode(H._getString(a,DataParser_1.DataParser.SPACING_MODE,"")),i.rotateMode=DataParser_1.DataParser._getRotateMode(H._getString(a,DataParser_1.DataParser.ROTATE_MODE,"")),i.position=H._getNumber(a,DataParser_1.DataParser.POSITION,0),i.spacing=H._getNumber(a,DataParser_1.DataParser.SPACING,0),i.rotateOffset=H._getNumber(a,DataParser_1.DataParser.ROTATE_OFFSET,0),i.rotateMix=H._getNumber(a,DataParser_1.DataParser.ROTATE_MIX,1),i.translateMix=H._getNumber(a,DataParser_1.DataParser.TRANSLATE_MIX,1);for(var n=0,_=s;n<_.length;n++){var o=_[n],l=this._armature.getBone(o);null!==l&&(i.AddBone(l),null===i.root&&(i.root=l))}return i},H.prototype._parseSlot=function(a,r){var e=BaseObject_1.BaseObject.borrowObject(ArmatureData_1.SlotData);return e.displayIndex=H._getNumber(a,DataParser_1.DataParser.DISPLAY_INDEX,0),e.zOrder=r,e.zIndex=H._getNumber(a,DataParser_1.DataParser.Z_INDEX,0),e.alpha=H._getNumber(a,DataParser_1.DataParser.ALPHA,1),e.name=H._getString(a,DataParser_1.DataParser.NAME,""),e.parent=this._armature.getBone(H._getString(a,DataParser_1.DataParser.PARENT,"")),DataParser_1.DataParser.BLEND_MODE in a&&"string"==typeof a[DataParser_1.DataParser.BLEND_MODE]?e.blendMode=DataParser_1.DataParser._getBlendMode(a[DataParser_1.DataParser.BLEND_MODE]):e.blendMode=H._getNumber(a,DataParser_1.DataParser.BLEND_MODE,0),DataParser_1.DataParser.COLOR in a?(e.color=ArmatureData_1.SlotData.createColor(),this._parseColorTransform(a[DataParser_1.DataParser.COLOR],e.color)):e.color=ArmatureData_1.SlotData.DEFAULT_COLOR,DataParser_1.DataParser.ACTIONS in a&&(this._slotChildActions[e.name]=this._parseActionData(a[DataParser_1.DataParser.ACTIONS],0,null,null)),e},H.prototype._parseSkin=function(a){var r=BaseObject_1.BaseObject.borrowObject(SkinData_1.SkinData);if(r.name=H._getString(a,DataParser_1.DataParser.NAME,DataParser_1.DataParser.DEFAULT_NAME),0===r.name.length&&(r.name=DataParser_1.DataParser.DEFAULT_NAME),DataParser_1.DataParser.SLOT in a){var e=a[DataParser_1.DataParser.SLOT];this._skin=r;for(var t=0,s=e;t<s.length;t++){var i=s[t],n=H._getString(i,DataParser_1.DataParser.NAME,""),_=this._armature.getSlot(n);if(null!==_){if(this._slot=_,DataParser_1.DataParser.DISPLAY in i)for(var o=0,l=i[DataParser_1.DataParser.DISPLAY];o<l.length;o++){var h=l[o];h?r.addDisplay(n,this._parseDisplay(h)):r.addDisplay(n,null)}this._slot=null}}this._skin=null}return r},H.prototype._parseDisplay=function(a){var r=H._getString(a,DataParser_1.DataParser.NAME,""),e=H._getString(a,DataParser_1.DataParser.PATH,""),t=0,s=null;switch(t=DataParser_1.DataParser.TYPE in a&&"string"==typeof a[DataParser_1.DataParser.TYPE]?DataParser_1.DataParser._getDisplayType(a[DataParser_1.DataParser.TYPE]):H._getNumber(a,DataParser_1.DataParser.TYPE,t)){case 0:var i=s=BaseObject_1.BaseObject.borrowObject(DisplayData_1.ImageDisplayData);i.name=r,i.path=0<e.length?e:r,this._parsePivot(a,i);break;case 1:var n=s=BaseObject_1.BaseObject.borrowObject(DisplayData_1.ArmatureDisplayData);if(n.name=r,n.path=0<e.length?e:r,n.inheritAnimation=!0,DataParser_1.DataParser.ACTIONS in a)for(var _=0,o=this._parseActionData(a[DataParser_1.DataParser.ACTIONS],0,null,null);_<o.length;_++){var l=o[_];n.addAction(l)}else if(this._slot.name in this._slotChildActions){var h=this._skin.getDisplays(this._slot.name);if(null===h?0===this._slot.displayIndex:this._slot.displayIndex===h.length){for(var D=0,P=this._slotChildActions[this._slot.name];D<P.length;D++){l=P[D];n.addAction(l)}delete this._slotChildActions[this._slot.name]}}break;case 2:var m=s=BaseObject_1.BaseObject.borrowObject(DisplayData_1.MeshDisplayData);m.geometry.inheritDeform=H._getBoolean(a,DataParser_1.DataParser.INHERIT_DEFORM,!0),m.name=r,m.path=0<e.length?e:r,DataParser_1.DataParser.SHARE in a?(m.geometry.data=this._data,this._cacheRawMeshes.push(a),this._cacheMeshes.push(m)):this._parseMesh(a,m);break;case 3:var f=this._parseBoundingBox(a);if(null!==f){var A=s=BaseObject_1.BaseObject.borrowObject(DisplayData_1.BoundingBoxDisplayData);A.name=r,A.path=0<e.length?e:r,A.boundingBox=f}break;case 4:var u=a[DataParser_1.DataParser.LENGTHS],g=s=BaseObject_1.BaseObject.borrowObject(DisplayData_1.PathDisplayData);g.closed=H._getBoolean(a,DataParser_1.DataParser.CLOSED,!1),g.constantSpeed=H._getBoolean(a,DataParser_1.DataParser.CONSTANT_SPEED,!1),g.name=r,g.path=0<e.length?e:r,g.curveLengths.length=u.length;for(var y=0,p=u.length;y<p;++y)g.curveLengths[y]=u[y];this._parsePath(a,g)}return null!==s&&DataParser_1.DataParser.TRANSFORM in a&&this._parseTransform(a[DataParser_1.DataParser.TRANSFORM],s.transform,this._armature.scale),s},H.prototype._parsePath=function(a,r){this._parseGeometry(a,r.geometry)},H.prototype._parsePivot=function(a,r){if(DataParser_1.DataParser.PIVOT in a){var e=a[DataParser_1.DataParser.PIVOT];r.pivot.x=H._getNumber(e,DataParser_1.DataParser.X,0),r.pivot.y=H._getNumber(e,DataParser_1.DataParser.Y,0)}else r.pivot.x=.5,r.pivot.y=.5},H.prototype._parseMesh=function(a,r){if(this._parseGeometry(a,r.geometry),DataParser_1.DataParser.WEIGHTS in a){var e=a[DataParser_1.DataParser.SLOT_POSE],t=a[DataParser_1.DataParser.BONE_POSE],s=this._skin.name+"_"+this._slot.name+"_"+r.name;this._weightSlotPose[s]=e,this._weightBonePoses[s]=t}},H.prototype._parseBoundingBox=function(a){var r=null,e=0;switch(e=DataParser_1.DataParser.SUB_TYPE in a&&"string"==typeof a[DataParser_1.DataParser.SUB_TYPE]?DataParser_1.DataParser._getBoundingBoxType(a[DataParser_1.DataParser.SUB_TYPE]):H._getNumber(a,DataParser_1.DataParser.SUB_TYPE,e)){case 0:r=BaseObject_1.BaseObject.borrowObject(BoundingBoxData_1.RectangleBoundingBoxData);break;case 1:r=BaseObject_1.BaseObject.borrowObject(BoundingBoxData_1.EllipseBoundingBoxData);break;case 2:r=this._parsePolygonBoundingBox(a)}return null!==r&&(r.color=H._getNumber(a,DataParser_1.DataParser.COLOR,0),0!==r.type&&1!==r.type||(r.width=H._getNumber(a,DataParser_1.DataParser.WIDTH,0),r.height=H._getNumber(a,DataParser_1.DataParser.HEIGHT,0))),r},H.prototype._parsePolygonBoundingBox=function(a){var r=BaseObject_1.BaseObject.borrowObject(BoundingBoxData_1.PolygonBoundingBoxData);if(DataParser_1.DataParser.VERTICES in a){var e=this._armature.scale,t=a[DataParser_1.DataParser.VERTICES],s=r.vertices;s.length=t.length;for(var i=0,n=t.length;i<n;i+=2){var _=t[i]*e,o=t[i+1]*e;s[i]=_,s[i+1]=o,0===i?(r.x=_,r.y=o,r.width=_,r.height=o):(_<r.x?r.x=_:_>r.width&&(r.width=_),o<r.y?r.y=o:o>r.height&&(r.height=o))}r.width-=r.x,r.height-=r.y}else console.warn("Data error.\n Please reexport DragonBones Data to fixed the bug.");return r},H.prototype._parseAnimation=function(a){var r=BaseObject_1.BaseObject.borrowObject(AnimationData_1.AnimationData);if(r.blendType=DataParser_1.DataParser._getAnimationBlendType(H._getString(a,DataParser_1.DataParser.BLEND_TYPE,"")),r.frameCount=H._getNumber(a,DataParser_1.DataParser.DURATION,0),r.playTimes=H._getNumber(a,DataParser_1.DataParser.PLAY_TIMES,1),r.duration=r.frameCount/this._armature.frameRate,r.fadeInTime=H._getNumber(a,DataParser_1.DataParser.FADE_IN_TIME,0),r.scale=H._getNumber(a,DataParser_1.DataParser.SCALE,1),r.name=H._getString(a,DataParser_1.DataParser.NAME,DataParser_1.DataParser.DEFAULT_NAME),0===r.name.length&&(r.name=DataParser_1.DataParser.DEFAULT_NAME),r.frameIntOffset=this._frameIntArray.length,r.frameFloatOffset=this._frameFloatArray.length,r.frameOffset=this._frameArray.length,this._animation=r,DataParser_1.DataParser.FRAME in a){var e=a[DataParser_1.DataParser.FRAME],t=e.length;if(0<t)for(var s=0,i=0;s<t;++s){var n=e[s];this._parseActionDataInFrame(n,i,null,null),i+=H._getNumber(n,DataParser_1.DataParser.DURATION,1)}}if(DataParser_1.DataParser.Z_ORDER in a&&(this._animation.zOrderTimeline=this._parseTimeline(a[DataParser_1.DataParser.Z_ORDER],null,DataParser_1.DataParser.FRAME,1,0,0,this._parseZOrderFrame)),DataParser_1.DataParser.BONE in a)for(var _=0,o=a[DataParser_1.DataParser.BONE];_<o.length;_++){var l=o[_];this._parseBoneTimeline(l)}if(DataParser_1.DataParser.SLOT in a)for(var h=0,D=a[DataParser_1.DataParser.SLOT];h<D.length;h++){l=D[h];this._parseSlotTimeline(l)}if(DataParser_1.DataParser.FFD in a)for(var P=0,m=a[DataParser_1.DataParser.FFD];P<m.length;P++){l=m[P];var f=H._getString(l,DataParser_1.DataParser.SKIN,DataParser_1.DataParser.DEFAULT_NAME),A=H._getString(l,DataParser_1.DataParser.SLOT,""),u=H._getString(l,DataParser_1.DataParser.NAME,"");if(0===f.length&&(f=DataParser_1.DataParser.DEFAULT_NAME),this._slot=this._armature.getSlot(A),this._mesh=this._armature.getMesh(f,A,u),null!==this._slot&&null!==this._mesh)null!==(S=this._parseTimeline(l,null,DataParser_1.DataParser.FRAME,22,2,0,this._parseSlotDeformFrame))&&this._animation.addSlotTimeline(A,S),this._slot=null,this._mesh=null}if(DataParser_1.DataParser.IK in a)for(var g=0,y=a[DataParser_1.DataParser.IK];g<y.length;g++){l=y[g];var p=H._getString(l,DataParser_1.DataParser.NAME,"");if(null!==this._armature.getConstraint(p))null!==(S=this._parseTimeline(l,null,DataParser_1.DataParser.FRAME,30,1,2,this._parseIKConstraintFrame))&&this._animation.addConstraintTimeline(p,S)}if(0<this._actionFrames.length&&(this._animation.actionTimeline=this._parseTimeline(null,this._actionFrames,"",0,0,0,this._parseActionFrame),this._actionFrames.length=0),DataParser_1.DataParser.TIMELINE in a)for(var c=0,T=a[DataParser_1.DataParser.TIMELINE];c<T.length;c++){l=T[c];var E=H._getNumber(l,DataParser_1.DataParser.TYPE,0),b=H._getString(l,DataParser_1.DataParser.NAME,""),S=null;switch(E){case 0:break;case 20:case 23:case 60:case 24:case 40:case 41:if(20===E?(this._frameValueType=0,this._frameValueScale=1):(this._frameValueType=1,this._frameValueScale=23===E?1:40===E||41===E?1e4:100),this._frameDefaultValue=60===E||24===E||41===E?1:0,40===E&&0!==r.blendType){var O=S=BaseObject_1.BaseObject.borrowObject(AnimationData_1.AnimationTimelineData);O.x=H._getNumber(l,DataParser_1.DataParser.X,0),O.y=H._getNumber(l,DataParser_1.DataParser.Y,0)}S=this._parseTimeline(l,null,DataParser_1.DataParser.FRAME,E,this._frameValueType,1,this._parseSingleValueFrame,S);break;case 11:case 12:case 13:case 30:case 42:30===E||42===E?(this._frameValueType=1,this._frameValueScale=42===E?1e4:100):(this._frameValueScale=12===E?Transform_1.Transform.DEG_RAD:1,this._frameValueType=2),this._frameDefaultValue=13===E||30===E?1:0,S=this._parseTimeline(l,null,DataParser_1.DataParser.FRAME,E,this._frameValueType,2,this._parseDoubleValueFrame);break;case 1:break;case 50:var N=this._armature.getBone(b);if(null===N)continue;this._geometry=N.geometry,S=this._parseTimeline(l,null,DataParser_1.DataParser.FRAME,E,2,0,this._parseDeformFrame),this._geometry=null;break;case 22:for(var f in this._geometry=null,this._armature.skins){var v=this._armature.skins[f];for(var d in v.displays)for(var F=0,B=v.displays[d];F<B.length;F++){var I=B[F];if(null!==I&&I.name===b){this._geometry=I.geometry;break}}}if(null===this._geometry)continue;S=this._parseTimeline(l,null,DataParser_1.DataParser.FRAME,E,2,0,this._parseDeformFrame),this._geometry=null;break;case 21:S=this._parseTimeline(l,null,DataParser_1.DataParser.FRAME,E,1,1,this._parseSlotColorFrame)}if(null!==S)switch(E){case 0:case 1:break;case 11:case 12:case 13:case 50:case 60:this._animation.addBoneTimeline(b,S);break;case 20:case 21:case 22:case 23:case 24:this._animation.addSlotTimeline(b,S);break;case 30:this._animation.addConstraintTimeline(b,S);break;case 40:case 41:case 42:this._animation.addAnimationTimeline(b,S)}}return this._animation=null,r},H.prototype._parseTimeline=function(a,r,e,t,s,i,n,_){if(void 0===_&&(_=null),null!==a&&0<e.length&&e in a&&(r=a[e]),null===r)return null;var o=r.length;if(0===o)return null;var l=this._frameIntArray.length,h=this._frameFloatArray.length,D=this._timelineArray.length;switch(null===_&&(_=BaseObject_1.BaseObject.borrowObject(AnimationData_1.TimelineData)),_.type=t,_.offset=D,this._frameValueType=s,this._timeline=_,this._timelineArray.length+=5+o,null!==a?(this._timelineArray[D+0]=Math.round(100*H._getNumber(a,DataParser_1.DataParser.SCALE,1)),this._timelineArray[D+1]=Math.round(100*H._getNumber(a,DataParser_1.DataParser.OFFSET,0))):(this._timelineArray[D+0]=100,this._timelineArray[D+1]=0),this._timelineArray[D+2]=o,this._timelineArray[D+3]=i,this._frameValueType){case 0:this._timelineArray[D+4]=0;break;case 1:this._timelineArray[D+4]=l-this._animation.frameIntOffset;break;case 2:this._timelineArray[D+4]=h-this._animation.frameFloatOffset}if(1===o)_.frameIndicesOffset=-1,this._timelineArray[D+5+0]=n.call(this,r[0],0,0)-this._animation.frameOffset;else{var P=this._animation.frameCount+1,m=this._data.frameIndices,f=m.length;m.length+=P,_.frameIndicesOffset=f;for(var A=0,u=0,g=0,y=0;A<P;++A){if(g+y<=A&&u<o){var p=r[u];g=A,y=u===o-1?this._animation.frameCount-g:p instanceof ActionFrame?this._actionFrames[u+1].frameStart-g:H._getNumber(p,DataParser_1.DataParser.DURATION,1),this._timelineArray[D+5+u]=n.call(this,p,g,y)-this._animation.frameOffset,u++}m[f+A]=u-1}}return this._timeline=null,_},H.prototype._parseBoneTimeline=function(a){var r=this._armature.getBone(H._getString(a,DataParser_1.DataParser.NAME,""));if(null!==r){var e;if(this._bone=r,this._slot=this._armature.getSlot(this._bone.name),DataParser_1.DataParser.TRANSLATE_FRAME in a)this._frameDefaultValue=0,this._frameValueScale=1,null!==(e=this._parseTimeline(a,null,DataParser_1.DataParser.TRANSLATE_FRAME,11,2,2,this._parseDoubleValueFrame))&&this._animation.addBoneTimeline(r.name,e);if(DataParser_1.DataParser.ROTATE_FRAME in a)this._frameDefaultValue=0,this._frameValueScale=1,null!==(e=this._parseTimeline(a,null,DataParser_1.DataParser.ROTATE_FRAME,12,2,2,this._parseBoneRotateFrame))&&this._animation.addBoneTimeline(r.name,e);if(DataParser_1.DataParser.SCALE_FRAME in a)this._frameDefaultValue=1,this._frameValueScale=1,null!==(e=this._parseTimeline(a,null,DataParser_1.DataParser.SCALE_FRAME,13,2,2,this._parseBoneScaleFrame))&&this._animation.addBoneTimeline(r.name,e);if(DataParser_1.DataParser.FRAME in a)null!==(e=this._parseTimeline(a,null,DataParser_1.DataParser.FRAME,10,2,6,this._parseBoneAllFrame))&&this._animation.addBoneTimeline(r.name,e);this._bone=null,this._slot=null}},H.prototype._parseSlotTimeline=function(a){var r=this._armature.getSlot(H._getString(a,DataParser_1.DataParser.NAME,""));if(null!==r){var e=null,t=null;this._slot=r,e=DataParser_1.DataParser.DISPLAY_FRAME in a?this._parseTimeline(a,null,DataParser_1.DataParser.DISPLAY_FRAME,20,0,0,this._parseSlotDisplayFrame):this._parseTimeline(a,null,DataParser_1.DataParser.FRAME,20,0,0,this._parseSlotDisplayFrame),t=DataParser_1.DataParser.COLOR_FRAME in a?this._parseTimeline(a,null,DataParser_1.DataParser.COLOR_FRAME,21,1,1,this._parseSlotColorFrame):this._parseTimeline(a,null,DataParser_1.DataParser.FRAME,21,1,1,this._parseSlotColorFrame),null!==e&&this._animation.addSlotTimeline(r.name,e),null!==t&&this._animation.addSlotTimeline(r.name,t),this._slot=null}},H.prototype._parseFrame=function(a,r,e){var t=this._frameArray.length;return this._frameArray.length+=1,this._frameArray[t+0]=r,t},H.prototype._parseTweenFrame=function(a,r,e){var t=this._parseFrame(a,r,e);if(0<e)if(DataParser_1.DataParser.CURVE in a){var s=e+1;this._helpArray.length=s;var i=this._samplingEasingCurve(a[DataParser_1.DataParser.CURVE],this._helpArray);this._frameArray.length+=2+this._helpArray.length,this._frameArray[t+1]=2,this._frameArray[t+2]=i?s:-s;for(var n=0;n<s;++n)this._frameArray[t+3+n]=Math.round(1e4*this._helpArray[n])}else{var _=-2;DataParser_1.DataParser.TWEEN_EASING in a&&(_=H._getNumber(a,DataParser_1.DataParser.TWEEN_EASING,-2)),-2===_?(this._frameArray.length+=1,this._frameArray[t+1]=0):0===_?(this._frameArray.length+=1,this._frameArray[t+1]=1):_<0?(this._frameArray.length+=2,this._frameArray[t+1]=3,this._frameArray[t+2]=Math.round(100*-_)):_<=1?(this._frameArray.length+=2,this._frameArray[t+1]=4,this._frameArray[t+2]=Math.round(100*_)):(this._frameArray.length+=2,this._frameArray[t+1]=5,this._frameArray[t+2]=Math.round(100*_-100))}else this._frameArray.length+=1,this._frameArray[t+1]=0;return t},H.prototype._parseSingleValueFrame=function(a,r,e){var t=0;switch(this._frameValueType){case 0:t=this._parseFrame(a,r,e),this._frameArray.length+=1,this._frameArray[t+1]=H._getNumber(a,DataParser_1.DataParser.VALUE,this._frameDefaultValue);break;case 1:t=this._parseTweenFrame(a,r,e);var s=this._frameIntArray.length;this._frameIntArray.length+=1,this._frameIntArray[s]=Math.round(H._getNumber(a,DataParser_1.DataParser.VALUE,this._frameDefaultValue)*this._frameValueScale);break;case 2:t=this._parseTweenFrame(a,r,e);s=this._frameFloatArray.length;this._frameFloatArray.length+=1,this._frameFloatArray[s]=H._getNumber(a,DataParser_1.DataParser.VALUE,this._frameDefaultValue)*this._frameValueScale}return t},H.prototype._parseDoubleValueFrame=function(a,r,e){var t=0;switch(this._frameValueType){case 0:t=this._parseFrame(a,r,e),this._frameArray.length+=2,this._frameArray[t+1]=H._getNumber(a,DataParser_1.DataParser.X,this._frameDefaultValue),this._frameArray[t+2]=H._getNumber(a,DataParser_1.DataParser.Y,this._frameDefaultValue);break;case 1:t=this._parseTweenFrame(a,r,e);var s=this._frameIntArray.length;this._frameIntArray.length+=2,this._frameIntArray[s]=Math.round(H._getNumber(a,DataParser_1.DataParser.X,this._frameDefaultValue)*this._frameValueScale),this._frameIntArray[s+1]=Math.round(H._getNumber(a,DataParser_1.DataParser.Y,this._frameDefaultValue)*this._frameValueScale);break;case 2:t=this._parseTweenFrame(a,r,e);s=this._frameFloatArray.length;this._frameFloatArray.length+=2,this._frameFloatArray[s]=H._getNumber(a,DataParser_1.DataParser.X,this._frameDefaultValue)*this._frameValueScale,this._frameFloatArray[s+1]=H._getNumber(a,DataParser_1.DataParser.Y,this._frameDefaultValue)*this._frameValueScale}return t},H.prototype._parseActionFrame=function(a,r,e){var t=this._frameArray.length,s=a.actions.length;this._frameArray.length+=2+s,this._frameArray[t+0]=r,this._frameArray[t+0+1]=s;for(var i=0;i<s;++i)this._frameArray[t+0+2+i]=a.actions[i];return t},H.prototype._parseZOrderFrame=function(a,r,e){var t=this._parseFrame(a,r,e);if(DataParser_1.DataParser.Z_ORDER in a){var s=a[DataParser_1.DataParser.Z_ORDER];if(0<s.length){for(var i=this._armature.sortedSlots.length,n=new Array(i-s.length/2),_=new Array(i),o=0;o<n.length;++o)n[o]=0;for(var l=0;l<i;++l)_[l]=-1;for(var h=0,D=0,P=0,m=s.length;P<m;P+=2){for(var f=s[P],A=s[P+1];h!==f;)n[D++]=h++;_[h+A]=h++}for(;h<i;)n[D++]=h++;this._frameArray.length+=1+i;for(var u=this._frameArray[t+1]=i;u--;)-1===_[u]?this._frameArray[t+2+u]=n[--D]||0:this._frameArray[t+2+u]=_[u]||0;return t}}return this._frameArray.length+=1,this._frameArray[t+1]=0,t},H.prototype._parseBoneAllFrame=function(a,r,e){this._helpTransform.identity(),DataParser_1.DataParser.TRANSFORM in a&&this._parseTransform(a[DataParser_1.DataParser.TRANSFORM],this._helpTransform,1);var t=this._helpTransform.rotation;0!==r&&(t=0===this._prevClockwise?this._prevRotation+Transform_1.Transform.normalizeRadian(t-this._prevRotation):((0<this._prevClockwise?t>=this._prevRotation:t<=this._prevRotation)&&(this._prevClockwise=0<this._prevClockwise?this._prevClockwise-1:this._prevClockwise+1),this._prevRotation+t-this._prevRotation+Transform_1.Transform.PI_D*this._prevClockwise)),this._prevClockwise=H._getNumber(a,DataParser_1.DataParser.TWEEN_ROTATE,0),this._prevRotation=t;var s=this._parseTweenFrame(a,r,e),i=this._frameFloatArray.length;return this._frameFloatArray.length+=6,this._frameFloatArray[i++]=this._helpTransform.x,this._frameFloatArray[i++]=this._helpTransform.y,this._frameFloatArray[i++]=t,this._frameFloatArray[i++]=this._helpTransform.skew,this._frameFloatArray[i++]=this._helpTransform.scaleX,this._frameFloatArray[i++]=this._helpTransform.scaleY,this._parseActionDataInFrame(a,r,this._bone,this._slot),s},H.prototype._parseBoneTranslateFrame=function(a,r,e){var t=this._parseTweenFrame(a,r,e),s=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[s++]=H._getNumber(a,DataParser_1.DataParser.X,0),this._frameFloatArray[s++]=H._getNumber(a,DataParser_1.DataParser.Y,0),t},H.prototype._parseBoneRotateFrame=function(a,r,e){var t=H._getNumber(a,DataParser_1.DataParser.ROTATE,0)*Transform_1.Transform.DEG_RAD;0!==r&&(t=0===this._prevClockwise?this._prevRotation+Transform_1.Transform.normalizeRadian(t-this._prevRotation):((0<this._prevClockwise?t>=this._prevRotation:t<=this._prevRotation)&&(this._prevClockwise=0<this._prevClockwise?this._prevClockwise-1:this._prevClockwise+1),this._prevRotation+t-this._prevRotation+Transform_1.Transform.PI_D*this._prevClockwise)),this._prevClockwise=H._getNumber(a,DataParser_1.DataParser.CLOCK_WISE,0),this._prevRotation=t;var s=this._parseTweenFrame(a,r,e),i=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[i++]=t,this._frameFloatArray[i++]=H._getNumber(a,DataParser_1.DataParser.SKEW,0)*Transform_1.Transform.DEG_RAD,s},H.prototype._parseBoneScaleFrame=function(a,r,e){var t=this._parseTweenFrame(a,r,e),s=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[s++]=H._getNumber(a,DataParser_1.DataParser.X,1),this._frameFloatArray[s++]=H._getNumber(a,DataParser_1.DataParser.Y,1),t},H.prototype._parseSlotDisplayFrame=function(a,r,e){var t=this._parseFrame(a,r,e);return this._frameArray.length+=1,DataParser_1.DataParser.VALUE in a?this._frameArray[t+1]=H._getNumber(a,DataParser_1.DataParser.VALUE,0):this._frameArray[t+1]=H._getNumber(a,DataParser_1.DataParser.DISPLAY_INDEX,0),this._parseActionDataInFrame(a,r,this._slot.parent,this._slot),t},H.prototype._parseSlotColorFrame=function(a,r,e){var t=this._parseTweenFrame(a,r,e),s=-1;if(DataParser_1.DataParser.VALUE in a||DataParser_1.DataParser.COLOR in a){var i=DataParser_1.DataParser.VALUE in a?a[DataParser_1.DataParser.VALUE]:a[DataParser_1.DataParser.COLOR];for(var n in i){this._parseColorTransform(i,this._helpColorTransform),s=this._colorArray.length,this._colorArray.length+=8,this._colorArray[s++]=Math.round(100*this._helpColorTransform.alphaMultiplier),this._colorArray[s++]=Math.round(100*this._helpColorTransform.redMultiplier),this._colorArray[s++]=Math.round(100*this._helpColorTransform.greenMultiplier),this._colorArray[s++]=Math.round(100*this._helpColorTransform.blueMultiplier),this._colorArray[s++]=Math.round(this._helpColorTransform.alphaOffset),this._colorArray[s++]=Math.round(this._helpColorTransform.redOffset),this._colorArray[s++]=Math.round(this._helpColorTransform.greenOffset),this._colorArray[s++]=Math.round(this._helpColorTransform.blueOffset),s-=8;break}}s<0&&(this._defaultColorOffset<0&&(this._defaultColorOffset=s=this._colorArray.length,this._colorArray.length+=8,this._colorArray[s++]=100,this._colorArray[s++]=100,this._colorArray[s++]=100,this._colorArray[s++]=100,this._colorArray[s++]=0,this._colorArray[s++]=0,this._colorArray[s++]=0,this._colorArray[s++]=0),s=this._defaultColorOffset);var _=this._frameIntArray.length;return this._frameIntArray.length+=1,this._frameIntArray[_]=s,t},H.prototype._parseSlotDeformFrame=function(a,r,e){var t=this._frameFloatArray.length,s=this._parseTweenFrame(a,r,e),i=DataParser_1.DataParser.VERTICES in a?a[DataParser_1.DataParser.VERTICES]:null,n=H._getNumber(a,DataParser_1.DataParser.OFFSET,0),_=this._intArray[this._mesh.geometry.offset+0],o=this._mesh.parent.name+"_"+this._slot.name+"_"+this._mesh.name,l=this._mesh.geometry.weight,h=0,D=0,P=0,m=0;if(null!==l){var f=this._weightSlotPose[o];this._helpMatrixA.copyFromArray(f,0),this._frameFloatArray.length+=2*l.count,P=l.offset+2+l.bones.length}else this._frameFloatArray.length+=2*_;for(var A=0;A<2*_;A+=2)if(D=null===i?h=0:(h=A<n||A-n>=i.length?0:i[A-n],A+1<n||A+1-n>=i.length?0:i[A+1-n]),null!==l){var u=this._weightBonePoses[o],g=this._intArray[P++];this._helpMatrixA.transformPoint(h,D,this._helpPoint,!0),h=this._helpPoint.x,D=this._helpPoint.y;for(var y=0;y<g;++y){var p=this._intArray[P++];this._helpMatrixB.copyFromArray(u,7*p+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(h,D,this._helpPoint,!0),this._frameFloatArray[t+m++]=this._helpPoint.x,this._frameFloatArray[t+m++]=this._helpPoint.y}}else this._frameFloatArray[t+A]=h,this._frameFloatArray[t+A+1]=D;if(0===r){var c=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[c+0]=this._mesh.geometry.offset,this._frameIntArray[c+1]=this._frameFloatArray.length-t,this._frameIntArray[c+2]=this._frameFloatArray.length-t,this._frameIntArray[c+3]=0,this._frameIntArray[c+4]=t-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=c-this._animation.frameIntOffset}return s},H.prototype._parseIKConstraintFrame=function(a,r,e){var t=this._parseTweenFrame(a,r,e),s=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[s++]=H._getBoolean(a,DataParser_1.DataParser.BEND_POSITIVE,!0)?1:0,this._frameIntArray[s++]=Math.round(100*H._getNumber(a,DataParser_1.DataParser.WEIGHT,1)),t},H.prototype._parseActionData=function(a,r,e,t){var s=new Array;if("string"==typeof a)(o=BaseObject_1.BaseObject.borrowObject(UserData_1.ActionData)).type=r,o.name=a,o.bone=e,o.slot=t,s.push(o);else if(a instanceof Array)for(var i=0,n=a;i<n.length;i++){var _=n[i],o=BaseObject_1.BaseObject.borrowObject(UserData_1.ActionData);if(DataParser_1.DataParser.GOTO_AND_PLAY in _?(o.type=0,o.name=H._getString(_,DataParser_1.DataParser.GOTO_AND_PLAY,"")):(DataParser_1.DataParser.TYPE in _&&"string"==typeof _[DataParser_1.DataParser.TYPE]?o.type=DataParser_1.DataParser._getActionType(_[DataParser_1.DataParser.TYPE]):o.type=H._getNumber(_,DataParser_1.DataParser.TYPE,r),o.name=H._getString(_,DataParser_1.DataParser.NAME,"")),DataParser_1.DataParser.BONE in _){var l=H._getString(_,DataParser_1.DataParser.BONE,"");o.bone=this._armature.getBone(l)}else o.bone=e;if(DataParser_1.DataParser.SLOT in _){var h=H._getString(_,DataParser_1.DataParser.SLOT,"");o.slot=this._armature.getSlot(h)}else o.slot=t;var D=null;if(DataParser_1.DataParser.INTS in _){null===D&&(D=BaseObject_1.BaseObject.borrowObject(UserData_1.UserData));for(var P=0,m=_[DataParser_1.DataParser.INTS];P<m.length;P++){var f=m[P];D.addInt(f)}}if(DataParser_1.DataParser.FLOATS in _){null===D&&(D=BaseObject_1.BaseObject.borrowObject(UserData_1.UserData));for(var A=0,u=_[DataParser_1.DataParser.FLOATS];A<u.length;A++){f=u[A];D.addFloat(f)}}if(DataParser_1.DataParser.STRINGS in _){null===D&&(D=BaseObject_1.BaseObject.borrowObject(UserData_1.UserData));for(var g=0,y=_[DataParser_1.DataParser.STRINGS];g<y.length;g++){f=y[g];D.addString(f)}}o.data=D,s.push(o)}return s},H.prototype._parseDeformFrame=function(a,r,e){var t=this._frameFloatArray.length,s=this._parseTweenFrame(a,r,e),i=DataParser_1.DataParser.VERTICES in a?a[DataParser_1.DataParser.VERTICES]:DataParser_1.DataParser.VALUE in a?a[DataParser_1.DataParser.VALUE]:null,n=H._getNumber(a,DataParser_1.DataParser.OFFSET,0),_=this._intArray[this._geometry.offset+0],o=0,l=0;if(null!==this._geometry.weight);else{this._frameFloatArray.length+=2*_;for(var h=0;h<2*_;h+=2)l=null!==i?(o=h<n||h-n>=i.length?0:i[h-n],h+1<n||h+1-n>=i.length?0:i[h+1-n]):o=0,this._frameFloatArray[t+h]=o,this._frameFloatArray[t+h+1]=l}if(0===r){var D=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[D+0]=this._geometry.offset,this._frameIntArray[D+1]=this._frameFloatArray.length-t,this._frameIntArray[D+2]=this._frameFloatArray.length-t,this._frameIntArray[D+3]=0,this._frameIntArray[D+4]=t-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=D-this._animation.frameIntOffset}return s},H.prototype._parseTransform=function(a,r,e){r.x=H._getNumber(a,DataParser_1.DataParser.X,0)*e,r.y=H._getNumber(a,DataParser_1.DataParser.Y,0)*e,DataParser_1.DataParser.ROTATE in a||DataParser_1.DataParser.SKEW in a?(r.rotation=Transform_1.Transform.normalizeRadian(H._getNumber(a,DataParser_1.DataParser.ROTATE,0)*Transform_1.Transform.DEG_RAD),r.skew=Transform_1.Transform.normalizeRadian(H._getNumber(a,DataParser_1.DataParser.SKEW,0)*Transform_1.Transform.DEG_RAD)):(DataParser_1.DataParser.SKEW_X in a||DataParser_1.DataParser.SKEW_Y in a)&&(r.rotation=Transform_1.Transform.normalizeRadian(H._getNumber(a,DataParser_1.DataParser.SKEW_Y,0)*Transform_1.Transform.DEG_RAD),r.skew=Transform_1.Transform.normalizeRadian(H._getNumber(a,DataParser_1.DataParser.SKEW_X,0)*Transform_1.Transform.DEG_RAD)-r.rotation),r.scaleX=H._getNumber(a,DataParser_1.DataParser.SCALE_X,1),r.scaleY=H._getNumber(a,DataParser_1.DataParser.SCALE_Y,1)},H.prototype._parseColorTransform=function(a,r){r.alphaMultiplier=.01*H._getNumber(a,DataParser_1.DataParser.ALPHA_MULTIPLIER,100),r.redMultiplier=.01*H._getNumber(a,DataParser_1.DataParser.RED_MULTIPLIER,100),r.greenMultiplier=.01*H._getNumber(a,DataParser_1.DataParser.GREEN_MULTIPLIER,100),r.blueMultiplier=.01*H._getNumber(a,DataParser_1.DataParser.BLUE_MULTIPLIER,100),r.alphaOffset=H._getNumber(a,DataParser_1.DataParser.ALPHA_OFFSET,0),r.redOffset=H._getNumber(a,DataParser_1.DataParser.RED_OFFSET,0),r.greenOffset=H._getNumber(a,DataParser_1.DataParser.GREEN_OFFSET,0),r.blueOffset=H._getNumber(a,DataParser_1.DataParser.BLUE_OFFSET,0)},H.prototype._parseGeometry=function(a,r){var e=a[DataParser_1.DataParser.VERTICES],t=Math.floor(e.length/2),s=0,i=this._intArray.length,n=this._floatArray.length;r.offset=i,r.data=this._data,this._intArray.length+=4,this._intArray[i+0]=t,this._intArray[i+2]=n,this._intArray[i+3]=-1,this._floatArray.length+=2*t;for(var _=0,o=2*t;_<o;++_)this._floatArray[n+_]=e[_];if(DataParser_1.DataParser.TRIANGLES in a){var l=a[DataParser_1.DataParser.TRIANGLES];s=Math.floor(l.length/3),this._intArray.length+=3*s;for(_=0,o=3*s;_<o;++_)this._intArray[i+4+_]=l[_]}if(this._intArray[i+1]=s,DataParser_1.DataParser.UVS in a){var h=a[DataParser_1.DataParser.UVS],D=n+2*t;this._floatArray.length+=2*t;for(_=0,o=2*t;_<o;++_)this._floatArray[D+_]=h[_]}if(DataParser_1.DataParser.WEIGHTS in a){var P=a[DataParser_1.DataParser.WEIGHTS],m=Math.floor(P.length-t)/2,f=this._intArray.length,A=this._floatArray.length,u=0,g=this._armature.sortedBones,y=BaseObject_1.BaseObject.borrowObject(DisplayData_1.WeightData);if(y.count=m,y.offset=f,this._intArray.length+=2+u+t+m,this._intArray[f+1]=A,DataParser_1.DataParser.BONE_POSE in a){var p=a[DataParser_1.DataParser.SLOT_POSE],c=a[DataParser_1.DataParser.BONE_POSE],T=new Array;u=Math.floor(c.length/7),T.length=u;for(_=0;_<u;++_){var E=c[7*_],b=this._rawBones[E];y.addBone(b),T[_]=E,this._intArray[f+2+_]=g.indexOf(b)}this._floatArray.length+=3*m,this._helpMatrixA.copyFromArray(p,0);_=0;for(var S=0,O=f+2+u,N=A;_<t;++_){var v=2*_,d=this._intArray[O++]=P[S++],F=this._floatArray[n+v],B=this._floatArray[n+v+1];this._helpMatrixA.transformPoint(F,B,this._helpPoint),F=this._helpPoint.x,B=this._helpPoint.y;for(var I=0;I<d;++I){E=P[S++];var R=T.indexOf(E);this._helpMatrixB.copyFromArray(c,7*R+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(F,B,this._helpPoint),this._intArray[O++]=R,this._floatArray[N++]=P[S++],this._floatArray[N++]=this._helpPoint.x,this._floatArray[N++]=this._helpPoint.y}}}else{var M=a[DataParser_1.DataParser.BONES];u=M.length;for(_=0;_<u;_++){E=M[_],b=this._rawBones[E];y.addBone(b),this._intArray[f+2+_]=g.indexOf(b)}this._floatArray.length+=3*m;_=0,S=0,N=0,O=f+2+u;for(var w=A;_<m;_++){d=P[S++];this._intArray[O++]=d;for(I=0;I<d;I++){R=P[S++];var C=P[S++];F=e[N++],B=e[N++];this._intArray[O++]=M.indexOf(R),this._floatArray[w++]=C,this._floatArray[w++]=F,this._floatArray[w++]=B}}}r.weight=y}},H.prototype._parseArray=function(a){this._intArray.length=0,this._floatArray.length=0,this._frameIntArray.length=0,this._frameFloatArray.length=0,this._frameArray.length=0,this._timelineArray.length=0,this._colorArray.length=0},H.prototype._modifyArray=function(){this._intArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._intArray.push(0),this._frameIntArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameIntArray.push(0),this._frameArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameArray.push(0),this._timelineArray.length%Uint16Array.BYTES_PER_ELEMENT!=0&&this._timelineArray.push(0),this._timelineArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._colorArray.push(0);for(var a=this._intArray.length*Int16Array.BYTES_PER_ELEMENT,r=this._floatArray.length*Float32Array.BYTES_PER_ELEMENT,e=this._frameIntArray.length*Int16Array.BYTES_PER_ELEMENT,t=this._frameFloatArray.length*Float32Array.BYTES_PER_ELEMENT,s=this._frameArray.length*Int16Array.BYTES_PER_ELEMENT,i=this._timelineArray.length*Uint16Array.BYTES_PER_ELEMENT,n=this._colorArray.length*Int16Array.BYTES_PER_ELEMENT,_=new ArrayBuffer(a+r+e+t+s+i+n),o=new Int16Array(_,0,this._intArray.length),l=new Float32Array(_,a,this._floatArray.length),h=new Int16Array(_,a+r,this._frameIntArray.length),D=new Float32Array(_,a+r+e,this._frameFloatArray.length),P=new Int16Array(_,a+r+e+t,this._frameArray.length),m=new Uint16Array(_,a+r+e+t+s,this._timelineArray.length),f=new Int16Array(_,a+r+e+t+s+i,this._colorArray.length),A=0,u=this._intArray.length;A<u;++A)o[A]=this._intArray[A];for(A=0,u=this._floatArray.length;A<u;++A)l[A]=this._floatArray[A];for(A=0,u=this._frameIntArray.length;A<u;++A)h[A]=this._frameIntArray[A];for(A=0,u=this._frameFloatArray.length;A<u;++A)D[A]=this._frameFloatArray[A];for(A=0,u=this._frameArray.length;A<u;++A)P[A]=this._frameArray[A];for(A=0,u=this._timelineArray.length;A<u;++A)m[A]=this._timelineArray[A];for(A=0,u=this._colorArray.length;A<u;++A)f[A]=this._colorArray[A];this._data.binary=_,this._data.intArray=o,this._data.floatArray=l,this._data.frameIntArray=h,this._data.frameFloatArray=D,this._data.frameArray=P,this._data.timelineArray=m,this._data.colorArray=f,this._defaultColorOffset=-1},H.prototype.parseDragonBonesData=function(a,r){void 0===r&&(r=1),console.assert(null!=a,"Data error.");var e=H._getString(a,DataParser_1.DataParser.VERSION,""),t=H._getString(a,DataParser_1.DataParser.COMPATIBLE_VERSION,"");if(0<=DataParser_1.DataParser.DATA_VERSIONS.indexOf(e)||0<=DataParser_1.DataParser.DATA_VERSIONS.indexOf(t)){var s=BaseObject_1.BaseObject.borrowObject(DragonBonesData_1.DragonBonesData);if(s.version=e,s.name=H._getString(a,DataParser_1.DataParser.NAME,""),s.frameRate=H._getNumber(a,DataParser_1.DataParser.FRAME_RATE,24),0===s.frameRate&&(s.frameRate=24),DataParser_1.DataParser.ARMATURE in a){this._data=s,this._parseArray(a);for(var i=0,n=a[DataParser_1.DataParser.ARMATURE];i<n.length;i++){var _=n[i];s.addArmature(this._parseArmature(_,r))}this._data.binary||this._modifyArray(),DataParser_1.DataParser.STAGE in a?s.stage=s.getArmature(H._getString(a,DataParser_1.DataParser.STAGE,"")):0<s.armatureNames.length&&(s.stage=s.getArmature(s.armatureNames[0])),this._data=null}return DataParser_1.DataParser.TEXTURE_ATLAS in a&&(this._rawTextureAtlases=a[DataParser_1.DataParser.TEXTURE_ATLAS]),s}return console.assert(!1,"Nonsupport data version: "+e+"\nPlease convert DragonBones data to support version.\nRead more: https://github.com/DragonBones/Tools/"),null},H.prototype.parseTextureAtlasData=function(a,r,e){if(void 0===e&&(e=1),console.assert(void 0!==a),null===a){if(null===this._rawTextureAtlases||0===this._rawTextureAtlases.length)return!1;var t=this._rawTextureAtlases[this._rawTextureAtlasIndex++];return this.parseTextureAtlasData(t,r,e),this._rawTextureAtlasIndex>=this._rawTextureAtlases.length&&(this._rawTextureAtlasIndex=0,this._rawTextureAtlases=null),!0}if(r.width=H._getNumber(a,DataParser_1.DataParser.WIDTH,0),r.height=H._getNumber(a,DataParser_1.DataParser.HEIGHT,0),r.scale=1===e?1/H._getNumber(a,DataParser_1.DataParser.SCALE,1):e,r.name=H._getString(a,DataParser_1.DataParser.NAME,""),r.imagePath=H._getString(a,DataParser_1.DataParser.IMAGE_PATH,""),DataParser_1.DataParser.SUB_TEXTURE in a)for(var s=a[DataParser_1.DataParser.SUB_TEXTURE],i=0,n=s.length;i<n;++i){var _=s[i],o=H._getNumber(_,DataParser_1.DataParser.FRAME_WIDTH,-1),l=H._getNumber(_,DataParser_1.DataParser.FRAME_HEIGHT,-1),h=r.createTexture();h.rotated=H._getBoolean(_,DataParser_1.DataParser.ROTATED,!1),h.name=H._getString(_,DataParser_1.DataParser.NAME,""),h.region.x=H._getNumber(_,DataParser_1.DataParser.X,0),h.region.y=H._getNumber(_,DataParser_1.DataParser.Y,0),h.region.width=H._getNumber(_,DataParser_1.DataParser.WIDTH,0),h.region.height=H._getNumber(_,DataParser_1.DataParser.HEIGHT,0),0<o&&0<l&&(h.frame=TextureAtlasData_1.TextureData.createRectangle(),h.frame.x=H._getNumber(_,DataParser_1.DataParser.FRAME_X,0),h.frame.y=H._getNumber(_,DataParser_1.DataParser.FRAME_Y,0),h.frame.width=o,h.frame.height=l),r.addTexture(h)}return!0},H.getInstance=function(){return null===H._objectDataParserInstance&&(H._objectDataParserInstance=new H),H._objectDataParserInstance},H._objectDataParserInstance=null,H}(DataParser_1.DataParser);exports.ObjectDataParser=ObjectDataParser;var ActionFrame=function(){this.frameStart=0,this.actions=[]};exports.ActionFrame=ActionFrame;