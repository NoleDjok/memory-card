"use strict";var __extends=this&&this.__extends||function(){var e=function(a,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,r){a.__proto__=r}||function(a,r){for(var t in r)r.hasOwnProperty(t)&&(a[t]=r[t])})(a,r)};return function(a,r){function t(){this.constructor=a}e(a,r),a.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}}();Object.defineProperty(exports,"__esModule",{value:!0});var DataParser_1=require("./DataParser"),DisplayData_1=require("../model/DisplayData"),BaseObject_1=require("../core/BaseObject"),ObjectDataParser_1=require("./ObjectDataParser"),AnimationData_1=require("../model/AnimationData"),BinaryDataParser=function(_){function a(){return null!==_&&_.apply(this,arguments)||this}return __extends(a,_),a.prototype._inRange=function(a,r,t){return r<=a&&a<=t},a.prototype._decodeUTF8=function(a){for(var r,t=0,e="",i=0,n=0,s=0,_=0;a.length>t;){var o=a[t++];if(-1===o)r=0!==n?65533:-1;else if(0===n)r=this._inRange(o,0,127)?o:(this._inRange(o,194,223)?(n=1,_=128,i=o-192):this._inRange(o,224,239)?(n=2,_=2048,i=o-224):this._inRange(o,240,244)&&(n=3,_=65536,i=o-240),i*=Math.pow(64,n),null);else if(this._inRange(o,128,191))if(s+=1,i+=(o-128)*Math.pow(64,n-s),s!==n)r=null;else{var f=i,D=_;_=s=n=i=0,r=this._inRange(f,D,1114111)&&!this._inRange(f,55296,57343)?f:o}else _=s=n=i=0,t--,r=o;null!==r&&-1!==r&&(r<=65535?0<r&&(e+=String.fromCharCode(r)):(r-=65536,e+=String.fromCharCode(55296+(r>>10&1023)),e+=String.fromCharCode(56320+(1023&r))))}return e},a.prototype._parseBinaryTimeline=function(a,r,t){void 0===t&&(t=null);var e=null!==t?t:BaseObject_1.BaseObject.borrowObject(AnimationData_1.TimelineData);e.type=a,e.offset=r,this._timeline=e;var i=this._timelineArrayBuffer[e.offset+2];if(1===i)e.frameIndicesOffset=-1;else{var n,s=this._animation.frameCount+1,_=this._data.frameIndices;n=_.length,_.length+=s,e.frameIndicesOffset=n;for(var o=0,f=0,D=0,P=0;o<s;++o)D+P<=o&&f<i&&(D=this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[e.offset+5+f]],P=f===i-1?this._animation.frameCount-D:this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[e.offset+5+f+1]]-D,f++),_[n+o]=f-1}return this._timeline=null,e},a.prototype._parseAnimation=function(a){var r=BaseObject_1.BaseObject.borrowObject(AnimationData_1.AnimationData);r.blendType=DataParser_1.DataParser._getAnimationBlendType(ObjectDataParser_1.ObjectDataParser._getString(a,DataParser_1.DataParser.BLEND_TYPE,"")),r.frameCount=ObjectDataParser_1.ObjectDataParser._getNumber(a,DataParser_1.DataParser.DURATION,0),r.playTimes=ObjectDataParser_1.ObjectDataParser._getNumber(a,DataParser_1.DataParser.PLAY_TIMES,1),r.duration=r.frameCount/this._armature.frameRate,r.fadeInTime=ObjectDataParser_1.ObjectDataParser._getNumber(a,DataParser_1.DataParser.FADE_IN_TIME,0),r.scale=ObjectDataParser_1.ObjectDataParser._getNumber(a,DataParser_1.DataParser.SCALE,1),r.name=ObjectDataParser_1.ObjectDataParser._getString(a,DataParser_1.DataParser.NAME,DataParser_1.DataParser.DEFAULT_NAME),0===r.name.length&&(r.name=DataParser_1.DataParser.DEFAULT_NAME);var t=a[DataParser_1.DataParser.OFFSET];if(r.frameIntOffset=t[0],r.frameFloatOffset=t[1],r.frameOffset=t[2],this._animation=r,DataParser_1.DataParser.ACTION in a&&(r.actionTimeline=this._parseBinaryTimeline(0,a[DataParser_1.DataParser.ACTION])),DataParser_1.DataParser.Z_ORDER in a&&(r.zOrderTimeline=this._parseBinaryTimeline(1,a[DataParser_1.DataParser.Z_ORDER])),DataParser_1.DataParser.BONE in a){var e=a[DataParser_1.DataParser.BONE];for(var i in e){var n=e[i],s=this._armature.getBone(i);if(null!==s)for(var _=0,o=n.length;_<o;_+=2){var f=n[_],D=n[_+1],P=this._parseBinaryTimeline(f,D);this._animation.addBoneTimeline(s.name,P)}}}if(DataParser_1.DataParser.SLOT in a){e=a[DataParser_1.DataParser.SLOT];for(var i in e){n=e[i];var c=this._armature.getSlot(i);if(null!==c)for(_=0,o=n.length;_<o;_+=2){f=n[_],D=n[_+1],P=this._parseBinaryTimeline(f,D);this._animation.addSlotTimeline(c.name,P)}}}if(DataParser_1.DataParser.CONSTRAINT in a){e=a[DataParser_1.DataParser.CONSTRAINT];for(var i in e){n=e[i];var h=this._armature.getConstraint(i);if(null!==h)for(_=0,o=n.length;_<o;_+=2){f=n[_],D=n[_+1],P=this._parseBinaryTimeline(f,D);this._animation.addConstraintTimeline(h.name,P)}}}if(DataParser_1.DataParser.TIMELINE in a)for(var l=0,y=n=a[DataParser_1.DataParser.TIMELINE];l<y.length;l++){var m=y[l];if(0<=(D=ObjectDataParser_1.ObjectDataParser._getNumber(m,DataParser_1.DataParser.OFFSET,0))){f=ObjectDataParser_1.ObjectDataParser._getNumber(m,DataParser_1.DataParser.TYPE,0);var u=ObjectDataParser_1.ObjectDataParser._getString(m,DataParser_1.DataParser.NAME,"");P=null;if(40===f&&0!==r.blendType){var b=P=BaseObject_1.BaseObject.borrowObject(AnimationData_1.AnimationTimelineData);b.x=ObjectDataParser_1.ObjectDataParser._getNumber(m,DataParser_1.DataParser.X,0),b.y=ObjectDataParser_1.ObjectDataParser._getNumber(m,DataParser_1.DataParser.Y,0)}switch(P=this._parseBinaryTimeline(f,D,P),f){case 0:case 1:break;case 11:case 12:case 13:case 50:case 60:this._animation.addBoneTimeline(u,P);break;case 20:case 21:case 22:case 23:case 24:this._animation.addSlotTimeline(u,P);break;case 30:this._animation.addConstraintTimeline(u,P);break;case 40:case 41:case 42:this._animation.addAnimationTimeline(u,P)}}}return this._animation=null,r},a.prototype._parseGeometry=function(a,r){r.offset=a[DataParser_1.DataParser.OFFSET],r.data=this._data;var t=this._intArrayBuffer[r.offset+3];if(0<=t){var e=BaseObject_1.BaseObject.borrowObject(DisplayData_1.WeightData),i=this._intArrayBuffer[r.offset+0],n=this._intArrayBuffer[t+0];e.offset=t;for(var s=0;s<n;++s){var _=this._intArrayBuffer[t+2+s];e.addBone(this._rawBones[_])}for(var o=t+2+n,f=0,D=(s=0,i);s<D;++s){var P=this._intArrayBuffer[o++];f+=P,o+=P}e.count=f,r.weight=e}},a.prototype._parseArray=function(a){var r=a[DataParser_1.DataParser.OFFSET],t=r[1],e=r[3],i=r[5],n=r[7],s=r[9],_=r[11],o=12<r.length?r[13]:0,f=new Int16Array(this._binary,this._binaryOffset+r[0],t/Int16Array.BYTES_PER_ELEMENT),D=new Float32Array(this._binary,this._binaryOffset+r[2],e/Float32Array.BYTES_PER_ELEMENT),P=new Int16Array(this._binary,this._binaryOffset+r[4],i/Int16Array.BYTES_PER_ELEMENT),c=new Float32Array(this._binary,this._binaryOffset+r[6],n/Float32Array.BYTES_PER_ELEMENT),h=new Int16Array(this._binary,this._binaryOffset+r[8],s/Int16Array.BYTES_PER_ELEMENT),l=new Uint16Array(this._binary,this._binaryOffset+r[10],_/Uint16Array.BYTES_PER_ELEMENT),y=0<o?new Int16Array(this._binary,this._binaryOffset+r[12],o/Int16Array.BYTES_PER_ELEMENT):f;this._data.binary=this._binary,this._data.intArray=this._intArrayBuffer=f,this._data.floatArray=D,this._data.frameIntArray=P,this._data.frameFloatArray=c,this._data.frameArray=this._frameArrayBuffer=h,this._data.timelineArray=this._timelineArrayBuffer=l,this._data.colorArray=y},a.prototype.parseDragonBonesData=function(a,r){void 0===r&&(r=1),console.assert(null!=a&&a instanceof ArrayBuffer,"Data error.");var t=new Uint8Array(a,0,8);if(t[0]!=="D".charCodeAt(0)||t[1]!=="B".charCodeAt(0)||t[2]!=="D".charCodeAt(0)||t[3]!=="T".charCodeAt(0))return console.assert(!1,"Nonsupport data."),null;var e=new Uint32Array(a,8,1)[0],i=new Uint8Array(a,12,e),n=this._decodeUTF8(i),s=JSON.parse(n);return this._binaryOffset=12+e,this._binary=a,_.prototype.parseDragonBonesData.call(this,s,r)},a.getInstance=function(){return null===a._binaryDataParserInstance&&(a._binaryDataParserInstance=new a),a._binaryDataParserInstance},a._binaryDataParserInstance=null,a}(ObjectDataParser_1.ObjectDataParser);exports.BinaryDataParser=BinaryDataParser;