"use strict";var __extends=this&&this.__extends||function(){var a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Slot_1=require("../armature/Slot"),PixiTextureAtlasData_1=require("./PixiTextureAtlasData"),BaseObject_1=require("../core/BaseObject"),PixiSlot=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.toString=function(){return"[class dragonBones.PixiSlot]"},t.prototype._onClear=function(){e.prototype._onClear.call(this),this._textureScale=1,this._renderDisplay=null,this._updateTransform="3"===PIXI.VERSION[0]?this._updateTransformV3:this._updateTransformV4},t.prototype._initDisplay=function(e,t){},t.prototype._disposeDisplay=function(e,t){t||e.destroy()},t.prototype._onUpdateDisplay=function(){this._renderDisplay=this._display?this._display:this._rawDisplay},t.prototype._addDisplay=function(){this._armature.display.addChild(this._renderDisplay)},t.prototype._replaceDisplay=function(e){var t=this._armature.display,r=e;t.addChild(this._renderDisplay),t.swapChildren(this._renderDisplay,r),t.removeChild(r),this._textureScale=1},t.prototype._removeDisplay=function(){this._renderDisplay.parent.removeChild(this._renderDisplay)},t.prototype._updateZOrder=function(){var e=this._armature.display;e.getChildIndex(this._renderDisplay)!==this._zOrder&&e.addChildAt(this._renderDisplay,this._zOrder)},t.prototype._updateVisible=function(){this._renderDisplay.visible=this._parent.visible&&this._visible},t.prototype._updateBlendMode=function(){if(this._renderDisplay instanceof PIXI.Sprite)switch(this._blendMode){case 0:this._renderDisplay.blendMode=PIXI.BLEND_MODES.NORMAL;break;case 1:this._renderDisplay.blendMode=PIXI.BLEND_MODES.ADD;break;case 3:this._renderDisplay.blendMode=PIXI.BLEND_MODES.DARKEN;break;case 4:this._renderDisplay.blendMode=PIXI.BLEND_MODES.DIFFERENCE;break;case 6:this._renderDisplay.blendMode=PIXI.BLEND_MODES.HARD_LIGHT;break;case 9:this._renderDisplay.blendMode=PIXI.BLEND_MODES.LIGHTEN;break;case 10:this._renderDisplay.blendMode=PIXI.BLEND_MODES.MULTIPLY;break;case 11:this._renderDisplay.blendMode=PIXI.BLEND_MODES.OVERLAY;break;case 12:this._renderDisplay.blendMode=PIXI.BLEND_MODES.SCREEN}},t.prototype._updateColor=function(){var e=this._colorTransform.alphaMultiplier*this._globalAlpha;if(this._renderDisplay.alpha=e,this._renderDisplay instanceof PIXI.Sprite||this._renderDisplay instanceof PIXI.SimpleMesh){var t=(Math.round(255*this._colorTransform.redMultiplier)<<16)+(Math.round(255*this._colorTransform.greenMultiplier)<<8)+Math.round(255*this._colorTransform.blueMultiplier);this._renderDisplay.tint=t}},t.prototype._updateFrame=function(){var e=this._textureData;if(0<=this._displayIndex&&null!==this._display&&null!==e){var t=e.parent;null!==this._armature.replacedTexture&&(null===this._armature._replaceTextureAtlasData?((t=BaseObject_1.BaseObject.borrowObject(PixiTextureAtlasData_1.PixiTextureAtlasData)).copyFrom(e.parent),t.renderTexture=this._armature.replacedTexture,this._armature._replaceTextureAtlasData=t):t=this._armature._replaceTextureAtlasData,e=t.getTexture(e.name));var r=e.renderTexture;if(null!==r){if(null!==this._geometryData){var a=this._geometryData.data,i=a.intArray,s=a.floatArray,o=i[this._geometryData.offset+0],l=i[this._geometryData.offset+1],n=i[this._geometryData.offset+2];n<0&&(n+=65536);var _=n+2*o,h=this._armature._armatureData.scale,p=this._renderDisplay,d=0<t.width?t.width:r.baseTexture.width,y=0<t.height?t.height:r.baseTexture.height,u=e.region;p.vertices=new Float32Array(2*o),p.geometry.getBuffer("aTextureCoord").data=new Float32Array(2*o),p.geometry.getIndex().data=new Uint16Array(3*l);for(var f=0,D=2*o;f<D;++f)p.vertices[f]=s[n+f]*h;for(f=0;f<3*l;++f)p.geometry.getIndex().data[f]=i[this._geometryData.offset+4+f];for(f=0,D=2*o;f<D;f+=2){var c=s[_+f],m=s[_+f+1];e.rotated?(p.geometry.getBuffer("aTextureCoord").data[f]=(u.x+(1-m)*u.width)/d,p.geometry.getBuffer("aTextureCoord").data[f+1]=(u.y+c*u.height)/y):(p.geometry.getBuffer("aTextureCoord").data[f]=(u.x+c*u.width)/d,p.geometry.getBuffer("aTextureCoord").data[f+1]=(u.y+m*u.height)/y)}this._textureScale=1,p.texture=r;var x=null!==this._geometryData.weight,b=0!==this._parent._boneData.type;(x||b)&&this._identityTransform()}else{var v;this._textureScale=e.parent.scale*this._armature._armatureData.scale,(v=this._renderDisplay).texture=r}return void(this._visibleDirty=!0)}}null!==this._geometryData?((p=this._renderDisplay).texture=null,p.x=0,p.y=0,p.visible=!1):((v=this._renderDisplay).texture=null,v.x=0,v.y=0,v.visible=!1)},t.prototype._updateMesh=function(){var e=this._armature._armatureData.scale,t=this._displayFrame.deformVertices,r=this._geometryBones,a=this._geometryData,i=a.weight,s=0<t.length&&a.inheritDeform,o=this._renderDisplay;if(null!==i){var l=(I=a.data).intArray,n=I.floatArray,_=l[a.offset+0],h=l[i.offset+1];h<0&&(h+=65536);for(var p=0,d=0,y=i.offset+2+r.length,u=h,f=0;p<_;++p){for(var D=l[y++],c=0,m=0,x=0;x<D;++x){var b=r[l[y++]];if(null!==b){var v=b.globalTransformMatrix,g=n[u++],T=n[u++]*e,M=n[u++]*e;s&&(T+=t[f++],M+=t[f++]),c+=(v.a*T+v.c*M+v.tx)*g,m+=(v.b*T+v.d*M+v.ty)*g}}o.vertices[d++]=c,o.vertices[d++]=m}}else{var I,S=0!==this._parent._boneData.type,E=(l=(I=a.data).intArray,n=I.floatArray,_=l[a.offset+0],l[a.offset+2]);E<0&&(E+=65536);p=0;for(var w=2*_;p<w;p+=2){var O=n[E+p]*e,P=n[E+p+1]*e;if(s&&(O+=t[p],P+=t[p+1]),S){v=this._parent._getGlobalTransformMatrix(O,P);o.vertices[p]=v.a*O+v.c*P+v.tx,o.vertices[p+1]=v.b*O+v.d*P+v.ty}else o.vertices[p]=O,o.vertices[p+1]=P}}},t.prototype._updateTransform=function(){throw new Error},t.prototype._updateTransformV3=function(){this.updateGlobalTransform();var e=this.global;if(this._renderDisplay===this._rawDisplay||this._renderDisplay===this._meshDisplay){var t=e.x-(this.globalTransformMatrix.a*this._pivotX+this.globalTransformMatrix.c*this._pivotY),r=e.y-(this.globalTransformMatrix.b*this._pivotX+this.globalTransformMatrix.d*this._pivotY);this._renderDisplay.setTransform(t,r,e.scaleX*this._textureScale,e.scaleY*this._textureScale,e.rotation,e.skew,0)}else this._renderDisplay.position.set(e.x,e.y),this._renderDisplay.rotation=e.rotation,this._renderDisplay.skew.set(e.skew,0),this._renderDisplay.scale.set(e.scaleX,e.scaleY)},t.prototype._updateTransformV4=function(){this.updateGlobalTransform();var e=this.global;if(this._renderDisplay===this._rawDisplay||this._renderDisplay===this._meshDisplay){var t=e.x-(this.globalTransformMatrix.a*this._pivotX+this.globalTransformMatrix.c*this._pivotY),r=e.y-(this.globalTransformMatrix.b*this._pivotX+this.globalTransformMatrix.d*this._pivotY);this._renderDisplay.setTransform(t,r,e.scaleX*this._textureScale,e.scaleY*this._textureScale,e.rotation,-e.skew,0)}else this._renderDisplay.position.set(e.x,e.y),this._renderDisplay.rotation=e.rotation,this._renderDisplay.skew.set(-e.skew,0),this._renderDisplay.scale.set(e.scaleX,e.scaleY)},t.prototype._identityTransform=function(){this._renderDisplay.setTransform(0,0,1,1,0,0,0)},t}(Slot_1.Slot);exports.PixiSlot=PixiSlot;