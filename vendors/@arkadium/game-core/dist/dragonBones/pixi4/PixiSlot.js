"use strict";var __extends=this&&this.__extends||function(){var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Slot_1=require("../armature/Slot"),PixiTextureAtlasData_1=require("./PixiTextureAtlasData"),BaseObject_1=require("../core/BaseObject"),PixiSlot=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.toString=function(){return"[class dragonBones.PixiSlot]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._textureScale=1,this._renderDisplay=null,this._updateTransform="3"===PIXI.VERSION[0]?this._updateTransformV3:this._updateTransformV4},e.prototype._initDisplay=function(t,e){},e.prototype._disposeDisplay=function(t,e){e||t.destroy()},e.prototype._onUpdateDisplay=function(){this._renderDisplay=this._display?this._display:this._rawDisplay},e.prototype._addDisplay=function(){this._armature.display.addChild(this._renderDisplay)},e.prototype._replaceDisplay=function(t){var e=this._armature.display,r=t;e.addChild(this._renderDisplay),e.swapChildren(this._renderDisplay,r),e.removeChild(r),this._textureScale=1},e.prototype._removeDisplay=function(){this._renderDisplay.parent.removeChild(this._renderDisplay)},e.prototype._updateZOrder=function(){var t=this._armature.display;t.getChildIndex(this._renderDisplay)!==this._zOrder&&t.addChildAt(this._renderDisplay,this._zOrder)},e.prototype._updateVisible=function(){this._renderDisplay.visible=this._parent.visible&&this._visible},e.prototype._updateBlendMode=function(){if(this._renderDisplay instanceof PIXI.Sprite)switch(this._blendMode){case 0:this._renderDisplay.blendMode=PIXI.BLEND_MODES.NORMAL;break;case 1:this._renderDisplay.blendMode=PIXI.BLEND_MODES.ADD;break;case 3:this._renderDisplay.blendMode=PIXI.BLEND_MODES.DARKEN;break;case 4:this._renderDisplay.blendMode=PIXI.BLEND_MODES.DIFFERENCE;break;case 6:this._renderDisplay.blendMode=PIXI.BLEND_MODES.HARD_LIGHT;break;case 9:this._renderDisplay.blendMode=PIXI.BLEND_MODES.LIGHTEN;break;case 10:this._renderDisplay.blendMode=PIXI.BLEND_MODES.MULTIPLY;break;case 11:this._renderDisplay.blendMode=PIXI.BLEND_MODES.OVERLAY;break;case 12:this._renderDisplay.blendMode=PIXI.BLEND_MODES.SCREEN}},e.prototype._updateColor=function(){var t=this._colorTransform.alphaMultiplier*this._globalAlpha;if(this._renderDisplay.alpha=t,this._renderDisplay instanceof PIXI.Sprite||this._renderDisplay instanceof PIXI.mesh.Mesh){var e=(Math.round(255*this._colorTransform.redMultiplier)<<16)+(Math.round(255*this._colorTransform.greenMultiplier)<<8)+Math.round(255*this._colorTransform.blueMultiplier);this._renderDisplay.tint=e}},e.prototype._updateFrame=function(){var t=this._textureData;if(0<=this._displayIndex&&null!==this._display&&null!==t){var e=t.parent;null!==this._armature.replacedTexture&&(null===this._armature._replaceTextureAtlasData?((e=BaseObject_1.BaseObject.borrowObject(PixiTextureAtlasData_1.PixiTextureAtlasData)).copyFrom(t.parent),e.renderTexture=this._armature.replacedTexture,this._armature._replaceTextureAtlasData=e):e=this._armature._replaceTextureAtlasData,t=e.getTexture(t.name));var r=t.renderTexture;if(null!==r){if(null!==this._geometryData){var a=this._geometryData.data,i=a.intArray,s=a.floatArray,o=i[this._geometryData.offset+0],l=i[this._geometryData.offset+1],n=i[this._geometryData.offset+2];n<0&&(n+=65536);var h=n+2*o,_=this._armature._armatureData.scale,p=this._renderDisplay,d=0<e.width?e.width:r.baseTexture.width,y=0<e.height?e.height:r.baseTexture.height,u=t.region;p.vertices=new Float32Array(2*o),p.uvs=new Float32Array(2*o),p.indices=new Uint16Array(3*l);for(var c=0,D=2*o;c<D;++c)p.vertices[c]=s[n+c]*_;for(c=0;c<3*l;++c)p.indices[c]=i[this._geometryData.offset+4+c];for(c=0,D=2*o;c<D;c+=2){var f=s[h+c],m=s[h+c+1];t.rotated?(p.uvs[c]=(u.x+(1-m)*u.width)/d,p.uvs[c+1]=(u.y+f*u.height)/y):(p.uvs[c]=(u.x+f*u.width)/d,p.uvs[c+1]=(u.y+m*u.height)/y)}this._textureScale=1,p.texture=r,p.dirty++,p.indexDirty++;var x=null!==this._geometryData.weight,v=0!==this._parent._boneData.type;(x||v)&&this._identityTransform()}else{var b;this._textureScale=t.parent.scale*this._armature._armatureData.scale,(b=this._renderDisplay).texture=r}return void(this._visibleDirty=!0)}}null!==this._geometryData?((p=this._renderDisplay).texture=null,p.x=0,p.y=0,p.visible=!1):((b=this._renderDisplay).texture=null,b.x=0,b.y=0,b.visible=!1)},e.prototype._updateMesh=function(){var t=this._armature._armatureData.scale,e=this._displayFrame.deformVertices,r=this._geometryBones,a=this._geometryData,i=a.weight,s=0<e.length&&a.inheritDeform,o=this._renderDisplay;if(null!==i){var l=(I=a.data).intArray,n=I.floatArray,h=l[a.offset+0],_=l[i.offset+1];_<0&&(_+=65536);for(var p=0,d=0,y=i.offset+2+r.length,u=_,c=0;p<h;++p){for(var D=l[y++],f=0,m=0,x=0;x<D;++x){var v=r[l[y++]];if(null!==v){var b=v.globalTransformMatrix,T=n[u++],M=n[u++]*t,g=n[u++]*t;s&&(M+=e[c++],g+=e[c++]),f+=(b.a*M+b.c*g+b.tx)*T,m+=(b.b*M+b.d*g+b.ty)*T}}o.vertices[d++]=f,o.vertices[d++]=m}}else{var I,S=0!==this._parent._boneData.type,E=(l=(I=a.data).intArray,n=I.floatArray,h=l[a.offset+0],l[a.offset+2]);E<0&&(E+=65536);p=0;for(var w=2*h;p<w;p+=2){var O=n[E+p]*t,P=n[E+p+1]*t;if(s&&(O+=e[p],P+=e[p+1]),S){b=this._parent._getGlobalTransformMatrix(O,P);o.vertices[p]=b.a*O+b.c*P+b.tx,o.vertices[p+1]=b.b*O+b.d*P+b.ty}else o.vertices[p]=O,o.vertices[p+1]=P}}},e.prototype._updateTransform=function(){throw new Error},e.prototype._updateTransformV3=function(){this.updateGlobalTransform();var t=this.global;if(this._renderDisplay===this._rawDisplay||this._renderDisplay===this._meshDisplay){var e=t.x-(this.globalTransformMatrix.a*this._pivotX+this.globalTransformMatrix.c*this._pivotY),r=t.y-(this.globalTransformMatrix.b*this._pivotX+this.globalTransformMatrix.d*this._pivotY);this._renderDisplay.setTransform(e,r,t.scaleX*this._textureScale,t.scaleY*this._textureScale,t.rotation,t.skew,0)}else this._renderDisplay.position.set(t.x,t.y),this._renderDisplay.rotation=t.rotation,this._renderDisplay.skew.set(t.skew,0),this._renderDisplay.scale.set(t.scaleX,t.scaleY)},e.prototype._updateTransformV4=function(){this.updateGlobalTransform();var t=this.global;if(this._renderDisplay===this._rawDisplay||this._renderDisplay===this._meshDisplay){var e=t.x-(this.globalTransformMatrix.a*this._pivotX+this.globalTransformMatrix.c*this._pivotY),r=t.y-(this.globalTransformMatrix.b*this._pivotX+this.globalTransformMatrix.d*this._pivotY);this._renderDisplay.setTransform(e,r,t.scaleX*this._textureScale,t.scaleY*this._textureScale,t.rotation,-t.skew,0)}else this._renderDisplay.position.set(t.x,t.y),this._renderDisplay.rotation=t.rotation,this._renderDisplay.skew.set(-t.skew,0),this._renderDisplay.scale.set(t.scaleX,t.scaleY)},e.prototype._identityTransform=function(){this._renderDisplay.setTransform(0,0,1,1,0,0,0)},e}(Slot_1.Slot);exports.PixiSlot=PixiSlot;