"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ParticleUtils_1=require("./ParticleUtils"),Particle_1=require("./Particle"),PropertyNode_1=require("./PropertyNode"),PolygonalChain_1=require("./PolygonalChain"),helperPoint=new PIXI.Point,Emitter=function(){function t(t,i,e){this._currentImageIndex=-1,this._particleConstructor=Particle_1.Particle,this.particleImages=null,this.startAlpha=null,this.startSpeed=null,this.minimumSpeedMultiplier=1,this.acceleration=null,this.maxSpeed=NaN,this.startScale=null,this.minimumScaleMultiplier=1,this.startColor=null,this.minLifetime=0,this.maxLifetime=0,this.minStartRotation=0,this.maxStartRotation=0,this.noRotation=!1,this.minRotationSpeed=0,this.maxRotationSpeed=0,this.particleBlendMode=0,this.customEase=null,this.extraData=null,this._frequency=1,this.spawnChance=1,this.maxParticles=1e3,this.emitterLifetime=-1,this.spawnPos=null,this.spawnType=null,this._spawnFunc=null,this.spawnRect=null,this.spawnCircle=null,this.spawnPolygonalChain=null,this.particlesPerWave=1,this.particleSpacing=0,this.angleStart=0,this.rotation=0,this.ownerPos=null,this._prevEmitterPos=null,this._prevPosIsValid=!1,this._posChanged=!1,this._parent=null,this.addAtBack=!1,this.particleCount=0,this._emit=!1,this._spawnTimer=0,this._emitterLife=-1,this._activeParticlesFirst=null,this._activeParticlesLast=null,this._poolFirst=null,this._origConfig=null,this._origArt=null,this._autoUpdate=!1,this._currentImageIndex=-1,this._destroyWhenComplete=!1,this._completeCallback=null,this.parent=t,i&&e&&this.init(i,e),this.recycle=this.recycle,this.update=this.update,this.rotate=this.rotate,this.updateSpawnPos=this.updateSpawnPos,this.updateOwnerPos=this.updateOwnerPos}return Object.defineProperty(t.prototype,"orderedArt",{get:function(){return-1!==this._currentImageIndex},set:function(t){this._currentImageIndex=t?0:-1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frequency",{get:function(){return this._frequency},set:function(t){this._frequency="number"==typeof t&&0<t?t:1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"particleConstructor",{get:function(){return this._particleConstructor},set:function(t){if(t!=this._particleConstructor){this._particleConstructor=t,this.cleanup();for(var i=this._poolFirst;i;i=i.next)i.destroy();this._poolFirst=null,this._origConfig&&this._origArt&&this.init(this._origArt,this._origConfig)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},set:function(t){this.cleanup(),this._parent=t},enumerable:!0,configurable:!0}),t.prototype.init=function(t,i){if(t&&i){this.cleanup(),this._origConfig=i,this._origArt=t,t=Array.isArray(t)?t.slice():[t];var e=this._particleConstructor;this.particleImages=e.parseArt?e.parseArt(t):t,i.alpha?this.startAlpha=PropertyNode_1.PropertyNode.createList(i.alpha):this.startAlpha=new PropertyNode_1.PropertyNode(1,0),i.speed?(this.startSpeed=PropertyNode_1.PropertyNode.createList(i.speed),this.minimumSpeedMultiplier=("minimumSpeedMultiplier"in i?i.minimumSpeedMultiplier:i.speed.minimumSpeedMultiplier)||1):(this.minimumSpeedMultiplier=1,this.startSpeed=new PropertyNode_1.PropertyNode(0,0));var a=i.acceleration;a&&(a.x||a.y)?(this.startSpeed.next=null,this.acceleration=new PIXI.Point(a.x,a.y),this.maxSpeed=i.maxSpeed||NaN):this.acceleration=new PIXI.Point,i.scale?(this.startScale=PropertyNode_1.PropertyNode.createList(i.scale),this.minimumScaleMultiplier=("minimumScaleMultiplier"in i?i.minimumScaleMultiplier:i.scale.minimumScaleMultiplier)||1):(this.startScale=new PropertyNode_1.PropertyNode(1,0),this.minimumScaleMultiplier=1),i.color?this.startColor=PropertyNode_1.PropertyNode.createList(i.color):this.startColor=new PropertyNode_1.PropertyNode({r:255,g:255,b:255},0),i.startRotation?(this.minStartRotation=i.startRotation.min,this.maxStartRotation=i.startRotation.max):this.minStartRotation=this.maxStartRotation=0,i.noRotation&&(this.minStartRotation||this.maxStartRotation)?this.noRotation=!!i.noRotation:this.noRotation=!1,i.rotationSpeed?(this.minRotationSpeed=i.rotationSpeed.min,this.maxRotationSpeed=i.rotationSpeed.max):this.minRotationSpeed=this.maxRotationSpeed=0,this.rotationAcceleration=i.rotationAcceleration||0,this.minLifetime=i.lifetime.min,this.maxLifetime=i.lifetime.max,this.particleBlendMode=ParticleUtils_1.ParticleUtils.getBlendMode(i.blendMode),i.ease?this.customEase="function"==typeof i.ease?i.ease:ParticleUtils_1.ParticleUtils.generateEase(i.ease):this.customEase=null,e.parseData?this.extraData=e.parseData(i.extraData):this.extraData=i.extraData||null,this.spawnRect=this.spawnCircle=null,this.particlesPerWave=1,i.particlesPerWave&&1<i.particlesPerWave&&(this.particlesPerWave=i.particlesPerWave),this.particleSpacing=0,this.angleStart=0,this.parseSpawnType(i),this.frequency=i.frequency,this.spawnChance="number"==typeof i.spawnChance&&0<i.spawnChance?i.spawnChance:1,this.emitterLifetime=i.emitterLifetime||-1,this.maxParticles=0<i.maxParticles?i.maxParticles:1e3,this.addAtBack=!!i.addAtBack,this.rotation=0,this.ownerPos=new PIXI.Point,this.spawnPos=new PIXI.Point(i.pos.x,i.pos.y),this.initAdditional(t,i),this._prevEmitterPos=this.spawnPos.clone(),this._prevPosIsValid=!1,this._spawnTimer=0,this.emit=void 0===i.emit||!!i.emit,this.autoUpdate=!!i.autoUpdate,this.orderedArt=!!i.orderedArt}},t.prototype.initAdditional=function(t,i){},t.prototype.parseSpawnType=function(t){var i;switch(t.spawnType){case"rect":this.spawnType="rect",this._spawnFunc=this._spawnRect;var e=t.spawnRect;this.spawnRect=new PIXI.Rectangle(e.x,e.y,e.w,e.h);break;case"circle":this.spawnType="circle",this._spawnFunc=this._spawnCircle,i=t.spawnCircle,this.spawnCircle=new PIXI.Circle(i.x,i.y,i.r);break;case"ring":this.spawnType="ring",this._spawnFunc=this._spawnRing,i=t.spawnCircle,this.spawnCircle=new PIXI.Circle(i.x,i.y,i.r),this.spawnCircle.minRadius=i.minR;break;case"burst":this.spawnType="burst",this._spawnFunc=this._spawnBurst,this.particleSpacing=t.particleSpacing,this.angleStart=t.angleStart?t.angleStart:0;break;case"point":this.spawnType="point",this._spawnFunc=this._spawnPoint;break;case"polygonalChain":this.spawnType="polygonalChain",this._spawnFunc=this._spawnPolygonalChain,this.spawnPolygonalChain=new PolygonalChain_1.PolygonalChain(t.spawnPolygon);break;default:this.spawnType="point",this._spawnFunc=this._spawnPoint}},t.prototype.recycle=function(t){t.next&&(t.next.prev=t.prev),t.prev&&(t.prev.next=t.next),t==this._activeParticlesLast&&(this._activeParticlesLast=t.prev),t==this._activeParticlesFirst&&(this._activeParticlesFirst=t.next),t.prev=null,t.next=this._poolFirst,(this._poolFirst=t).parent&&t.parent.removeChild(t),--this.particleCount},t.prototype.rotate=function(t){if(this.rotation!=t){var i=t-this.rotation;this.rotation=t,ParticleUtils_1.ParticleUtils.rotatePoint(i,this.spawnPos),this._posChanged=!0}},t.prototype.updateSpawnPos=function(t,i){this._posChanged=!0,this.spawnPos.x=t,this.spawnPos.y=i},t.prototype.updateOwnerPos=function(t,i){this._posChanged=!0,this.ownerPos.x=t,this.ownerPos.y=i},t.prototype.resetPositionTracking=function(){this._prevPosIsValid=!1},Object.defineProperty(t.prototype,"emit",{get:function(){return this._emit},set:function(t){this._emit=!!t,this._emitterLife=this.emitterLifetime},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"autoUpdate",{get:function(){return this._autoUpdate},set:function(t){this._autoUpdate&&!t||this._autoUpdate,this._autoUpdate=!!t},enumerable:!0,configurable:!0}),t.prototype.playOnceAndDestroy=function(t){this.autoUpdate=!0,this.emit=!0,this._destroyWhenComplete=!0,this._completeCallback=t},t.prototype.playOnce=function(t){this.emit=!0,this._completeCallback=t},t.prototype.update=function(t){if(this._autoUpdate&&(t=t/PIXI.settings.TARGET_FPMS/1e3),this._parent){var i,e,a,s,r;for(e=this._activeParticlesFirst;e;e=a)a=e.next,e.update(t);this._prevPosIsValid&&(s=this._prevEmitterPos.x,r=this._prevEmitterPos.y);var n=this.ownerPos.x+this.spawnPos.x,o=this.ownerPos.y+this.spawnPos.y;if(this._emit)for(this._spawnTimer-=t<0?0:t;this._spawnTimer<=0;){if(0<this._emitterLife&&(this._emitterLife-=this._frequency,this._emitterLife<=0)){this._spawnTimer=0,this._emitterLife=0,this.emit=!1;break}if(this.particleCount>=this.maxParticles)this._spawnTimer+=this._frequency;else{var h=void 0;if(h=this.minLifetime==this.maxLifetime?this.minLifetime:Math.random()*(this.maxLifetime-this.minLifetime)+this.minLifetime,-this._spawnTimer<h){var p=void 0,l=void 0;if(this._prevPosIsValid&&this._posChanged){var c=1+this._spawnTimer/t;p=(n-s)*c+s,l=(o-r)*c+r}else p=n,l=o;i=0;for(var m=Math.min(this.particlesPerWave,this.maxParticles-this.particleCount);i<m;++i)if(!(this.spawnChance<1&&Math.random()>=this.spawnChance)){var u=void 0;if(this._poolFirst?(u=this._poolFirst,this._poolFirst=this._poolFirst.next,u.next=null):u=new this.particleConstructor(this),1<this.particleImages.length?-1!==this._currentImageIndex?(u.applyArt(this.particleImages[this._currentImageIndex++]),(this._currentImageIndex<0||this._currentImageIndex>=this.particleImages.length)&&(this._currentImageIndex=0)):u.applyArt(this.particleImages[Math.floor(Math.random()*this.particleImages.length)]):u.applyArt(this.particleImages[0]),u.alphaList.reset(this.startAlpha),1!=this.minimumSpeedMultiplier&&(u.speedMultiplier=Math.random()*(1-this.minimumSpeedMultiplier)+this.minimumSpeedMultiplier),u.speedList.reset(this.startSpeed),u.acceleration.x=this.acceleration.x,u.acceleration.y=this.acceleration.y,u.maxSpeed=this.maxSpeed,1!=this.minimumScaleMultiplier&&(u.scaleMultiplier=Math.random()*(1-this.minimumScaleMultiplier)+this.minimumScaleMultiplier),u.scaleList.reset(this.startScale),u.colorList.reset(this.startColor),this.minRotationSpeed==this.maxRotationSpeed?u.rotationSpeed=this.minRotationSpeed:u.rotationSpeed=Math.random()*(this.maxRotationSpeed-this.minRotationSpeed)+this.minRotationSpeed,u.rotationAcceleration=this.rotationAcceleration,u.noRotation=this.noRotation,u.maxLife=h,u.blendMode=this.particleBlendMode,u.ease=this.customEase,u.extraData=this.extraData,this.applyAdditionalProperties(u),this._spawnFunc(u,p,l,i),u.init(),u.update(-this._spawnTimer),u.parent){var d=this._parent.children;if(d[0]==u)d.shift();else if(d[d.length-1]==u)d.pop();else{var P=d.indexOf(u);d.splice(P,1)}this.addAtBack?d.unshift(u):d.push(u)}else this.addAtBack?this._parent.addChildAt(u,0):this._parent.addChild(u);this._activeParticlesLast?((this._activeParticlesLast.next=u).prev=this._activeParticlesLast,this._activeParticlesLast=u):this._activeParticlesLast=this._activeParticlesFirst=u,++this.particleCount}}this._spawnTimer+=this._frequency}}if(this._posChanged&&(this._prevEmitterPos.x=n,this._prevEmitterPos.y=o,this._prevPosIsValid=!0,this._posChanged=!1),!this._emit&&!this._activeParticlesFirst){if(this._completeCallback){var _=this._completeCallback;this._completeCallback=null,_()}this._destroyWhenComplete&&this.destroy()}}},t.prototype.applyAdditionalProperties=function(t){},t.prototype._spawnPoint=function(t,i,e){this.minStartRotation==this.maxStartRotation?t.rotation=this.minStartRotation+this.rotation:t.rotation=Math.random()*(this.maxStartRotation-this.minStartRotation)+this.minStartRotation+this.rotation,t.position.x=i,t.position.y=e},t.prototype._spawnRect=function(t,i,e){this.minStartRotation==this.maxStartRotation?t.rotation=this.minStartRotation+this.rotation:t.rotation=Math.random()*(this.maxStartRotation-this.minStartRotation)+this.minStartRotation+this.rotation,helperPoint.x=Math.random()*this.spawnRect.width+this.spawnRect.x,helperPoint.y=Math.random()*this.spawnRect.height+this.spawnRect.y,0!==this.rotation&&ParticleUtils_1.ParticleUtils.rotatePoint(this.rotation,helperPoint),t.position.x=i+helperPoint.x,t.position.y=e+helperPoint.y},t.prototype._spawnCircle=function(t,i,e){this.minStartRotation==this.maxStartRotation?t.rotation=this.minStartRotation+this.rotation:t.rotation=Math.random()*(this.maxStartRotation-this.minStartRotation)+this.minStartRotation+this.rotation,helperPoint.x=Math.random()*this.spawnCircle.radius,helperPoint.y=0,ParticleUtils_1.ParticleUtils.rotatePoint(360*Math.random(),helperPoint),helperPoint.x+=this.spawnCircle.x,helperPoint.y+=this.spawnCircle.y,0!==this.rotation&&ParticleUtils_1.ParticleUtils.rotatePoint(this.rotation,helperPoint),t.position.x=i+helperPoint.x,t.position.y=e+helperPoint.y},t.prototype._spawnRing=function(t,i,e){var a=this.spawnCircle;this.minStartRotation==this.maxStartRotation?t.rotation=this.minStartRotation+this.rotation:t.rotation=Math.random()*(this.maxStartRotation-this.minStartRotation)+this.minStartRotation+this.rotation,a.minRadius!==a.radius?helperPoint.x=Math.random()*(a.radius-a.minRadius)+a.minRadius:helperPoint.x=a.radius,helperPoint.y=0;var s=360*Math.random();t.rotation+=s,ParticleUtils_1.ParticleUtils.rotatePoint(s,helperPoint),helperPoint.x+=this.spawnCircle.x,helperPoint.y+=this.spawnCircle.y,0!==this.rotation&&ParticleUtils_1.ParticleUtils.rotatePoint(this.rotation,helperPoint),t.position.x=i+helperPoint.x,t.position.y=e+helperPoint.y},t.prototype._spawnPolygonalChain=function(t,i,e){this.minStartRotation==this.maxStartRotation?t.rotation=this.minStartRotation+this.rotation:t.rotation=Math.random()*(this.maxStartRotation-this.minStartRotation)+this.minStartRotation+this.rotation,this.spawnPolygonalChain.getRandomPoint(helperPoint),0!==this.rotation&&ParticleUtils_1.ParticleUtils.rotatePoint(this.rotation,helperPoint),t.position.x=i+helperPoint.x,t.position.y=e+helperPoint.y},t.prototype._spawnBurst=function(t,i,e,a){0===this.particleSpacing?t.rotation=360*Math.random():t.rotation=this.angleStart+this.particleSpacing*a+this.rotation,t.position.x=i,t.position.y=e},t.prototype.cleanup=function(){var t,i;for(t=this._activeParticlesFirst;t;t=i)i=t.next,this.recycle(t),t.parent&&t.parent.removeChild(t);this._activeParticlesFirst=this._activeParticlesLast=null,this.particleCount=0},t.prototype.destroy=function(){var t;this.autoUpdate=!1,this.cleanup();for(var i=this._poolFirst;i;i=t)t=i.next,i.destroy();this._poolFirst=this._parent=this.particleImages=this.spawnPos=this.ownerPos=this.startColor=this.startScale=this.startAlpha=this.startSpeed=this.customEase=this._completeCallback=null},t}();exports.Emitter=Emitter;