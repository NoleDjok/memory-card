"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __decorate=this&&this.__decorate||function(t,e,n,i){var o,a=arguments.length,l=a<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(t,e,n,i);else for(var r=t.length-1;0<=r;r--)(o=t[r])&&(l=(a<3?o(l):3<a?o(e,n,l):o(e,n))||l);return 3<a&&l&&Object.defineProperty(e,n,l),l},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__param=this&&this.__param||function(n,i){return function(t,e){i(t,e,n)}};Object.defineProperty(exports,"__esModule",{value:!0});var __1=require(".."),MultiplayerClientBase_1=require("./MultiplayerClientBase"),WatchObject_1=require("../Base/Model/WatchObject"),Linq_1=require("../Linq/Linq"),expandFunc_1=require("../Base/expandFunc"),typescript_ioc_1=require("../IoC/typescript-ioc"),MultiplayerEventsEnum_1=require("./MultiplayerEventsEnum"),MultiplayerModelWatchItem=function(){function t(t,e,n,i,o){this.key=t,this.client=e,this.context=n,this._event=i,this._multiplayerClient=o,this._queue=new __1.Queue,this.disposed=!1,this.delay=0,this.step=1,this._valueDelay=0,this._actionDelay=0,this._currentValue=null,this._values=[],this._disableAction=!1;var a=this;this.event=function(t,e,n,i){a.disposed||n==a.name&&this==a.context&&a.run(t,e)},this._actionInit([this.context[this.key]])}return t.prototype.setValues=function(t){this._disableAction=!0;for(var e=0;e<t.length;e++)this.context[this.key]=t[e];this._disableAction=!1},t.prototype._send=function(t,e){this._currentValue=t,this._actionDelay<=0||this._valueDelay<=0&&(this._values.push(t),this._valueDelay=this.delay/this.step)},t.prototype._actionInit=function(t){var e={model:this.key,values:[],type:-2,client:this.client};this._multiplayerClient.action(e)},t.prototype._action=function(t){var e={model:this.key,values:t,type:-1,client:this.client};this._multiplayerClient.action(e)},t.prototype.run=function(n,i){var o=this;this._disableAction?this._queue.push({condition:function(t){return!0},action:function(t,e){o._event(n,i)}},{newVal:n,oldVal:i}):this._queue.push({condition:function(t){return!0},action:function(t,e){o._event(n,i),o._send(n,i)}},{newVal:n,oldVal:i})},t.prototype.update=function(t){this._queue.update(t),0<this._actionDelay&&(this._actionDelay-=t),0<this._valueDelay&&(this._valueDelay-=t),null!==this._currentValue&&this._actionDelay<=0&&(this._values.push(this._currentValue),this._action(this._values),this._currentValue=null,this._values=[],this._actionDelay=this.delay)},t}(),MultiplayerModelWatchesList=function(){function t(t,e){this._watchObject=t,this._multiplayerClient=e,this.items=new Linq_1.List}return t.prototype.get=function(t){return this[t]},t.prototype.add=function(t,l,r,s){var c=this;__1._u.each(t,function(t,e){if(null!=r&&null!=r){var n=expandFunc_1.expandFunc(t.callback,l),i=new MultiplayerModelWatchItem(e,s,r,n,c._multiplayerClient),o=e.split(".");if(i.name=o[o.length-1],i.delay=t.delay||i.delay,i.step=t.step||i.step,1<o.length)for(var a=0;a<o.length-1;a++){if(!i.context[o[a]])return void console.error(c.constructor.name+": 1. error can't find model property '"+o[a]+"' for '"+e+"'",i.context);i.context=i.context[o[a]]}null!=i.context[i.name]&&null!=i.context[i.name]?(c.items.Add(i),c[e]=i,c._watchObject.watch(i.context,i.name,i.event)):console.error(c.constructor.name+": 2. error can't find model property '"+i.name+"' for '"+e+"'",i.context)}else console.error(c.constructor.name+": error $model is null for property '"+e+"'")},this)},t.prototype.dispose=function(){var e=this;this.items.ForEach(function(t){t.disposed=!0,e._watchObject.unwatch(t.context,t.name,t.event)}),this._watchObject=null},t.prototype.updateModel=function(e,n){this.items.ForEach(function(t){t.key==e&&t.setValues(n)})},t.prototype.update=function(e){this.items.ForEach(function(t){t.update(e)})},t}(),MultiplayerModelConnectorClient=function(){function t(t,e,n){this._config=t,this._multiplayerClient=e,this._random=n,this._model=t.model,this._name=t.connectionId,this._playerId=e.playerId,this._watchObject=typescript_ioc_1.Container.get(WatchObject_1.WatchObject),this._$modelWatches=new MultiplayerModelWatchesList(this._watchObject,this._multiplayerClient)}return t.prototype._updateGame=function(t,e){switch(t.type){case-1:e!=this._playerId&&t.client==this._name&&this._$modelWatches.updateModel(t.model,t.values)}},t.prototype.updateServer=function(t,e){switch(t.type){case-2:t.client==this._name&&(t.type=-1,t.values=[this._model[t.model]],this._multiplayerClient.serverBroadcast(t))}},t.prototype.start=function(){var o=this;this._multiplayerClient.players.ForEach(function(t,e){o._multiplayerClient.playerId==t.id?o._config.onAddPlayer&&o._config.onAddPlayer(t):o._config.onAddPlayerOpponent&&o._config.onAddPlayerOpponent(t)}),this._onGameUpdate=function(t){for(var e=0;e<t.length;e++)for(var n=t[e],i=0;i<n.actions.length;i++)o._updateGame(n.actions[i].data,n.playerId)},this._multiplayerClient.onGameUpdate(this._onGameUpdate),this._config.onAddPlayer&&this._multiplayerClient.onAddPlayer(this._config.onAddPlayer),this._config.onAddPlayerOpponent&&this._multiplayerClient.onAddPlayerOpponent(this._config.onAddPlayerOpponent),this._config.onGameUpdate&&this._multiplayerClient.onGameUpdate(this._config.onGameUpdate),this._config.onPlayerJoin&&this._multiplayerClient.onPlayerJoin(this._config.onPlayerJoin),this._config.onPlayerLeft&&this._multiplayerClient.onPlayerLeft(this._config.onPlayerLeft),this._config.onSetServer&&this._multiplayerClient.onSetServer(this._config.onSetServer),this._config.onStartMatch&&this._multiplayerClient.onStartMatch(this._config.onStartMatch),this._config.onUpdatePlayer&&this._multiplayerClient.onUpdatePlayer(this._config.onUpdatePlayer),this._$modelWatches.add(this._config.modelWatch,this,this._model,this._config.connectionId)},t.prototype.stop=function(){this._$modelWatches.dispose(),this._multiplayerClient.off(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updateGame,this._onGameUpdate),this._config.onAddPlayer&&this._multiplayerClient.off(MultiplayerEventsEnum_1.MultiplayerEventsEnum.addPlayer,this._config.onAddPlayer),this._config.onAddPlayerOpponent&&this._multiplayerClient.off(MultiplayerEventsEnum_1.MultiplayerEventsEnum.addPlayerOpponent,this._config.onAddPlayerOpponent),this._config.onGameUpdate&&this._multiplayerClient.off(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updateGame,this._config.onGameUpdate),this._config.onPlayerJoin&&this._multiplayerClient.off(MultiplayerEventsEnum_1.MultiplayerEventsEnum.playerJoin,this._config.onPlayerJoin),this._config.onPlayerLeft&&this._multiplayerClient.off(MultiplayerEventsEnum_1.MultiplayerEventsEnum.playerLeft,this._config.onPlayerLeft),this._config.onSetServer&&this._multiplayerClient.off(MultiplayerEventsEnum_1.MultiplayerEventsEnum.setServer,this._config.onSetServer),this._config.onStartMatch&&this._multiplayerClient.off(MultiplayerEventsEnum_1.MultiplayerEventsEnum.startMatch,this._config.onStartMatch),this._config.onUpdatePlayer&&this._multiplayerClient.off(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updatePlayer,this._config.onUpdatePlayer)},t.prototype.dispose=function(){this.stop()},t.prototype.update=function(t){this._$modelWatches.update(t)},t=__decorate([__param(0,__1.Inject),__param(1,__1.Inject),__param(2,__1.Inject),__metadata("design:paramtypes",[Object,MultiplayerClientBase_1.MultiplayerClient,__1.Random])],t)}();exports.MultiplayerModelConnectorClient=MultiplayerModelConnectorClient;var MultiplayerModelConnectorServer=function(){function t(t,e,n){var i=this;this._config=t,this._multiplayerClient=e,this._random=n,this._model=t.model,this._name=t.connectionId,this._multiplayerClient.players.ForEach(function(t,e){i._multiplayerClient.playerId==t.id?i._config.onAddPlayer&&i._config.onAddPlayer(t):i._config.onAddPlayerOpponent&&i._config.onAddPlayerOpponent(t)}),this._config.onAddPlayer&&this._multiplayerClient.onAddPlayer(this._config.onAddPlayer),this._config.onAddPlayerOpponent&&this._multiplayerClient.onAddPlayerOpponent(this._config.onAddPlayerOpponent),t.onGameServerUpdate&&this._multiplayerClient.onGameServerUpdate(t.onGameServerUpdate),t.onPlayerJoin&&this._multiplayerClient.onPlayerJoin(t.onPlayerJoin),t.onPlayerLeft&&this._multiplayerClient.onPlayerLeft(t.onPlayerLeft),t.onSetServer&&this._multiplayerClient.onSetServer(t.onSetServer),t.onStartMatch&&this._multiplayerClient.onStartMatch(t.onStartMatch),t.onUpdatePlayer&&this._multiplayerClient.onUpdatePlayer(t.onUpdatePlayer)}return t.prototype.updateGame=function(t,e){switch(t.type){case-1:if(t.client==this._name)for(var n=0;n<t.values.length;n++)this._config.modelWatch[t.model].callback(t.values[n])}},t.prototype.dispose=function(){},t.prototype.update=function(t){},t=__decorate([__param(0,__1.Inject),__param(1,__1.Inject),__param(2,__1.Inject),__metadata("design:paramtypes",[Object,MultiplayerClientBase_1.MultiplayerClient,__1.Random])],t)}();exports.MultiplayerModelConnectorServer=MultiplayerModelConnectorServer;var MultiplayerModelConnector=function(){function t(t){var o=this;this._multiplayerClient=t,this._clients=[],this._servers=[],this._multiplayerClient.onGameServerUpdate(function(t){for(var e=0;e<t.length;e++)for(var n=t[e],i=0;i<n.actions.length;i++)o.updateConnectionServer(n.actions[i].data,n.playerId)})}return t.prototype.addConnection=function(t){var e=typescript_ioc_1.Container.get(MultiplayerModelConnectorClient,t||{});return this._clients.push(e),e},t.prototype.addConnectionServer=function(t){var e=typescript_ioc_1.Container.get(MultiplayerModelConnectorServer,t||{});return this._servers.push(e),e},t.prototype.update=function(t){for(var e=0;e<this._servers.length;e++)this._servers[e].update(t);for(e=0;e<this._clients.length;e++)this._clients[e].update(t)},t.prototype.updateConnectionServer=function(t,e){switch(t.type){case-1:this._multiplayerClient.serverBroadcast(t,e)}for(var n=0;n<this._clients.length;n++)this._clients[n].updateServer(t,e);for(n=0;n<this._servers.length;n++)this._servers[n].updateGame(t,e)},t=__decorate([__1.Singleton,__param(0,__1.Inject),__metadata("design:paramtypes",[MultiplayerClientBase_1.MultiplayerClient])],t)}();exports.MultiplayerModelConnector=MultiplayerModelConnector;