"use strict";
/*!@license
 * Copyright (c) Arkadium Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 * Proprietary and confidential
 * Written by Denis Gusarov <denis.gusarov@arkadium.com>
 */var __awaiter=this&&this.__awaiter||function(e,s,c,a){return new(c||(c=Promise))(function(n,t){function r(e){try{o(a.next(e))}catch(e){t(e)}}function i(e){try{o(a.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):(t=e.value,t instanceof c?t:new c(function(e){e(t)})).then(r,i)}o((a=a.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(n,r){var i,o,s,e,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,o=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){c.label=t[1];break}if(6===t[0]&&c.label<s[1]){c.label=s[1],s=t;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(t);break}s[2]&&c.ops.pop(),c.trys.pop();continue}t=r.call(n,c)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var __1=require(".."),Linq_1=require("../Linq/Linq"),SimplePeer=require("simple-peer"),wrtc=require("wrtc"),Peer=function(){function e(e){this.id=e,this.received=0,this.sent=0,this._queue=new __1.Queue}return e.prototype.create=function(t,r){return void 0===r&&(r=0),__awaiter(this,void 0,void 0,function(){var n=this;return __generator(this,function(e){switch(e.label){case 0:return this._initiator=t,this._peer&&this._peer.destroy(),this._peer=new SimplePeer({initiator:t,channelName:this.id,wrtc:wrtc}),this._peer.on("signal",function(t){0==n._queue.length?n._queue.push({condition:function(e){return 1<e},action:function(e){n.trigger("signal",t)}}):n._queue.push({condition:function(e){return!0},action:function(e){n.trigger("signal",t)}})}),this._peer.on("close",function(){console.log("PEER close"),n.trigger("close",{})}),this._peer.on("error",function(e){console.log("error",e),n.trigger("error",{})}),this._peer.on("data",function(e){n.trigger("data",JSON.parse(e))}),this._peer.on("connect",function(){console.log("WEBRTC connected!"),n.trigger("connect",{})}),[4,this.delay(5e3)];case 1:return e.sent(),[4,this._checkConnect(++r)];case 2:return e.sent(),[2]}})})},e.prototype._checkConnect=function(n){return void 0===n&&(n=0),__awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return 5<n?[2]:this._peer.connected||this._peer.destroyed?[3,3]:this._initiator?[4,this.create(this._initiator,n)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[3,4];case 3:this._queue.push({condition:function(e){return 1<e},action:function(e){return __awaiter(t,void 0,void 0,function(){return __generator(this,function(e){return this._checkConnect(++n),[2]})})}}),e.label=4;case 4:return[2]}})})},e.prototype.signal=function(e){this._peer.connected||this._peer.signal(e)},e.prototype.destroy=function(){this._peer&&(this._queue.clear(),this._peer.destroy())},e.prototype.send=function(e){this._peer.connected&&this._peer.send(e)},e.prototype.isConnected=function(){return this._peer.connected},e.prototype.getStats=function(){this._peer&&this._peer.connected},e.prototype.delay=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,new Promise(function(e,t){setTimeout(function(){e()},n)})]})})},e.prototype.update=function(e){this._queue.update(e)},e.prototype.on=function(e,t,n){this.__$eventListeners_=this.__$eventListeners_||{},this.__$eventListeners_[e]=this.__$eventListeners_[e]||[],this.__$eventListeners_[e].push({callback:t,context:n||this})},e.prototype.off=function(e,t){this.__$eventListeners_=this.__$eventListeners_||{};for(var n=this.__$eventListeners_[e]||[],r=0;r<n.length;r++)if(n[r].callback===t)return void n.splice(r,1)},e.prototype.trigger=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.__$eventListeners_=this.__$eventListeners_||{};for(var r=this.__$eventListeners_[e]||[],i=0;i<r.length;i++)r[i].callback.apply(r[i].context,Array.prototype.slice.call(arguments,1))},e}();exports.Peer=Peer;var Peers=function(){function e(){this._peers=new Linq_1.List,this.dataReceivedTotalSize=0,this.dataSentTotalSize=0,this._dataReceivedTotalSize=0,this._dataSentTotalSize=0}return e.prototype.getPeer=function(t){var e=this._peers.FirstOrDefault(function(e){return e.id==t});return e||(e=new Peer(t),this._peers.Add(e)),e},e.prototype.server=function(e){this.destroy(e),this.getPeer(e).create(!0)},e.prototype.client=function(e){this.destroy(e),this.getPeer(e).create(!1)},e.prototype.signal=function(t,e){var n=this._peers.FirstOrDefault(function(e){return e.id==t});n&&n.signal(e)},e.prototype.destroy=function(t){var e=this._peers.FirstOrDefault(function(e){return e.id==t});e&&(this._dataReceivedTotalSize+=e.received,this._dataSentTotalSize+=e.sent,e.destroy(),this._peers.Remove(e))},e.prototype.destroyAll=function(){for(var e=this._peers.Count()-1;0<=e;e--){var t=this._peers.ElementAt(e);t&&(this._dataReceivedTotalSize+=t.received,this._dataSentTotalSize+=t.sent,t.destroy(),this._peers.Remove(t))}},e.prototype.send=function(t){this._peers.ForEach(function(e){e.send(JSON.stringify(t))})},e.prototype.getStats=function(){var t=0,n=0;this._peers.ForEach(function(e){e.getStats(),t+=e.received,n+=e.sent}),this.dataReceivedTotalSize=this._dataReceivedTotalSize+t,this.dataSentTotalSize=this._dataSentTotalSize+n},e.prototype.isConnected=function(t){var e=this._peers.FirstOrDefault(function(e){return e.id==t});return!!e&&e.isConnected()},e.prototype.update=function(t){this._peers.ForEach(function(e){e.update(t)})},e}();exports.Peers=Peers;