"use strict";var __extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(e,a,o,u){return new(o||(o=Promise))(function(r,t){function n(e){try{s(u.next(e))}catch(e){t(e)}}function i(e){try{s(u.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(n,i)}s((u=u.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(r,n){var i,s,a,e,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,s&&(a=2&t[0]?s.return:t[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,t[1])).done)return a;switch(s=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,s=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(a=0<(a=o.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){o.label=t[1];break}if(6===t[0]&&o.label<a[1]){o.label=a[1],a=t;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(t);break}a[2]&&o.ops.pop(),o.trys.pop();continue}t=n.call(r,o)}catch(e){t=[6,e],s=0}finally{i=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var Player_1=require("./models/Player"),Linq_1=require("../Linq/Linq"),Peers_1=require("./Peers"),ActionType_1=require("./ActionType"),__1=require(".."),Utils_1=require("./Utils"),MultiplayerEventsEnum_1=require("./MultiplayerEventsEnum"),MultiplayerClientBase=function(){function e(){this.__serverUpdateDelay=.25,this.__serverPeersUpdateDelay=.1,this.traceEvents=0,this.__isCompressingTraffic=!0,this.__disableDirectConnections=!1,this.__queue=new __1.Queue,this.__serverUpdateTimeOut=0,this._startedUtc=null,this._playerActions=[],this._playerActionIndex=0,this._serverActionsQueues=[],this._serverActionsQueueIndex=0,this._broadcastActionsQueue=[],this._currentBroadcastActionIndex=-1,this._serverBroadcastActionIndex=-1,this._peers=new Peers_1.Peers,this._timeOutPeers=0,this._timeOutPeersStats=5,this.setData=!1,this.data="",this.players=new Linq_1.List,this.isServer=!1,this._playersPeersConnected={}}return Object.defineProperty(e.prototype,"serverUps",{get:function(){return 1/this.__serverUpdateDelay},set:function(e){this.__serverUpdateDelay=1/e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"peersUps",{get:function(){return 1/this.__serverPeersUpdateDelay},set:function(e){this.__serverPeersUpdateDelay=1/e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isCompressingTraffic",{get:function(){return this.__isCompressingTraffic},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"disableDirectConnections",{get:function(){return this.__disableDirectConnections},set:function(e){this.__disableDirectConnections!=e&&(this.__disableDirectConnections=e,this.__disableDirectConnections&&this.isServer?this._createPeers():this._peers.destroyAll())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"playerId",{get:function(){return this._playerId},enumerable:!0,configurable:!0}),e.prototype.action=function(e,t){var r=t||this._playerId,n={id:this._playerActionIndex++,data:e},i=this._serverActionsQueues.filter(function(e){return e.playerId==r})[0];this.isServer?i?i.actions.push(n):this._serverActionsQueues.push({type:0,id:this._serverActionsQueueIndex++,playerId:r,actions:[n]}):(this._playerActions.push(n),this._peers.send({type:"sendGameActionAsync",data:{gameId:this._gameId,playerId:r,actionType:ActionType_1.ActionType.sendActions,action:{actions:[n]}}}))},e.prototype.serverBroadcast=function(e,t){var r={data:e};if(this.isServer)if(t){var n={type:1,id:this._serverBroadcastActionIndex++,playerId:t,actions:[r]};this._broadcastActionsQueue.push(n)}else{n={type:1,id:this._serverBroadcastActionIndex++,actions:[r]};this._broadcastActionsQueue.push(n)}},e.prototype.setPlayerData=function(e,t){var r=t||this._playerId;this.setData=!0;var n=this.players.FirstOrDefault(function(e){return e.id==r});n&&(n.data=e,this.data=e),this.isServer||this._peers.send({type:"sendGameActionAsync",data:{gameId:this._gameId,playerId:r,actionType:ActionType_1.ActionType.updateData,action:{data:this.data}}})},e.prototype._updateGame=function(e,t){var r=this;if(!t&&this._peers.isConnected(this._playerId));else for(var n=0;n<e.game.players.length;n++){var i=e.game.players[n];this._addOrUpdatePlayer(i)}var s=e.queue||[];e.game.startedUtc&&this._startedUtc!=e.game.startedUtc&&(this._startedUtc=e.game.startedUtc,this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.startMatch));var a=s.filter(function(e){return e.id>r._currentBroadcastActionIndex});this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updateGame,a);for(n=0;n<s.length;n++){this._currentBroadcastActionIndex=Math.max(this._currentBroadcastActionIndex,s[n].id),this.isServer||(this._serverBroadcastActionIndex=this._currentBroadcastActionIndex);for(var o=this._broadcastActionsQueue.length-1;0<=o;o--)s[n].id==this._broadcastActionsQueue[o].id&&this._broadcastActionsQueue.splice(o,1)}},e.prototype._addOrUpdatePlayer=function(t){var e=this.players.FirstOrDefault(function(e){return e.id==t.id});if(this.itIsMe(t.id)&&t.isServer!=this.isServer&&this._setServer(t.isServer),e)this.isServer&&0<e.type||e.copy(t),this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updatePlayer,e);else{var r=Player_1.Player.fromObject(t);this.players.Add(r),this.itIsMe(r.id)?this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.addPlayer,r):this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.addPlayerOpponent,r)}},e.prototype.itIsMe=function(e){return e==this._playerId},e.prototype._playerStateChanged=function(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return this.itIsMe(r.player.id)?(t=r.player.isServer,this.isServer==t?[3,2]:[4,this._setServer(t)]):[3,3];case 1:e.sent(),e.label=2;case 2:return[3,3];case 3:return[2]}})})},e.prototype._gameAction=function(t){switch(t.actionType){case ActionType_1.ActionType.updateData:(e=this.players.FirstOrDefault(function(e){return e.id==t.playerId})).data=t.action.data,this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updatePlayer,e);break;case ActionType_1.ActionType.sendActions:if(this.isServer&&t.playerId){for(var e=this.players.FirstOrDefault(function(e){return e.id==t.playerId}),r=[],n=0;n<t.action.actions.length;n++){var i=t.action.actions[n];e&&e.action<i.id&&(e.action=i.id,r.push(i))}this._serverActionsQueues.push({type:0,id:this._serverActionsQueueIndex++,playerId:t.playerId,actions:r})}}},e.prototype._updateServerPeers=function(e){this._timeOutPeers-=e,0<=this._timeOutPeers||(this.isServer&&this._peers.send({type:"updateGameAsync",data:{game:{players:this.players.Where(function(e){return!e.left}).ToArray()},queue:this._broadcastActionsQueue}}),this._timeOutPeers=this.__serverPeersUpdateDelay)},e.prototype._updatePeersStats=function(e){this._timeOutPeersStats-=e,0<=this._timeOutPeersStats||(this._peers.getStats(),this._timeOutPeersStats=10)},e.prototype.update=function(e){var t=this;this._ready&&(this._peers.update(e),this.__queue.update(e),this._updateServerPeers(e),this._updatePeersStats(e),this.isServer&&(this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updateGameServer,this._serverActionsQueues,e),this._serverActionsQueues=[]),this.__serverUpdateTimeOut-=e,0<this.__serverUpdateTimeOut||(this.__serverUpdateTimeOut=this.__serverUpdateDelay,this.isServer?(this._peers.send({type:"updateGameAsync",data:{game:{players:[]},queue:this._broadcastActionsQueue}}),this._updateGameAsync({players:[],queue:this._broadcastActionsQueue},e>this.__serverUpdateDelay)):(this.setData&&(this.setData=!1,this._sendGameActionAsync({playerId:this._playerId,actionType:ActionType_1.ActionType.updateData,action:{data:this.data}})),this._playerActions&&0<this._playerActions.length&&(this._sendGameActionAsync({playerId:this._playerId,actionType:ActionType_1.ActionType.sendActions,action:{actions:this._playerActions}}),this._playerActions=[])),this.players.ForEach(function(e){t._playersPeersConnected[e.id]=!1})))},e.prototype._playerLeft=function(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return console.log("_playerLeft",r),this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.playerLeft,r.player),(t=this.players.FirstOrDefault(function(e){return e.id==r.player.id}))&&(t.left=!0,t.isServer=!1),r.player.isServer?(console.log("this._peers.destroy",this._playerId),this._peers.destroy(this._playerId)):this.isServer&&this._peers.destroy(t.id),[2]})})},e.prototype._createPeers=function(){return __awaiter(this,void 0,void 0,function(){var t,r,n,i;return __generator(this,function(e){switch(e.label){case 0:return this.__disableDirectConnections?[2]:[4,Utils_1.delay(2e3)];case 1:e.sent(),t=this.players.Where(function(e){return!e.left&&0==e.type}).Select(function(e){return e.id}).ToArray(),r=0,e.label=2;case 2:if(!(r<t.length))return[3,7];if(n=t[r],this.itIsMe(n))return[3,6];e.label=3;case 3:return e.trys.push([3,5,,6]),[4,this._createPeer(n)];case 4:return e.sent(),[3,6];case 5:return i=e.sent(),console.error(i),[3,6];case 6:return r++,[3,2];case 7:return[2]}})})},e.prototype._setServer=function(n){return __awaiter(this,void 0,void 0,function(){var t,r=this;return __generator(this,function(e){switch(e.label){case 0:return console.log("setServer",n),this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.setServer,n),this.isServer?this._peers.destroyAll():this._peers.destroy(this._playerId),(this.isServer=n)?(this.players.Where(function(e){return!r.itIsMe(e.id)}).ForEach(function(e){e.isServer=!1}),(t=this.players.FirstOrDefault(function(e){return e.id==r._playerId}))&&(t.isServer=n),[4,this._createPeers()]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},e.prototype._playerJoined=function(n,i){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return n!=this._playerId&&(t=this.players.FirstOrDefault(function(e){return e.id==n}))&&t.left&&(t.left=!1,this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.addPlayerOpponent,t),this._sendGameSignalAsync({playerId:t.id,signal:{type:"state",player:t}})),this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.playerJoin,n,i),this.isServer?(r=n,[4,this._createPeer(r)]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},e.prototype._gameSignal=function(i){return __awaiter(this,void 0,void 0,function(){var t,r,n=this;return __generator(this,function(e){return"peer"==i.signal.type?(this._playerServerId=i.signal.serverId,this._peers.signal(i.signal.peer,i.signal.data)):"create_peer"==i.signal.type?(t=i.signal.peer,this._peers.client(t),(r=this._peers.getPeer(t)).on("signal",function(t){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.delay(1e3)];case 1:return e.sent(),this._sendGameSignalAsync({playerId:this._playerServerId,signal:{type:"peer",playerId:this._playerId,data:t,peer:i.signal.peer}}),[2]}})})}),r.on("data",function(e){if("updateGameAsync"==e.type){var t=e.data;n._updateGame(t,!0)}})):"state"==i.signal.type&&this.trigger(MultiplayerEventsEnum_1.MultiplayerEventsEnum.setPlayerState,i.signal.player),[2]})})},Object.defineProperty(e.prototype,"playersPeersConnected",{get:function(){var e=[];for(var t in this._playersPeersConnected){this._playersPeersConnected[t]&&e.push(t)}return e},enumerable:!0,configurable:!0}),e.prototype._createPeer=function(t){return __awaiter(this,void 0,void 0,function(){var r,n=this;return __generator(this,function(e){switch(e.label){case 0:return this.__disableDirectConnections?[2]:t==this._playerId?[2]:(console.log("_createPeer",t),this._peers.server(t),r=this._peers.getPeer(t),[4,this._sendGameSignalAsync({playerId:t,signal:{type:"create_peer",playerId:this._playerId,peer:t,serverId:this._playerId}})]);case 1:return e.sent(),r.on("connect",function(e){}),r.on("close",function(e){}),r.on("signal",function(e){n._sendGameSignalAsync({playerId:t,signal:{type:"peer",playerId:n._playerId,data:e,peer:t,serverId:n._playerId}})}),r.on("data",function(e){if("sendGameActionAsync"==e.type){var t=e.data;n._gameAction(t)}n._playersPeersConnected[r.id]=!0}),[2]}})})},e.prototype.onStartMatch=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.startMatch,e)},e.prototype.onGameUpdate=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updateGame,e)},e.prototype.onGameServerUpdate=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updateGameServer,e)},e.prototype.onSetServer=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.setServer,e)},e.prototype.onPlayerJoin=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.playerJoin,e)},e.prototype.onPlayerLeft=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.playerLeft,e)},e.prototype.onUpdatePlayer=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.updatePlayer,e)},e.prototype.onError=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.onError,e)},e.prototype.onAddPlayer=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.addPlayer,e)},e.prototype.onAddPlayerOpponent=function(e){this._on(MultiplayerEventsEnum_1.MultiplayerEventsEnum.addPlayerOpponent,e)},e.prototype._on=function(e,t,r){this.__$eventListeners_=this.__$eventListeners_||{},this.__$eventListeners_[e]=this.__$eventListeners_[e]||[],this.__$eventListeners_[e].push({callback:t,context:r||this})},e.prototype.off=function(e,t){this.__$eventListeners_=this.__$eventListeners_||{};for(var r=this.__$eventListeners_[e]||[],n=0;n<r.length;n++)if(r[n].callback===t)return void r.splice(n,1)},e.prototype.trigger=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this.__$eventListeners_=this.__$eventListeners_||{};for(var n=this.__$eventListeners_[e]||[],i=0;i<n.length;i++)n[i].callback.apply(n[i].context,Array.prototype.slice.call(arguments,1))},e.prototype.delay=function(r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,new Promise(function(e,t){setTimeout(function(){e()},r)})]})})},e}(),MultiplayerClient=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype._sendGameActionAsync=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,void 0]})})},t.prototype._sendGameSignalAsync=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,void 0]})})},t.prototype._updateGameAsync=function(e,t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,void 0]})})},t.prototype.create=function(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,void 0]})})},t.prototype.start=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,void 0]})})},t.prototype.startMatch=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,void 0]})})},t}(MultiplayerClientBase);exports.MultiplayerClient=MultiplayerClient;