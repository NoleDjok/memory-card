"use strict";var __extends=this&&this.__extends||function(){var s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};return function(t,e){function n(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var MultiStyleText=function(s){function D(t,e){var n=s.call(this,t)||this;return n.styles=e,n}return __extends(D,s),Object.defineProperty(D.prototype,"styles",{set:function(t){for(var e in this.textStyles={},this.textStyles.default=this.assign({},D.DEFAULT_TAG_STYLE),t)"default"===e?this.assign(this.textStyles.default,t[e]):this.textStyles[e]=this.assign({},t[e]);this._style=new PIXI.TextStyle(this.textStyles.default),this.dirty=!0},enumerable:!0,configurable:!0}),D.prototype.setTagStyle=function(t,e){t in this.textStyles?this.assign(this.textStyles[t],e):this.textStyles[t]=this.assign({},e),this._style=new PIXI.TextStyle(this.textStyles.default),this.dirty=!0},D.prototype.deleteTagStyle=function(t){"default"===t?this.textStyles.default=this.assign({},D.DEFAULT_TAG_STYLE):delete this.textStyles[t],this._style=new PIXI.TextStyle(this.textStyles.default),this.dirty=!0},D.prototype._getTextDataPerLine=function(t){for(var e=[],n=Object.keys(this.textStyles).join("|"),s=new RegExp("</?("+n+")>","g"),i=[this.assign({},this.textStyles.default)],o=["default"],r=0;r<t.length;r++){for(var a=[],h=[],l=void 0;l=s.exec(t[r]);)h.push(l);if(0===h.length)a.push(this.createTextData(t[r],i[i.length-1],o[o.length-1]));else{for(var c=0,x=0;x<h.length;x++)h[x].index>c&&a.push(this.createTextData(t[r].substring(c,h[x].index),i[i.length-1],o[o.length-1])),"/"===h[x][0][1]?1<i.length&&(i.pop(),o.pop()):(i.push(this.assign({},i[i.length-1],this.textStyles[h[x][1]])),o.push(h[x][1])),c=h[x].index+h[x][0].length;c<t[r].length&&a.push(this.createTextData(t[r].substring(c),i[i.length-1],o[o.length-1]))}e.push(a)}return e},D.prototype.getFontString=function(t){return new PIXI.TextStyle(t).toFontString()},D.prototype.createTextData=function(t,e,n){return{text:t,style:e,width:0,height:0,fontProperties:void 0,tagName:n}},D.prototype.getDropShadowPadding=function(){var i=this,o=0,r=0;return Object.keys(this.textStyles).forEach(function(t){var e=i.textStyles[t],n=e.dropShadowDistance,s=e.dropShadowBlur;o=Math.max(o,n||0),r=Math.max(r,s||0)}),o+r},D.prototype.updateText=function(){var g=this;if(this.dirty){this.texture.baseTexture.resolution=this.resolution;var e=this.textStyles,t=this.text;this._style.wordWrap&&(t=this.wordWrap(this.text));for(var n=t.split(/(?:\r\n|\r|\n)/),s=this._getTextDataPerLine(n),i=[],o=[],r=[],a=0,h=0;h<n.length;h++){for(var l=0,c=0,x=0,d=0,u=0;u<s[h].length;u++){var p=s[h][u].style;this.context.font=this.getFontString(p),s[h][u].width=this.context.measureText(s[h][u].text).width,0===s[h][u].text.length&&(s[h][u].width+=(s[h][u].text.length-1)*p.letterSpacing,0<u&&(l+=p.letterSpacing/2),u<s[h].length-1&&(l+=p.letterSpacing/2)),l+=s[h][u].width,d=Math.max(d,s[h][u].style.width),s[h][u].fontProperties=PIXI.TextMetrics.measureFont(this.context.font),s[h][u].height=s[h][u].fontProperties.fontSize+s[h][u].style.strokeThickness,x="number"==typeof p.valign?(c=Math.min(c,p.valign-s[h][u].fontProperties.descent),Math.max(x,p.valign+s[h][u].fontProperties.ascent)):(c=Math.min(c,-s[h][u].fontProperties.descent),Math.max(x,s[h][u].fontProperties.ascent))}i[h]=l,o[h]=c,r[h]=x,a=Math.max(a,l,d)}var f=Object.keys(e).map(function(t){return e[t]}).reduce(function(t,e){return Math.max(t,e.strokeThickness||0)},0),y=this.getDropShadowPadding(),b=a+f+2*y,S=r.reduce(function(t,e){return t+e},0)-o.reduce(function(t,e){return t+e},0)+2*y;this.canvas.width=(b+this.context.lineWidth)*this.resolution,this.canvas.height=S*this.resolution,this.context.scale(this.resolution,this.resolution),this.context.textBaseline="alphabetic",this.context.lineJoin="round";var T=y,v=[];for(h=0;h<s.length;h++){var w=s[h],m=void 0;switch(this._style.align){case"left":m=y;break;case"center":m=y+(a-i[h])/2;break;case"right":m=y+a-i[h]}for(u=0;u<w.length;u++){var k=w[u],_=k.style,P=k.text,I=k.fontProperties,O=k.width,F=(k.height,k.tagName);m+=f/2;var A=f/2+T+I.ascent;switch(_.valign){case"top":break;case"baseline":A+=r[h]-I.ascent;break;case"middle":A+=(r[h]-o[h]-I.ascent-I.descent)/2;break;case"bottom":A+=r[h]-o[h]-I.ascent-I.descent;break;default:A+=r[h]-I.ascent-_.valign}if(0===_.letterSpacing)v.push({text:P,style:_,x:m,y:A,width:O,ascent:I.ascent,descent:I.descent,tagName:F}),m+=w[u].width;else{this.context.font=this.getFontString(w[u].style);for(var W=0;W<P.length;W++)(0<W||0<u)&&(m+=_.letterSpacing/2),v.push({text:P.charAt(W),style:_,x:m,y:A,width:O,ascent:I.ascent,descent:I.descent,tagName:F}),m+=this.context.measureText(P.charAt(W)).width,(W<P.length-1||u<w.length-1)&&(m+=_.letterSpacing/2)}m-=f/2}T+=r[h]-o[h]}this.context.save(),v.forEach(function(t){var e=t.style,n=t.text,s=t.x,i=t.y;if(e.dropShadow){g.context.font=g.getFontString(e);var o=e.dropShadowColor;"number"==typeof o&&(o=PIXI.utils.hex2string(o)),g.context.shadowColor=o,g.context.shadowBlur=e.dropShadowBlur,g.context.shadowOffsetX=Math.cos(e.dropShadowAngle)*e.dropShadowDistance*g.resolution,g.context.shadowOffsetY=Math.sin(e.dropShadowAngle)*e.dropShadowDistance*g.resolution,g.context.fillText(n,s,i)}}),this.context.restore(),v.forEach(function(t){var e=t.style,n=t.text,s=t.x,i=t.y,o=t.width,r=t.ascent,a=t.descent,h=t.tagName;g.context.font=g.getFontString(e);var l=e.stroke;"number"==typeof l&&(l=PIXI.utils.hex2string(l)),g.context.strokeStyle=l,g.context.lineWidth=e.strokeThickness;var c=e.fill;if("number"==typeof c)c=PIXI.utils.hex2string(c);else if(Array.isArray(c))for(var x=0;x<c.length;x++){var d=c[x];"number"==typeof d&&(c[x]=PIXI.utils.hex2string(d))}g.context.fillStyle=g._generateFillStyle(new PIXI.TextStyle(e),[n]),e.stroke&&e.strokeThickness&&g.context.strokeText(n,s,i),e.fill&&g.context.fillText(n,s,i),(void 0===e.debug?D.debugOptions.spans.enabled:e.debug)&&(g.context.lineWidth=1,D.debugOptions.spans.bounding&&(g.context.fillStyle=D.debugOptions.spans.bounding,g.context.strokeStyle=D.debugOptions.spans.bounding,g.context.beginPath(),g.context.rect(s,i-r,o,r+a),g.context.fill(),g.context.stroke(),g.context.stroke()),D.debugOptions.spans.baseline&&(g.context.strokeStyle=D.debugOptions.spans.baseline,g.context.beginPath(),g.context.moveTo(s,i),g.context.lineTo(s+o,i),g.context.closePath(),g.context.stroke()),D.debugOptions.spans.top&&(g.context.strokeStyle=D.debugOptions.spans.top,g.context.beginPath(),g.context.moveTo(s,i-r),g.context.lineTo(s+o,i-r),g.context.closePath(),g.context.stroke()),D.debugOptions.spans.bottom&&(g.context.strokeStyle=D.debugOptions.spans.bottom,g.context.beginPath(),g.context.moveTo(s,i+a),g.context.lineTo(s+o,i+a),g.context.closePath(),g.context.stroke()),D.debugOptions.spans.text&&(g.context.fillStyle="#ffffff",g.context.strokeStyle="#000000",g.context.lineWidth=2,g.context.font="8px monospace",g.context.strokeText(h,s,i-r+8),g.context.fillText(h,s,i-r+8),g.context.strokeText(o.toFixed(2)+"x"+(r+a).toFixed(2),s,i-r+16),g.context.fillText(o.toFixed(2)+"x"+(r+a).toFixed(2),s,i-r+16)))}),D.debugOptions.objects.enabled&&(D.debugOptions.objects.bounding&&(this.context.fillStyle=D.debugOptions.objects.bounding,this.context.beginPath(),this.context.rect(0,0,b,S),this.context.fill()),D.debugOptions.objects.text&&(this.context.fillStyle="#ffffff",this.context.strokeStyle="#000000",this.context.lineWidth=2,this.context.font="8px monospace",this.context.strokeText(b.toFixed(2)+"x"+S.toFixed(2),0,8,b),this.context.fillText(b.toFixed(2)+"x"+S.toFixed(2),0,8,b))),this.updateTexture()}},D.prototype.wordWrap=function(t){var e="",n=Object.keys(this.textStyles).join("|"),s=new RegExp("(</?("+n+")>)","g"),i=t.split("\n"),o=this._style.wordWrapWidth,r=[this.assign({},this.textStyles.default)];this.context.font=this.getFontString(this.textStyles.default);for(var a=0;a<i.length;a++){for(var h=o,l=i[a].split(" "),c=0;c<l.length;c++)for(var x=l[c].split(s),d=0;d<x.length;d++)if(s.test(x[d]))e+=x[d],"/"===x[d][1]?(d++,r.pop()):(d++,r.push(this.assign({},r[r.length-1],this.textStyles[x[d]]))),this.context.font=this.getFontString(r[r.length-1]);else{var g=this.context.measureText(x[d]).width;if(this._style.breakWords&&h<g){var u=x[d].split("");0<c&&0===d&&(e+=" ",h-=this.context.measureText(" ").width);for(var p=0;p<u.length;p++){var f=this.context.measureText(u[p]).width;h<f?(e+="\n"+u[p],h=o-f):(0<c&&0===d&&0===p&&(e+=" "),e+=u[p],h-=f)}}else if(this._style.breakWords)e+=x[d],h-=g;else{var y=g+(0===d?this.context.measureText(" ").width:0);0===c||h<y?(0<c&&(e+="\n"),e+=x[d],h=o-g):(h-=y,0===d&&(e+=" "),e+=x[d])}}a<i.length-1&&(e+="\n")}return e},D.prototype.updateTexture=function(){var t=this._texture,e=this.getDropShadowPadding();t.baseTexture.hasLoaded=!0,t.baseTexture.resolution=this.resolution,t.baseTexture.realWidth=this.canvas.width,t.baseTexture.realHeight=this.canvas.height,t.baseTexture.width=this.canvas.width/this.resolution,t.baseTexture.height=this.canvas.height/this.resolution,t.trim.width=t.frame.width=this.canvas.width/this.resolution,t.trim.height=t.frame.height=this.canvas.height/this.resolution,t.trim.x=-this._style.padding-e,t.trim.y=-this._style.padding-e,t.orig.width=t.frame.width-2*(this._style.padding+e),t.orig.height=t.frame.height-2*(this._style.padding+e),this._onTextureUpdate(),t.baseTexture.emit("update",t.baseTexture),this.dirty=!1},D.prototype.assign=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var s=0,i=e;s<i.length;s++){var o=i[s];for(var r in o)t[r]=o[r]}return t},D.DEFAULT_TAG_STYLE={align:"left",breakWords:!1,dropShadow:!1,dropShadowAngle:Math.PI/6,dropShadowBlur:0,dropShadowColor:"#000000",dropShadowDistance:5,fill:"black",fillGradientType:PIXI.TEXT_GRADIENT.LINEAR_VERTICAL,fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",letterSpacing:0,lineHeight:0,lineJoin:"miter",miterLimit:10,padding:0,stroke:"black",strokeThickness:0,textBaseline:"alphabetic",valign:"baseline",wordWrap:!1,wordWrapWidth:100,width:0},D.debugOptions={spans:{enabled:!1,baseline:"#44BB44",top:"#BB4444",bottom:"#4444BB",bounding:"rgba(255, 255, 255, 0.1)",text:!0},objects:{enabled:!1,bounding:"rgba(255, 255, 255, 0.05)",text:!0}},D}(PIXI.Text);exports.MultiStyleText=MultiStyleText;